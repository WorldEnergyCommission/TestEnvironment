# How to add a new whitelabel

#### General configs

1. Open `console/config.ts` and add the new whitelabel to all functions and enums in the code, make sure all referenced
   files are also checked into the repo.
1. Open `console/capacitor.config.ts` and add the new whitelabel to all functions in the code.

#### Android

2. Open `console/android/app/build.gradle` and add the new whitelabel under the **productFlavors** section.

#### iOS

3. Open the Xcode project in `console/ios` and go to the **TARGETS** section.
4. Right-click the target **App** and click **Duplicate**, then click enter and modify the new target with the new
   whitelabel name.
5. Then under **Product/Scheme/Manage Schemes...**, also rename the new scheme to the new whitelabel name in the same
   way.
6. Click the new whitelabel target and under **Build Settings/Packaging** change the **Info.plist File** entry to \*
   \*App/Info.plist\*\*.
7. Then under **Build Settings/User-Defined** change the **APP_NAME** entry to the desired app name (should match the
   Android name).
8. Then under **Build Settings/Packaging** change the **Product Bundle Identifier** entry to the desired app
   identifier (should match the Android bundle identifier).
9. Delete the new **App copy-Info.plist** file generated by Xcode.
10. In the `console/ios/App/Podfile` file add the new target by copying and renaming one of the other targets.

#### DNS & Hosting

11. Add entry in `console/main.go` to

```go
domains = []string{ ... }
```

12. Make sure all DNS entries used by the platform are correctly set and the IP addresses serve the expected web assets
    and APIs.

#### Workflow

13. Change the **matrix.flavor** arrays in the iOS and Android build workflow file to include new whitelabels (two
    arrays per file).

#### Assets

14. Add the app logo and splash screen files under `console/assets` and follow the naming convention.
    Files sizes & types:

- `assets/icon-only.(png|jpg)` must be at least **1024×1024px**
- `assets/icon-(foreground|background).(png|jpg)` must be at least **1024×1024px**
- `assets/splash[-dark].(png|jpg)` must be at least **2732×2732px**

15. To add new Android and iOS icons and splash screens, run the script `scripts/generate_app_assets.py` and pass the
    parameter **--whitelabel {whitelabel_name}**.
16. To use the new app icon in each iOS target, select the corresponding whitelabel target and change under
    **General/App Icons and Launch ScreenProduct** the **App Icon** setting to **{whitelabel_name}AppIcon**.
17. To use the new splash screen in each iOS target, create a new launch screen file under **File -> New -> File... ->
    Launch Screen**, leave everything set to default, just add this launch screen to the corresponding whitelabel target
    and save it as `console/ios/App/App/LaunchScreens/{whitelabel_name}LaunchScreen.storyboard` and close the opened
    file afterwards.
18. Then change the contents of the newly generated file by overwriting it with the contents
    of `console/ios/App/App/Base.lproj/LaunchScreen.storyboard`, but replace "Splash" with "{whitelabel_name}Splash".
19. Then change under **Build Settings/User-Defined** the **LAUNCH_SCREEN_NAME** setting to
    **{whitelabel_name}LaunchScreen.storyboard**.

#### Keepass & other configs

20. Then under `keepass/secrets.kdbx`, add the new realm under the
    path `efficientIO/cloud/{cluster_name}Cluster/realms/{realmName}`,
21. you can start by copying over another realm and changing the key values.
22. After that, execute **realm_ci_cd.yaml** in GitHub Actions.
23. Then under `keepass/secrets.kdbx`, add the new realm mail config under the
    path `efficientIO/cloud/{cluster_name}Cluster/environment/{clusterName}_SENDGRID_CONFIGS_BASE64`.

#### Publishing

24. Then in the `Google Play Console` and in `App Store Connect`/`Apple Developer` (add new application id and mobile
    provision file), add the new applications with the corresponding package identifiers.
25. Then under `keepass/secrets.kdbx`, add the new app deployment config under the
    path `efficientIO/app/{whitelabel_name}`.
26. For the Android workflow to run successfully, you must upload the first build manually (let the workflow run once
    and upload the output from the failed run)

#### Keycloak & E-Mails

27. Add and configure the corresponding Keycloak theme to the directory **keycloak/themes/{whitelabel_name}**
28. Write a Flyway script that inserts all the necessary **email templates** into the database. If you copy templates, make sure to edit the respective URLs, images and texts correctly. Currently these are:
    - Invite Template:
      These have to be in HTML format. `V18__project_invites.sql` contains examples.
      Statement to copy:
    ```sql
    insert into email_template values ('invite', '{realmName}', '{emailTemplate}')
    ```
