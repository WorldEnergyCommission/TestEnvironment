<?xml version="1.0" encoding="utf-8"?>
<TcPlcObject Version="1.1.0.1" ProductVersion="3.1.4024.13">
  <POU Name="prgScanUSI" Id="{7e3027f7-3e1b-4e0a-a3db-d3d437b9566d}" SpecialFunc="None">
    <Declaration><![CDATA[PROGRAM prgScanUSI
VAR
    usiAddress					: USINT;                   // Laufvariable für die Adresssuche (1 bis 247)
    arrFoundAddresses  			: ARRAY[1..247] OF USINT;  // Array zur Speicherung gefundener Adressen
    iFoundCount        			: UINT := 0;               // Zähler für gefundene Geräte
	fb_RTU_Master 				: FB_KL6xxx_ModbusRTU_22B_Master;
	fbModbusRtuMaster_KL6x22B	: ModbusRtuMaster_KL6x22B;
    bExecute          			: BOOL := FALSE;           // Steuerung des Modbus-Kommandos
    bBusy           			: BOOL;                    // Busy-Flag
    bError           			: BOOL;                    // Fehler-Flag
    iTimeout         			: TIME := T#500MS;         // Timeout für die Abfrage
    iReadValue       			: WORD;                    // Speicher für das gelesene Register (Dummy)
END_VAR
]]></Declaration>
    <Implementation>
      <ST><![CDATA[// Modbus-Schleife zur Adresssuche
FOR usiAddress := 1 TO 247 DO
    bExecute := TRUE;
    fbModbusRtuMaster_KL6x22B.ReadRegs(
        UnitID      := usiAddress,
        MBAddr      := 0,                  // Ab Adresse 0 (kann angepasst werden)
        Quantity    := 1,                  // Ein Register lesen
        cbLength    := SIZEOF(iReadValue),
        pMemoryAddr := ADR(iReadValue),
        Execute     := bExecute,
        Timeout     := iTimeout,
        BUSY        => bBusy,
        Error       => bError,
        ErrorId     => 
    );

    // Warten, bis Busy-Flag zurückgesetzt ist
    WHILE bBusy DO
        // Hier kann eine Wartezeit oder eine Watchdog-Überprüfung eingebaut werden
    END_WHILE

    IF NOT bError THEN
        // Adresse gefunden, speichern
        iFoundCount := iFoundCount + 1;
        arrFoundAddresses[iFoundCount] := usiAddress;
    END_IF

    bExecute := FALSE; // Kommando abschließen
END_FOR

// Nach der Schleife kann iFoundCount genutzt werden, um die Anzahl gefundener Geräte zu ermitteln.
// arrFoundAddresses enthält alle gefundenen Modbus-Adressen.]]></ST>
    </Implementation>
    <LineIds Name="prgScanUSI">
      <LineId Id="23" Count="30" />
      <LineId Id="9" Count="0" />
    </LineIds>
  </POU>
</TcPlcObject>