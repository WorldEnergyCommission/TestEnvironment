<?xml version="1.0" encoding="utf-8"?>
<TcPlcObject Version="1.1.0.1" ProductVersion="3.1.4024.11">
  <POU Name="FB_EMS_V2_T" Id="{e4c79efc-15a7-4cf0-8468-a5c0cd1f4ec9}" SpecialFunc="None">
    <Declaration><![CDATA[FUNCTION_BLOCK FB_EMS_V2_T
VAR_INPUT PERSISTENT
	bEnable										: BOOL;																								//{#lynus.ag#()} //Enable and dissable this function
	tDelayPwrCorrectionECS						: TIME := T#2.5S;																					//Delay for the Power Correction on each Electric Fuse Line for the charging stations
	stNrOfEM_IN_ECS								: ST_ECS_EM_NR_EMS;																					//Structure with all Electric Meter Numbers to limit the Electric Lines for the charging stations
	stSizeMainFuseCS							: ST_ECS_Main_Fuse_EMS;																				//{#lynus.ag#()} //Structure with all Sizes of the Fuses to limit the Electric Lines for the charging stations 
	stSetupEMS									: ST_Setup_EMS_V2 := (uiUpdateTime := 15);															//{#lynus.ag#()} //Setup EMS
	eOperationMode								: E_OperatingMode_EMS;																				//{#lynus.ag#()} //Operation Mode EMS
	eSpeedModeBackendController					: E_SpeedModeBackendController_EMS;																	//Speed for the Controller what discharge the Battery when the commands come from the Backend
	eSpeedModeLocalController					: E_SpeedModeLocalController_EMS;																	//Speed for the local Controller for charge and discharge the Battery
END_VAR
VAR_INPUT
	bActivateHP									: BOOL;																								//{#lynus.ag#()} //Activate the Heating pumps when the Backend deliver the signal. NOT OVERRIDE
	bControllingState							: BOOL;																								//{#lynus.ag#()} //The control state of the service is linked here. NOT OVERRIDE
	rHeartbeat									: REAL;																								//{#lynus.ag#()} //Heartbeat from the Service. NOT OVERRIDE
	rErrorWarning								: REAL;																								//{#lynus.ag#()} //Error or Warning from the Service. NOT OVERRIDE
	rEnergyOptReady								: REAL;																								//{#lynus.ag#()} //Energy Optimization Service Ready. NOT OVERRIDE
	rNewBattPower								: REAL;																								//{#lynus.ag#()} //New Battery Power from Backend Service. NOT OVERRIDE
END_VAR
VAR_OUTPUT
	eMessageEMS									: Lynus_Standards.E_Message_EMS;																	//EMS Message
	bStateEnable								: BOOL;																								//{#lynus.ag#()} //Show if the ems function is enabled or not
	bStateAllowChrgFromGrid						: BOOL;																								//{#lynus.ag#()} //Show the State if the charging from grid is allowed or not
	bMissingPowerData							: BOOL;																								//Missing data on the max power setup from one ore more devices
	bSurplusAvailable							: BOOL;																								//Variable that indicates if there is surplus or not
	bSEnableMainFuseFunc						: BOOL;																								//{#lynus.ag#()} //Show the State of the Main Fuse Function on Load management or Peak Shavign Mode
	byProgress									: BYTE;																								//Shows the Progress from the new Calculation when we have Surplus. When we have no Surplus and we discharge the batterys this Value is on 100
	uiState_OUT									: UINT;																								//Actual State
	diNrOfEMS_OUT								: DINT;																								//Active Number from the EMS Function for using on other functions
	arrMinPrioReached							: ARRAY[1..5] OF BOOL;																				//Shows if all different devices types are set to 0% with the target power ([1] = Battery, [2] = HP, [3] = EHE, [4] = OBC, [5] = ECS)
	arrMaxPrioReached							: ARRAY[1..5] OF BOOL;																				//Shows if all different devices types are set to 100% with the target power ([1] = Battery, [2] = HP, [3] = EHE, [4] = OBC, [5] = ECS)	
END_VAR	
VAR
	(*-----------------------------------------------------------------------Internal Variables and Functions for connection to the Backend--------------------------------------------------------------------------------*)
	fbPIDDischrgCmdFromBackend					: FB_PID;																							//PID Contrller what controll the discharging power from the Battery when the controlling from backend is activated
	timDissableFunctions						: TON;																								//Timer to dissable the Function after Lynus_Standards.Constants_General.tTimeDissableLynusFunctions Days without connection to the Lynus Cloud
	timResetConnectionOnGVL						: TON;																								//Timer to try reset the connection Flag on the GVL. (When somebody delete the Connection Function and make only a onlinechange)
	timHB										: TON;																								//Timer to check the Heartbeat from the Backendservice
	timPIDDischrgCmdFromBackend					: TON;																								//Timer to set the output from the pid controller to 0 due to internal control deviations (Backend Mode)
	timCorrectionSetpoint						: TOF;																								//Timer to make the correction on the Setpoint for Battery power. This is neccessary to give time to the inverter and Grid to adjust on the new values
	timErrorWarning								: TON;																								//Timer to enable the Function Backend Mode after a Error or Warning
	timEnergyOptReady							: TON;																								//Timer to enable the Function Backend Mode after the Backend Service is ready
	timControlingState							: TON;																								//Timer to enable the controlling over the Backend Mode
	timResetActivateHP							: TON;																								//Timer to reset the Activate HP Command from the Backend Service
	FPEnablePID									: R_TRIG;																							//Internal positive edge
	FPMakeCorrection							: R_TRIG;																							//Internal positive edge
	bDischrgCmdFromBackendOK					: BOOL;																								//Allowed to controll the Devices from Backend
	rHeartbeat_CP								: REAL;																								//Compare the Heartbeat from the Backend
	rControllerQPIDDischrgCmdFromBackend		: REAL;																								//Controller output from pid controll over Backend Mode
	rNewBattPower_CP							: REAL;																								//New Battery power to ckeck if we have received a new Value in kW
	lrActualPowerBatterys						: LREAL;																							//Actual Power from the Batterys in kW
	lrErrorPIDCorrectionDischrgCmdFromBackend	: LREAL;																							//Limit the Error on the pid controller for discahrge the battery on the controll over Backend Mode
	lrNewBatteryPowerWithCorrection				: LREAL;																							//The New Battery power from the Backend with correction that we dont insert power in the Grid
	liLPDischrgCmdFromBackend					: LINT;																								//Loop to send the command from Backend to the Devices
	(*-----------------------------------------------------------------------------------Rest of internal Variabels and Functions---------------------------------------------------------------------------------------*)
	fbMessagesEMS								: FB_EMS_Message;																					//FB to create the Messages for this Function
	fbNumberDevice								: FB_NumberOfDevice;																				//Function block to calcualte the number of the Device
	fbTaskIndex									: GETCURTASKINDEX;																					//Function to read out the Task Index in witch the function is running
	fbPIDBatterySC								: FB_PID;																							//PID Controller to discharge the battery in the self consumption mode
	fbPIDBatteryEPO								: FB_PID;																							//PID Controller to discharge the battery in the emergency power mode
	fbPIDBatteryPLCLM_Dischrg					: FB_PID;																							//PID Controller to Dischage the battery on load management mode and peak shaving mode
	fbPIDBatteryPLCLM_Chrg						: FB_PID;																							//PID Controller to Charge the battery on load management mode and peak shaving mode
	timCalculateNewPowerValue					: TON;																								//Timer to start a new session to calculate the new power value for the devices
	timPIDSC									: TON;																								//Timer to set the output from the pid controller to 0 due to internal control deviations (Self consumption mode)
	timPIDEPO									: TON;																								//Timer to set the output from the pid controller to 0 due to internal control deviations (Emergency power mode)
	timCorrectionECS							: TON;																								//Timer for make the correction for ECS in the Load management and peak capping mode with use the separate fuse
	timErrorGridMessurement						: TON;																								//Timer with delay to stop the EMS Function if we have a error on the Grid messurement
	timTimeout									: TON;																								//Timer for Timout
	timCutPeaks									: TOF;																								//Timer to cut peaks on the grid. The system waits for this time for strong and short peaks before regulating.
	timDelayStart								: TOF;																								//Timer with the delay to start the ems function after a online change
	FPEPO										: R_TRIG;																							//Internal positive edge
	FNEPO										: F_TRIG;																							//Internal negative edge
	eOperationModeEMS_CP						: E_OperatingMode_EMS;																				//Operation Mode EMS/Battery to compare with the original variable
	stNrOfEM_IN_ECS_CP							: ST_ECS_EM_NR_EMS;																					//Structure of EM for charging stations to compare it for changes with originale Input Strucutre
	stSizeMainFuseCS_CP							: ST_ECS_Main_Fuse_EMS;																				//Structure of Fuse Size for charging stations Lines to compare it for changes with originale Input Strucutre
	arrPD										: ARRAY[1..70] OF FB_PersistentData_Number;															//Function to save persistent data
	arrTimBatterysAreFull						: ARRAY[1..Constants_Energy.diMaxNumberOfBatteryInverters] OF TON;									//Timer start for each Battery when is full
	arrResetDisableECS							: ARRAY[1..30] OF TON;																				//Timer to dissable the ECS when the Electric Meter for the Electric Fuse Line has a Error
	arrActualStepInTurn_CP						: ARRAY[1..2] OF BYTE;																				//Actual Step in turn to compare with original variable
	arrActualPrioInTurn							: ARRAY[1..5] OF BYTE;																				//Actual Priority (1-255) that is currently in turn ([1] = Battery, [2] = HP, [3] = EHE, [4] = OBC, [5] = ECS)
	arrActualStepInTurn							: ARRAY[1..2] OF BYTE;																				//Actual Step (1-10) from step switched devices that is currently in turn ([1] = HP, [2] = EHE)
	arrLPPrioZeroSetToZeroP						: ARRAY[1..5] OF LINT;																				//Array with loop to set each device with priority 0 to the target power value 
	arrCTCheckActivePrio						: ARRAY[1..5] OF LINT;																				//Array with loop to check the actual prioritys
	arrNrOfEM_IN_ECS							: ARRAY[1..30] OF DINT;																				//Array with the numbers the Electric meters for the Fuse Line to limit the Electric charging stations
	arrSizeMainFuseCS							: ARRAY[1..30] OF REAL;																				//Array with the Size from the Fuse of eacah Fuse line with Unit kW
	arrEMECS_State								: ARRAY[1..30] OF BYTE;																				//Array with the State from the Electric Meters to limit the Fuse Line for electric charging stations. 0 = None, 1= Enable, 2 = Not Enabled
	arrEMECS_ErrorWarning						: ARRAY[1..30] OF BYTE;																				//Array with the Error or Warnings from the Electric Meters to limit the Fuse Line for electric charging stations 
	arrEMECS_Power								: ARRAY[1..30] OF LREAL;																			//Array with the Power in kW from the Electric Meters to limit the Fuse Line for electric charging stations 
	arrNoPowerForECS							: ARRAY[0..30] OF BOOL;																				//Array what shows that we dont can give more power on the ECS because we have to much power on the Fuse line on wich the ECS is connected
	bEPMActive									: BOOL;																								//Emergency power mode is active
	bChargePrioBatterysOnEPO					: BOOL;																								//Load batterys that made a island grid first to the adjustable SOC before start with al other devices
	bStepWasOn100								: BOOL;																								//Its true when the actual step from step switched devices was on 100%
	bECSPrio255									: BOOL;																								//True when we reached the max prio of the charging stations
	bStopAll									: BOOL;																								//Stop the EMS when we some is happend what make trouble
	bErrorOnGridMessurement						: BOOL;																								//Shows if on the Grid Messurement is a error and stop then the EMS Function
	bySmGrActiveCommonPrio_CP					: BYTE;																								//Smalest or greatest active common priority of the devices to compare with the original varible
	byLPSmActiveCommonPrio						: BYTE;																								//Loop to check the smalest active common priority
	bySmGrActiveCommonPrio						: BYTE;																								//Smalest or greatest active common priority of the devices
	bySearchBigestPrio							: BYTE;																								//Search the biggest Prio for each device in the Steps in what we choose the prio
	byLPDataEMECS								: BYTE;																								//Variable for a Loop for logic on the Limitation Part for the chargin staion Fuse Line Part
	byCounterActiveFuseLineToDissableECS		: BYTE;																								//Counter to dissalbe the charging stations when its neccessary what are connected on this eletctric Fuse Line
	byCounterActiveFuseLineToControllECS		: BYTE;																								//Counter to controll the charging stations when its neccessary what are connected on this eletctric Fuse Line
	uiState										: UINT;																								//Actual State
	uiState_CP									: UINT;																								//Actual State to compare for activating the timout timer
	diNumberOfDevicesFromEachType				: DINT;																								//Count the Number of each Device what has a priority <> 0
	diMemCmpOperationState						: DINT;																								//Variable to compare the operation state			
	diNumberOfActiveBatterys					: DINT;																								//Number of active batterys
	diNumberOfBatteryInverterInEPO				: DINT;																								//Number of battery inverters that work in Emergency Power operation 
	diNumberOfECS								: DINT;																								//Number of total charging stations on what the power must reduced with the max fuse power
	diBiggestNumberOfDeviceConstants			: DINT;																								//Biggest Number of the constants for the several device types. Needs to calcualte the delay for the timout timer
	dwSumSOC									: DWORD;																							//Sum of the SOC from all batterys
	dwSumSOCInEPO								: DWORD;																							//Sum of the SOC from all batterys that make a island mode at the moment
	dwAvarageBatterySOC							: DWORD;																							//Actual avarage Battery SOC from each Battery
	dwAvarageBatterySOCInEPO					: DWORD;																							//Actual avarage Battery SOC from each Battery that make a island mode at the moment
	udiCounterOnlineChange_CP					: UDINT;																							//Counter for online change to comapre it	
	udiCycleTime								: UDINT;																							//Cycle time in wich the function is running. Needs to calculate the delay for the timout timer
	rValuePercentToControllableDevices			: REAL;																								//Percent value to set the target power to controllable devices
	rValuePercentToStepSwitchedDevices			: REAL;																								//Percent value to set the target power to on/off or step switched devices
	rControllerQPIDSC							: REAL;																								//Controller output from pid self consumption
	rControllerQPIDEPO							: REAL;																								//Controller output from pid emergency power operation
	lrTargetPowerCorrectionECS					: LREAL;																							//New Target power for chargign station after correction with max fuse power
	lrPowerDiffFuseECS							: LREAL;																							//Power difference between max fuse power charging station and actual power for all charging stations 
	lrPowerForCalculateECS						: LREAL;																							//Power to calcualte the % for each charging station
	lrGridPower									: LREAL;																							//Grid power in kW
	lrGridPower_CP								: LREAL;																							//Grid power in kW to compare for correction when the backend is controlling the battery
	lrSizeBatteryPowerInEPO						: LREAL;																							//Power in kW of all Battery inverters that are made a island mode at the moment
	lrSizeGridConnection						: LREAL;																							//Size of the complete grid connection
	lrActualSurplusOrConsumption				: LREAL;																							//Actual surplus or consumption in kW
	lrActualSurplusOrConsumptionOld				: LREAL;																							//Old value from last step with surplus or consumption in kW
	lrMaxPowerDevicesWithActualPrio				: LREAL;																							//Actual complete max power from all devices with the same priority
	lrErrorPIDCorrectionBattSC					: LREAL;																							//Limit the Error on the pid controller for discahrge the battery on the self consumption mode
	lrErrorPIDCorrectionBattEPO					: LREAL;																							//Limit the Error on the pid controller for discahrge the battery on the emergency power operation mode
	lrErrorPIDCorrectionBattPLCLM_Dischrg		: LREAL;																							//Limit the Error on the pid controller for discahrge the battery on the load management mode and peak shaving mode
	lrErrorPIDCorrectionBattPLCLM_Chrg			: LREAL;																							//Limit the Error on the pid controller for charge the battery on the load management mode and peak shaving mode
	liCounterCkeckDeviceAndPrio					: LINT;																								//Counter to ckeck the device and Prio in the Steps for HP and EHE. Here we didn't can use a loop regarding performance problems on small PLC
	liNrOfNotDoneDevices						: LINT;																								//Shows the Numer of Devices what are not controlled with the minimum or the maximum power when we have a actual Prio from 1 or 255. That we can set the min reached or max reached Flag
	liLPCheckDeviceAndPrio						: LINT;																								//Loop to ckeck the Number of Devices and the Prio
	liLPGridData								: LINT;																								//Loop to check some grid data
	liLPActualSurplusOrConsumption				: LINT;																								//Loop to check actual surplus or consumption
	liLPBatterysSetupData						: LINT;																								//Loop to copy the setup data from the battery inverters
	liLPBatteryData								: LINT;																								//Loop to check some data from batterys
	liLPSumSOCInEPO								: LINT;																								//Loop to calculate the sum of the SOC from all batterys that buils a island mode at the moment
	liLPInEPO									: LINT;																								//Loop to check if 1 or more battery inverters build a island grid
	liLPCheckMaxPower							: LINT;																								//Loop to ckeck the max power from each device
	liLPSetPercentPower							: LINT;																								//Loop to set the calculatet percetn power to the device
	liLPCorrectionPowerCS						: LINT;																								//Loop to make a correction on the target power from the charging stations in dependence of the max fuse power 
	liLPDataBatteryInverter						: LINT;																								//Loop to check or set data from battery inverters
END_VAR]]></Declaration>
    <Implementation>
      <ST><![CDATA[//Creator : Kai Ebensperger
//Company : Lynus AG
//Date : 29.05.2021
//Version : 2.0.0.0

//With this FB the EMS control can be realized on the PLC. 
//This divides the excess energy among the devices according to priority
//Devices with priority 0 received as target power 0
//If we have less or no surplus, then the target power will be reduced or remains on the same value
//The EMS function can handle batterie devices, controllable devices, On/Off devices and step switched devices. 
//If we have no surplus, and all devices has a target power from 0, then the battery try to balancing the consumption.
//This depends what operation mode is active
//If the mode load managemant is active, for the charging station the max power from the Main fuse is neccessary if bEnableMainFuseFunction from the Setup is set, because the ems dont can use all the power from the max. grid power for the charging stations.
//This EMS can handle a maximum of 30 different Fuse Lines to limit the Electric Chargign stations in the load managemant Mode and Peak Shaving Mode    
//When a Batteryinverter or Batterysystem is in Island mode, then ems send to this system automatic -100%. The rest must be regulate the function from the batteryinverter. 
//All other battery inverters or battery systems that do not do islanding are treated by the EMS as normal devices with their priorities.
//This EMS can handle 5 device types (Battery, Heating Pump, Electric heating element, Electric charging station and other big consumers)
//This Function receive also Data from a Backend System. In this Backend System runs different ML-Models.
//So its possible that the Backend System controlls the Heating Pumps when its neccessary and also the discharging from the Batterys.
//This make sense when we have bad wheater, less PV-power in the next 24h to switch on the Heating Pumps or cover the consumption.......
//This EMS Function work only with our Backend Communication Library. After 11 Days no communication to our Backend system or no received new HB the Function dissable automatically and set a Message for this at the output
//When we receiven no HB, no Backend Service Ready Flag or an Error from the Backend Service then the Controlling over the Backend is dissabled and the EMS Function run in his "normal" Mode.

//NOTE for diNr.....Designation => 
//_IN = Here Data come in from other Functions or go out to other functions about the GVL
//_OUT = Here Data go out to other functions about the GVL

(*------------------------------------------------------------Limits----------------------------------------------------------------------------------*)

//EM ECS
stNrOfEM_IN_ECS.diNrOfLine1 := LIMIT(0,stNrOfEM_IN_ECS.diNrOfLine1,Constants_Energy.diMaxNumberOfElectricMeters);
stNrOfEM_IN_ECS.diNrOfLine2 := LIMIT(0,stNrOfEM_IN_ECS.diNrOfLine2,Constants_Energy.diMaxNumberOfElectricMeters);
stNrOfEM_IN_ECS.diNrOfLine3 := LIMIT(0,stNrOfEM_IN_ECS.diNrOfLine3,Constants_Energy.diMaxNumberOfElectricMeters);
stNrOfEM_IN_ECS.diNrOfLine4 := LIMIT(0,stNrOfEM_IN_ECS.diNrOfLine4,Constants_Energy.diMaxNumberOfElectricMeters);
stNrOfEM_IN_ECS.diNrOfLine5 := LIMIT(0,stNrOfEM_IN_ECS.diNrOfLine5,Constants_Energy.diMaxNumberOfElectricMeters);
stNrOfEM_IN_ECS.diNrOfLine6 := LIMIT(0,stNrOfEM_IN_ECS.diNrOfLine6,Constants_Energy.diMaxNumberOfElectricMeters);
stNrOfEM_IN_ECS.diNrOfLine7 := LIMIT(0,stNrOfEM_IN_ECS.diNrOfLine7,Constants_Energy.diMaxNumberOfElectricMeters);
stNrOfEM_IN_ECS.diNrOfLine8 := LIMIT(0,stNrOfEM_IN_ECS.diNrOfLine8,Constants_Energy.diMaxNumberOfElectricMeters);
stNrOfEM_IN_ECS.diNrOfLine9 := LIMIT(0,stNrOfEM_IN_ECS.diNrOfLine9,Constants_Energy.diMaxNumberOfElectricMeters);
stNrOfEM_IN_ECS.diNrOfLine10 := LIMIT(0,stNrOfEM_IN_ECS.diNrOfLine10,Constants_Energy.diMaxNumberOfElectricMeters);
	stNrOfEM_IN_ECS.diNrOfLine11 := LIMIT(0,stNrOfEM_IN_ECS.diNrOfLine11,Constants_Energy.diMaxNumberOfElectricMeters);
	stNrOfEM_IN_ECS.diNrOfLine12 := LIMIT(0,stNrOfEM_IN_ECS.diNrOfLine12,Constants_Energy.diMaxNumberOfElectricMeters);
	stNrOfEM_IN_ECS.diNrOfLine13 := LIMIT(0,stNrOfEM_IN_ECS.diNrOfLine13,Constants_Energy.diMaxNumberOfElectricMeters);
	stNrOfEM_IN_ECS.diNrOfLine14 := LIMIT(0,stNrOfEM_IN_ECS.diNrOfLine14,Constants_Energy.diMaxNumberOfElectricMeters);
	stNrOfEM_IN_ECS.diNrOfLine15 := LIMIT(0,stNrOfEM_IN_ECS.diNrOfLine15,Constants_Energy.diMaxNumberOfElectricMeters);
	stNrOfEM_IN_ECS.diNrOfLine16 := LIMIT(0,stNrOfEM_IN_ECS.diNrOfLine16,Constants_Energy.diMaxNumberOfElectricMeters);
	stNrOfEM_IN_ECS.diNrOfLine17 := LIMIT(0,stNrOfEM_IN_ECS.diNrOfLine17,Constants_Energy.diMaxNumberOfElectricMeters);
	stNrOfEM_IN_ECS.diNrOfLine18 := LIMIT(0,stNrOfEM_IN_ECS.diNrOfLine18,Constants_Energy.diMaxNumberOfElectricMeters);
	stNrOfEM_IN_ECS.diNrOfLine19 := LIMIT(0,stNrOfEM_IN_ECS.diNrOfLine19,Constants_Energy.diMaxNumberOfElectricMeters);
	stNrOfEM_IN_ECS.diNrOfLine20 := LIMIT(0,stNrOfEM_IN_ECS.diNrOfLine20,Constants_Energy.diMaxNumberOfElectricMeters);
stNrOfEM_IN_ECS.diNrOfLine21 := LIMIT(0,stNrOfEM_IN_ECS.diNrOfLine21,Constants_Energy.diMaxNumberOfElectricMeters);
stNrOfEM_IN_ECS.diNrOfLine22 := LIMIT(0,stNrOfEM_IN_ECS.diNrOfLine22,Constants_Energy.diMaxNumberOfElectricMeters);
stNrOfEM_IN_ECS.diNrOfLine23 := LIMIT(0,stNrOfEM_IN_ECS.diNrOfLine23,Constants_Energy.diMaxNumberOfElectricMeters);
stNrOfEM_IN_ECS.diNrOfLine24 := LIMIT(0,stNrOfEM_IN_ECS.diNrOfLine24,Constants_Energy.diMaxNumberOfElectricMeters);
stNrOfEM_IN_ECS.diNrOfLine25 := LIMIT(0,stNrOfEM_IN_ECS.diNrOfLine25,Constants_Energy.diMaxNumberOfElectricMeters);
stNrOfEM_IN_ECS.diNrOfLine26 := LIMIT(0,stNrOfEM_IN_ECS.diNrOfLine26,Constants_Energy.diMaxNumberOfElectricMeters);
stNrOfEM_IN_ECS.diNrOfLine27 := LIMIT(0,stNrOfEM_IN_ECS.diNrOfLine27,Constants_Energy.diMaxNumberOfElectricMeters);
stNrOfEM_IN_ECS.diNrOfLine28 := LIMIT(0,stNrOfEM_IN_ECS.diNrOfLine28,Constants_Energy.diMaxNumberOfElectricMeters);
stNrOfEM_IN_ECS.diNrOfLine29 := LIMIT(0,stNrOfEM_IN_ECS.diNrOfLine29,Constants_Energy.diMaxNumberOfElectricMeters);
stNrOfEM_IN_ECS.diNrOfLine30 := LIMIT(0,stNrOfEM_IN_ECS.diNrOfLine30,Constants_Energy.diMaxNumberOfElectricMeters);

//Main Fuse for Charging stations
stSizeMainFuseCS.rElSizeLine1 := LIMIT(0,stSizeMainFuseCS.rElSizeLine1,500);
stSizeMainFuseCS.rElSizeLine2 := LIMIT(0,stSizeMainFuseCS.rElSizeLine2,500);
stSizeMainFuseCS.rElSizeLine3 := LIMIT(0,stSizeMainFuseCS.rElSizeLine3,500);
stSizeMainFuseCS.rElSizeLine4 := LIMIT(0,stSizeMainFuseCS.rElSizeLine4,500);
stSizeMainFuseCS.rElSizeLine5 := LIMIT(0,stSizeMainFuseCS.rElSizeLine5,500);
stSizeMainFuseCS.rElSizeLine6 := LIMIT(0,stSizeMainFuseCS.rElSizeLine6,500);
stSizeMainFuseCS.rElSizeLine7 := LIMIT(0,stSizeMainFuseCS.rElSizeLine7,500);
stSizeMainFuseCS.rElSizeLine8 := LIMIT(0,stSizeMainFuseCS.rElSizeLine8,500);
stSizeMainFuseCS.rElSizeLine9 := LIMIT(0,stSizeMainFuseCS.rElSizeLine9,500);
stSizeMainFuseCS.rElSizeLine10 := LIMIT(0,stSizeMainFuseCS.rElSizeLine10,500);
	stSizeMainFuseCS.rElSizeLine11 := LIMIT(0,stSizeMainFuseCS.rElSizeLine11,500);
	stSizeMainFuseCS.rElSizeLine12 := LIMIT(0,stSizeMainFuseCS.rElSizeLine12,500);
	stSizeMainFuseCS.rElSizeLine13 := LIMIT(0,stSizeMainFuseCS.rElSizeLine13,500);
	stSizeMainFuseCS.rElSizeLine14 := LIMIT(0,stSizeMainFuseCS.rElSizeLine14,500);
	stSizeMainFuseCS.rElSizeLine15 := LIMIT(0,stSizeMainFuseCS.rElSizeLine15,500);
	stSizeMainFuseCS.rElSizeLine16 := LIMIT(0,stSizeMainFuseCS.rElSizeLine16,500);
	stSizeMainFuseCS.rElSizeLine17 := LIMIT(0,stSizeMainFuseCS.rElSizeLine17,500);
	stSizeMainFuseCS.rElSizeLine18 := LIMIT(0,stSizeMainFuseCS.rElSizeLine18,500);
	stSizeMainFuseCS.rElSizeLine19 := LIMIT(0,stSizeMainFuseCS.rElSizeLine19,500);
	stSizeMainFuseCS.rElSizeLine20 := LIMIT(0,stSizeMainFuseCS.rElSizeLine20,500);
stSizeMainFuseCS.rElSizeLine21 := LIMIT(0,stSizeMainFuseCS.rElSizeLine21,500);
stSizeMainFuseCS.rElSizeLine22 := LIMIT(0,stSizeMainFuseCS.rElSizeLine22,500);
stSizeMainFuseCS.rElSizeLine23 := LIMIT(0,stSizeMainFuseCS.rElSizeLine23,500);
stSizeMainFuseCS.rElSizeLine24 := LIMIT(0,stSizeMainFuseCS.rElSizeLine24,500);
stSizeMainFuseCS.rElSizeLine25 := LIMIT(0,stSizeMainFuseCS.rElSizeLine25,500);
stSizeMainFuseCS.rElSizeLine26 := LIMIT(0,stSizeMainFuseCS.rElSizeLine26,500);
stSizeMainFuseCS.rElSizeLine27 := LIMIT(0,stSizeMainFuseCS.rElSizeLine27,500);
stSizeMainFuseCS.rElSizeLine28 := LIMIT(0,stSizeMainFuseCS.rElSizeLine28,500);
stSizeMainFuseCS.rElSizeLine29 := LIMIT(0,stSizeMainFuseCS.rElSizeLine29,500);
stSizeMainFuseCS.rElSizeLine30 := LIMIT(0,stSizeMainFuseCS.rElSizeLine30,500);
	
//Other 
stSetupEMS.uiUpdateTime := LIMIT(1,stSetupEMS.uiUpdateTime,600);
	stSetupEMS.byResChrgGridToBatt := LIMIT(0,stSetupEMS.byResChrgGridToBatt,100);
		rHeartbeat := LIMIT(0,rHeartbeat,1);
			rErrorWarning := LIMIT(0,rErrorWarning,2);
				rEnergyOptReady := LIMIT(0,rEnergyOptReady,1);
					rNewBattPower := LIMIT(0,rNewBattPower,100000);		
						tDelayPwrCorrectionECS := LIMIT(T#2S,tDelayPwrCorrectionECS,T#10S);		

//Limit Commas							
stSizeMainFuseCS.rElSizeLine1 := DINT_TO_REAL(REAL_TO_DINT(stSizeMainFuseCS.rElSizeLine1 * 10)) / 10;
stSizeMainFuseCS.rElSizeLine2 := DINT_TO_REAL(REAL_TO_DINT(stSizeMainFuseCS.rElSizeLine2 * 10)) / 10;
stSizeMainFuseCS.rElSizeLine3 := DINT_TO_REAL(REAL_TO_DINT(stSizeMainFuseCS.rElSizeLine3 * 10)) / 10;
stSizeMainFuseCS.rElSizeLine4 := DINT_TO_REAL(REAL_TO_DINT(stSizeMainFuseCS.rElSizeLine4 * 10)) / 10;
stSizeMainFuseCS.rElSizeLine5 := DINT_TO_REAL(REAL_TO_DINT(stSizeMainFuseCS.rElSizeLine5 * 10)) / 10;
stSizeMainFuseCS.rElSizeLine6 := DINT_TO_REAL(REAL_TO_DINT(stSizeMainFuseCS.rElSizeLine6 * 10)) / 10;
stSizeMainFuseCS.rElSizeLine7 := DINT_TO_REAL(REAL_TO_DINT(stSizeMainFuseCS.rElSizeLine7 * 10)) / 10;
stSizeMainFuseCS.rElSizeLine8 := DINT_TO_REAL(REAL_TO_DINT(stSizeMainFuseCS.rElSizeLine8 * 10)) / 10;
stSizeMainFuseCS.rElSizeLine9 := DINT_TO_REAL(REAL_TO_DINT(stSizeMainFuseCS.rElSizeLine9 * 10)) / 10;
stSizeMainFuseCS.rElSizeLine10 := DINT_TO_REAL(REAL_TO_DINT(stSizeMainFuseCS.rElSizeLine10 * 10)) / 10;
	stSizeMainFuseCS.rElSizeLine11 := DINT_TO_REAL(REAL_TO_DINT(stSizeMainFuseCS.rElSizeLine11 * 10)) / 10;
	stSizeMainFuseCS.rElSizeLine12 := DINT_TO_REAL(REAL_TO_DINT(stSizeMainFuseCS.rElSizeLine12 * 10)) / 10;
	stSizeMainFuseCS.rElSizeLine13 := DINT_TO_REAL(REAL_TO_DINT(stSizeMainFuseCS.rElSizeLine13 * 10)) / 10;
	stSizeMainFuseCS.rElSizeLine14 := DINT_TO_REAL(REAL_TO_DINT(stSizeMainFuseCS.rElSizeLine14 * 10)) / 10;
	stSizeMainFuseCS.rElSizeLine15 := DINT_TO_REAL(REAL_TO_DINT(stSizeMainFuseCS.rElSizeLine15 * 10)) / 10;
	stSizeMainFuseCS.rElSizeLine16 := DINT_TO_REAL(REAL_TO_DINT(stSizeMainFuseCS.rElSizeLine16 * 10)) / 10;
	stSizeMainFuseCS.rElSizeLine17 := DINT_TO_REAL(REAL_TO_DINT(stSizeMainFuseCS.rElSizeLine17 * 10)) / 10;
	stSizeMainFuseCS.rElSizeLine18 := DINT_TO_REAL(REAL_TO_DINT(stSizeMainFuseCS.rElSizeLine18 * 10)) / 10;
	stSizeMainFuseCS.rElSizeLine19 := DINT_TO_REAL(REAL_TO_DINT(stSizeMainFuseCS.rElSizeLine19 * 10)) / 10;
	stSizeMainFuseCS.rElSizeLine20 := DINT_TO_REAL(REAL_TO_DINT(stSizeMainFuseCS.rElSizeLine20 * 10)) / 10;
stSizeMainFuseCS.rElSizeLine21 := DINT_TO_REAL(REAL_TO_DINT(stSizeMainFuseCS.rElSizeLine21 * 10)) / 10;
stSizeMainFuseCS.rElSizeLine22 := DINT_TO_REAL(REAL_TO_DINT(stSizeMainFuseCS.rElSizeLine22 * 10)) / 10;
stSizeMainFuseCS.rElSizeLine23 := DINT_TO_REAL(REAL_TO_DINT(stSizeMainFuseCS.rElSizeLine23 * 10)) / 10;
stSizeMainFuseCS.rElSizeLine24 := DINT_TO_REAL(REAL_TO_DINT(stSizeMainFuseCS.rElSizeLine24 * 10)) / 10;
stSizeMainFuseCS.rElSizeLine25 := DINT_TO_REAL(REAL_TO_DINT(stSizeMainFuseCS.rElSizeLine25 * 10)) / 10;
stSizeMainFuseCS.rElSizeLine26 := DINT_TO_REAL(REAL_TO_DINT(stSizeMainFuseCS.rElSizeLine26 * 10)) / 10;
stSizeMainFuseCS.rElSizeLine27 := DINT_TO_REAL(REAL_TO_DINT(stSizeMainFuseCS.rElSizeLine27 * 10)) / 10;
stSizeMainFuseCS.rElSizeLine28 := DINT_TO_REAL(REAL_TO_DINT(stSizeMainFuseCS.rElSizeLine28 * 10)) / 10;
stSizeMainFuseCS.rElSizeLine29 := DINT_TO_REAL(REAL_TO_DINT(stSizeMainFuseCS.rElSizeLine29 * 10)) / 10;
stSizeMainFuseCS.rElSizeLine30 := DINT_TO_REAL(REAL_TO_DINT(stSizeMainFuseCS.rElSizeLine30 * 10)) / 10;
		
IF stSetupEMS.byMaxDepthOfDischrgEPO > stSetupEMS.byReserveSOCEPO THEN stSetupEMS.byReserveSOCEPO := stSetupEMS.byMaxDepthOfDischrgEPO + 1; END_IF
	IF stSetupEMS.byMaxDepthOfDischrgEPO > stSetupEMS.byPrioChrgBattSOCInEPO THEN stSetupEMS.byPrioChrgBattSOCInEPO := stSetupEMS.byMaxDepthOfDischrgEPO + 1; END_IF
		IF stSetupEMS.byReserveSOCEPO > stSetupEMS.byPrioChrgBattSOCInEPO THEN stSetupEMS.byPrioChrgBattSOCInEPO := stSetupEMS.byReserveSOCEPO + 1; END_IF
		
stSetupEMS.byMaxDepthOfDischrgEPO := LIMIT(0,stSetupEMS.byMaxDepthOfDischrgEPO,100);
	stSetupEMS.byReserveSOCEPO := LIMIT(0,stSetupEMS.byReserveSOCEPO,100);
		stSetupEMS.byPrioChrgBattSOCInEPO := LIMIT(20,stSetupEMS.byPrioChrgBattSOCInEPO,75);

(*-------------------------------------------------------------Calcualte the number of EMS---------------------------------------------------------------*)

//Online change
timDelayStart(IN:= udiCounterOnlineChange_CP <> TwinCAT_SystemInfoVarList._AppInfo.OnlineChangeCnt, PT:= T#15S, Q=> , ET=> );

fbNumberDevice(
	diActualNumberOfDevices:= Lynus_Standards.GVL_Energy.stNumberOfDevices.diNumberOfEMS, 
	diMaxNumberOfDevices:= Constants_Energy.diMaxNumberOfEMS, 
	udiCounterOnlineChange:= TwinCAT_SystemInfoVarList._AppInfo.OnlineChangeCnt, 
	bNumberIsCalculatet=> , 
	bFPNumberIsCalculatet=> , 
	bOnlineChange=> , 
	diNumberForThisDevice=> diNrOfEMS_OUT, 
	diNumberOfTotalDevices=> );

//Write new Numer on GVL
IF fbNumberDevice.bFPNumberIsCalculatet THEN
	Lynus_Standards.GVL_Energy.stNumberOfDevices.diNumberOfEMS := fbNumberDevice.diNumberOfTotalDevices;	
END_IF 

//Delete old Number on GVL
IF fbNumberDevice.bOnlineChange THEN 
	Lynus_Standards.GVL_Energy.stNumberOfDevices.diNumberOfEMS := diNrOfEMS_OUT;	
		udiCounterOnlineChange_CP := TwinCAT_SystemInfoVarList._AppInfo.OnlineChangeCnt; 
END_IF

(*-------------------------------------------------------------Service from Backend is ready and check the connection to backen for dissabel/enable EMS Function---------------------------------------------------------------*)

//Try to reset the variable for connection on the GVL. When all is normal then the Lynus Mqtt connection function set this variable to true in the next cycle
//When we have no connection to the backend or no HB from the Service then after Lynus_Standards.Constants_General.tTimeDissableLynusFunctions days the EMS is dissabled with all of his functionalities
timResetConnectionOnGVL(IN:= NOT timResetConnectionOnGVL.Q, PT:= T#1H, Q=> , ET=> );
	IF timResetConnectionOnGVL.Q THEN Lynus_Standards.GVL_Communicator.bStateConnectionToEnableFunctions := FALSE; END_IF
		IF NOT Lynus_Standards.GVL_Communicator.bStateConnectionToEnableFunctions OR rHeartbeat_CP = rHeartbeat THEN timDissableFunctions.IN := TRUE; ELSE timDissableFunctions.IN := FALSE; END_IF  
			timDissableFunctions(IN:= , PT:= Lynus_Standards.Constants_General.tTimeDissableLynusFunctions, Q=> , ET=> );
	
//Heartbeat, Service Ready and ErrorWarning from Service
timHB(IN:= , PT:= T#130S, Q=> , ET=> );	
	IF rHeartbeat <> rHeartbeat_CP THEN 
		timHB.IN := FALSE; rHeartbeat_CP := rHeartbeat; 
	ELSE 
		timHB.IN := TRUE; 
	END_IF

//Error/Warning Timer and Service Ready Timer
timErrorWarning(IN:= rErrorWarning = 0, PT:= T#10S, Q=> , ET=> );
	timEnergyOptReady(IN:= rEnergyOptReady <> 0, PT:= T#10S, Q=> , ET=> );
		timControlingState(IN:= bControllingState, PT:= T#10S, Q=> , ET=> );
	
IF timErrorWarning.Q AND timEnergyOptReady.Q AND NOT bControllingState AND NOT timHB.Q AND NOT timDissableFunctions.Q THEN bDischrgCmdFromBackendOK := TRUE; END_IF
	IF rErrorWarning <> 0 OR rEnergyOptReady = 0 OR timControlingState.Q OR timHB.Q OR timDissableFunctions.Q OR NOT bEnable OR eOperationMode = E_OperatingMode_EMS.eAllOff THEN bDischrgCmdFromBackendOK := FALSE; END_IF
	
(*-------------------------------------------------------------Check the number of the device types what are neccessary for EMS---------------------------------------------------------------*)	
	
//To much Devices, Lynus_Standards.Constants_General.tTimeDissableLynusFunctions Days no connection to the backend or Error on the Grid Messurement stop the EMS and set al target power to 0
IF Lynus_Standards.GVL_Energy.stNumberOfDevices.diNumberOfEMS > Constants_Energy.diMaxNumberOfEMS OR Lynus_Standards.GVL_Energy.stNumberOfDevices.diNumberOfBatteryInverters > Constants_Energy.diMaxNumberOfBatteryInverters OR
	Lynus_Standards.GVL_Energy.stNumberOfDevices.diNumberOfBatterys > Constants_Energy.diMaxNumberOfBatterys OR Lynus_Standards.GVL_Energy.stNumberOfDevices.diNumberOfECS > Constants_Energy.diMaxNumberOfElectricChargingStations OR
		Lynus_Standards.GVL_Energy.stNumberOfDevices.diNumberOfEHE > Constants_Energy.diMaxNumberOfElectricHeatingElements OR Lynus_Standards.GVL_Energy.stNumberOfDevices.diNumberOfElectricMeters > Constants_Energy.diMaxNumberOfElectricMeters OR
			Lynus_Standards.GVL_Energy.stNumberOfDevices.diNumberOfGenerators > Constants_Energy.diMaxNumberOfGenerators OR Lynus_Standards.GVL_Energy.stNumberOfDevices.diNumberOfGrids > Constants_Energy.diMaxNumberOfGridConnections OR
				Lynus_Standards.GVL_Energy.stNumberOfDevices.diNumberOfHouseConsumption > Constants_Energy.diMaxNumberOfHouseConsumptions OR Lynus_Standards.GVL_Energy.stNumberOfDevices.diNumberOfHP > Constants_Energy.diMaxNumberOfHeatingPumps OR
					Lynus_Standards.GVL_Energy.stNumberOfDevices.diNumberOfOBC > Constants_Energy.diMaxNumberOfOtherBigConsumers OR Lynus_Standards.GVL_Energy.stNumberOfDevices.diNumberOfPvSystems > Constants_Energy.diMaxNumberOfPvSystems OR
						Lynus_Standards.GVL_Sensors.diNumberOfTemperatureSensors > Constants_Sensors.diMaxNumberOfTemperatureSensors OR timDelayStart.Q OR timDissableFunctions.Q OR timErrorGridMessurement.Q THEN 
							bStopAll := TRUE; 
ELSE 
							bStopAll := FALSE;	
END_IF

(*------------------------------------------------------------------------Enable-------------------------------------------------------------------------------*)		
		
bStateEnable := bEnable;

(*--------------------------------------------------------------Allow charging from grid-----------------------------------------------------------------------*)		
		
bStateAllowChrgFromGrid := stSetupEMS.bAllowChrgFromGrid;

(*--------------------------------------------------------------calcualte battery data-----------------------------------------------------------------------*)		
		
//Calcualte the total SOC if we have more then 1 battery in our system
	
diNumberOfActiveBatterys := 0;
	dwSumSOC := 0;
		FOR liLPBatteryData := 1 TO Constants_Energy.diMaxNumberOfBatterys BY 1 DO
			IF Lynus_Standards.GVL_Energy.stDataOfBatterys[diNrOfEMS_OUT,liLPBatteryData].bEnabled THEN diNumberOfActiveBatterys := diNumberOfActiveBatterys + 1; END_IF
				dwSumSOC := dwSumSOC + Lynus_Standards.GVL_Energy.stDataOfBatterys[diNrOfEMS_OUT,liLPBatteryData].dwSOC;
		END_FOR
	
dwSumSOCInEPO := 0;
	FOR liLPSumSOCInEPO := 1 TO Constants_Energy.diMaxNumberOfBatteryInverters BY 1 DO
		IF Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPSumSOCInEPO].bWorkOnIslandMode THEN dwSumSOCInEPO := dwSumSOCInEPO + Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPSumSOCInEPO].dwBatterySOC; END_IF
	END_FOR		
		
IF diNumberOfActiveBatterys > 0 THEN
	dwAvarageBatterySOC := DINT_TO_DWORD(DWORD_TO_DINT(dwSumSOC) / diNumberOfActiveBatterys);
END_IF

//Check if one or more Batterysystems or batteryinverter make island mode

diNumberOfBatteryInverterInEPO := 0;
	FOR liLPInEPO := 1 TO Constants_Energy.diMaxNumberOfBatteryInverters BY 1 DO
		IF Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPInEPO].bWorkOnIslandMode THEN bEPMActive := TRUE; diNumberOfBatteryInverterInEPO := diNumberOfBatteryInverterInEPO + 1; END_IF
	END_FOR 

IF diNumberOfBatteryInverterInEPO > 0 THEN
	dwAvarageBatterySOCInEPO := DINT_TO_DWORD(DWORD_TO_DINT(dwSumSOCInEPO) / diNumberOfBatteryInverterInEPO);
ELSE
	dwAvarageBatterySOCInEPO := 0;
END_IF
	
IF diNumberOfBatteryInverterInEPO <= 0 THEN bEPMActive := FALSE; END_IF

//Check the max. power of the grid connection and the sum of grid power
lrSizeGridConnection := 0;
	lrGridPower := 0;
		bErrorOnGridMessurement := FALSE;
			FOR liLPGridData := 1 TO Constants_Energy.diMaxNumberOfGridConnections BY 1 DO
				lrSizeGridConnection := lrSizeGridConnection + Lynus_Standards.GVL_Energy.stDataGridConnections[diNrOfEMS_OUT,liLPGridData].rSizeGridConn;
					lrGridPower := lrGridPower + Lynus_Standards.GVL_Energy.stDataGridConnections[diNrOfEMS_OUT,liLPGridData].lrPower;
						IF Lynus_Standards.GVL_Energy.stDataGridConnections[diNrOfEMS_OUT,liLPGridData].byErrorWarning = 2 THEN bErrorOnGridMessurement := TRUE; END_IF 
			END_FOR

//Error on Grid Messurement. (Stop the EMS Function)
timErrorGridMessurement(IN:= bErrorOnGridMessurement, PT:= T#30S, Q=> , ET=> );
	
//Timer for peaks to cut this
timCutPeaks(IN:= , PT:= T#2.5S, Q=> , ET=> );	

(*--------------------------------------------------------------Timeout-----------------------------------------------------------------------*)	

//Timout is using to go on next step if somthing goes wrong in the steps in what we check the next priority from the several devices
IF uiState = uiState_CP AND uiState >= 30 AND uiState <= 110 THEN timTimeout.IN := TRUE; ELSE timTimeout.IN := FALSE; END_IF
	//Choose the right Delay. Depending from the maximum of allowed Devices
	diBiggestNumberOfDeviceConstants := 0;
		IF Constants_Energy.diMaxNumberOfBatterys > diBiggestNumberOfDeviceConstants THEN diBiggestNumberOfDeviceConstants := Constants_Energy.diMaxNumberOfBatterys; END_IF
		IF Constants_Energy.diMaxNumberOfBatteryInverters > diBiggestNumberOfDeviceConstants THEN diBiggestNumberOfDeviceConstants := Constants_Energy.diMaxNumberOfBatteryInverters; END_IF 
		IF Constants_Energy.diMaxNumberOfElectricHeatingElements > diBiggestNumberOfDeviceConstants THEN diBiggestNumberOfDeviceConstants := Constants_Energy.diMaxNumberOfElectricHeatingElements; END_IF
		IF Constants_Energy.diMaxNumberOfHeatingPumps > diBiggestNumberOfDeviceConstants THEN diBiggestNumberOfDeviceConstants := Constants_Energy.diMaxNumberOfHeatingPumps; END_IF
		IF Constants_Energy.diMaxNumberOfElectricChargingStations > diBiggestNumberOfDeviceConstants THEN diBiggestNumberOfDeviceConstants := Constants_Energy.diMaxNumberOfElectricChargingStations; END_IF
		IF Constants_Energy.diMaxNumberOfOtherBigConsumers > diBiggestNumberOfDeviceConstants THEN diBiggestNumberOfDeviceConstants := Constants_Energy.diMaxNumberOfOtherBigConsumers; END_IF 
			//Cycletime in MS
			fbTaskIndex(index=> );
				udiCycleTime := TwinCAT_SystemInfoVarList._TaskInfo[fbTaskIndex.index].CycleTime / 10000;
					//Make a caculation with max Prio Number of 255, the cycle time and the biggest number. Because in the dumbest case it can take so long in one step until all priorities are gone through.
					timTimeout.PT := (T#1MS * udiCycleTime * 255 * diBiggestNumberOfDeviceConstants) + T#10S; 
						timTimeout(IN:= , PT:= , Q=> , ET=> );

(*--------------------------------------------------------------Timer for Battery-----------------------------------------------------------------------*)

//This timer ensures that the respective battery is full and thus in case of surplus or no surplus the power setting is directly regulated to 0% or -99.99% to accelerate the process.
//See in Step 131
//Only important in the self consumption mode

FOR liLPDataBatteryInverter := 1 TO Constants_Energy.diMaxNumberOfBatteryInverters BY 1 DO
	IF Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPDataBatteryInverter].dwBatterySOC >= 100 THEN
		arrTimBatterysAreFull[liLPDataBatteryInverter](IN:= TRUE, PT:= T#2M, Q=> , ET=> );
	ELSE
		arrTimBatterysAreFull[liLPDataBatteryInverter](IN:= FALSE, PT:= T#2M, Q=> , ET=> );
	END_IF						
END_FOR
	
(*-------------------------------------------------------------Logic form the ems function to manage the devices-----------------------------------------------------------------------------------*)		
		
timCalculateNewPowerValue(IN:= bEnable AND NOT timCalculateNewPowerValue.Q AND uiState = 10, PT:= (T#1S * stSetupEMS.uiUpdateTime) , Q=> , ET=> );		

IF NOT bEnable OR FPEPO.Q OR FNEPO.Q OR diMemCmpOperationState <> 0 OR eOperationMode = E_OperatingMode_EMS.eAllOff OR bStopAll THEN uiState := 0; END_IF
	IF MEMCMP(ADR(stNrOfEM_IN_ECS),ADR(stNrOfEM_IN_ECS_CP),SIZEOF(stNrOfEM_IN_ECS)) <> 0 OR MEMCMP(ADR(stSizeMainFuseCS),ADR(stSizeMainFuseCS_CP),SIZEOF(stSizeMainFuseCS_CP)) <> 0 THEN uiState := 1; END_IF

CASE uiState OF
	
	0: //Init Step
		
		byProgress := 0;
	
		eOperationModeEMS_CP := eOperationMode;
	
		IF bEnable AND eOperationMode <> E_OperatingMode_EMS.eAllOff AND NOT bStopAll THEN 
			uiState := 10; 
				arrActualPrioInTurn[1] := 1; arrActualPrioInTurn[2] := 1; arrActualPrioInTurn[3] := 1; arrActualPrioInTurn[4] := 1; arrActualPrioInTurn[5] := 1;
					arrActualStepInTurn[1] := 1; arrActualStepInTurn[2] := 1; 
						arrActualStepInTurn_CP[1]:= arrActualStepInTurn[1];
							arrActualStepInTurn_CP[2] := arrActualStepInTurn[2];
								bySmGrActiveCommonPrio_CP := 1;	liCounterCkeckDeviceAndPrio := 0;
									arrCTCheckActivePrio[1] := 0; arrCTCheckActivePrio[2] := 0; arrCTCheckActivePrio[3] := 0; arrCTCheckActivePrio[4] := 0; arrCTCheckActivePrio[5] := 0; liNrOfNotDoneDevices := 0; diNumberOfDevicesFromEachType := 0;
										timCutPeaks.IN := FALSE;
											arrMinPrioReached[1] := TRUE; arrMinPrioReached[2] := TRUE; arrMinPrioReached[3] := TRUE; arrMinPrioReached[4] := TRUE; arrMinPrioReached[5] := TRUE;
												arrMaxPrioReached[1] := FALSE; arrMaxPrioReached[2] := FALSE; arrMaxPrioReached[3] := FALSE; arrMaxPrioReached[4] := FALSE; arrMaxPrioReached[5] := FALSE;
		END_IF
		
	1: 	//Set the battery to Init if some Inputs are missing between the operation	
		arrActualPrioInTurn[1] := 1;
			bySmGrActiveCommonPrio_CP := 1;	
				arrCTCheckActivePrio[1] := 0; arrCTCheckActivePrio[2] := 0; arrCTCheckActivePrio[3] := 0; arrCTCheckActivePrio[4] := 0; arrCTCheckActivePrio[5] := 0; liNrOfNotDoneDevices := 0; diNumberOfDevicesFromEachType := 0; liCounterCkeckDeviceAndPrio := 0;
					timCutPeaks.IN := FALSE;
						arrMinPrioReached[1] := TRUE;
							arrMaxPrioReached[1] := FALSE;
								stNrOfEM_IN_ECS_CP := stNrOfEM_IN_ECS;
									stSizeMainFuseCS_CP := stSizeMainFuseCS;
										uiState := 10;
		
	10: //After the timer is expired then ckeck if we have surplus or not
		//Surplus calculation in the Self consumption mode 
		IF NOT bEPMActive AND eOperationMode = E_OperatingMode_EMS.eSelfConsumption THEN	
			lrActualSurplusOrConsumption := 0;
				FOR liLPActualSurplusOrConsumption := 1 TO Constants_Energy.diMaxNumberOfGridConnections BY 1 DO
					lrActualSurplusOrConsumption := lrActualSurplusOrConsumption + Lynus_Standards.GVL_Energy.stDataGridConnections[diNrOfEMS_OUT,liLPActualSurplusOrConsumption].lrPower;
				END_FOR
					IF lrActualSurplusOrConsumption < - Constants_Energy.rToleranceSurplusConsumption THEN bSurplusAvailable := TRUE; END_IF
						IF lrActualSurplusOrConsumption >= Constants_Energy.rToleranceSurplusConsumption THEN bSurplusAvailable := FALSE; END_IF
							IF lrActualSurplusOrConsumption >= - Constants_Energy.rToleranceSurplusConsumption AND lrActualSurplusOrConsumption < Constants_Energy.rToleranceSurplusConsumption THEN bSurplusAvailable := FALSE; lrActualSurplusOrConsumption := 0; END_IF
			
			//Peaks from <> 3 KW activate timer to wait 2.5 seconds before calculate
			IF lrActualSurplusOrConsumption >= (lrActualSurplusOrConsumptionOld + 3) OR lrActualSurplusOrConsumption <= (lrActualSurplusOrConsumptionOld - 3) THEN timCutPeaks.IN := TRUE; ELSE timCutPeaks.IN := FALSE; END_IF 
				lrActualSurplusOrConsumptionOld := lrActualSurplusOrConsumption;	
				
			IF timCalculateNewPowerValue.Q AND NOT timCutPeaks.Q AND rControllerQPIDSC <= 0 AND NOT fbPIDDischrgCmdFromBackend.bEnable THEN uiState := 30; END_IF
		END_IF
		
		//Surplus calculation in the peak load capping mode 
		IF NOT bEPMActive AND eOperationMode = E_OperatingMode_EMS.ePeakLoadCapping THEN	
			lrActualSurplusOrConsumption := 0;
				FOR liLPActualSurplusOrConsumption := 1 TO Constants_Energy.diMaxNumberOfGridConnections BY 1 DO
					lrActualSurplusOrConsumption := lrActualSurplusOrConsumption + Lynus_Standards.GVL_Energy.stDataGridConnections[diNrOfEMS_OUT,liLPActualSurplusOrConsumption].lrPower;
				END_FOR
				
				lrActualSurplusOrConsumption := (lrSizeGridConnection) - lrActualSurplusOrConsumption;
					lrActualSurplusOrConsumption := lrActualSurplusOrConsumption * - 1;
				
					IF lrActualSurplusOrConsumption < - Constants_Energy.rToleranceSurplusConsumption THEN bSurplusAvailable := TRUE; END_IF
						IF lrActualSurplusOrConsumption >= Constants_Energy.rToleranceSurplusConsumption THEN bSurplusAvailable := FALSE; END_IF	
							IF lrActualSurplusOrConsumption >= - Constants_Energy.rToleranceSurplusConsumption AND lrActualSurplusOrConsumption < Constants_Energy.rToleranceSurplusConsumption THEN bSurplusAvailable := FALSE; lrActualSurplusOrConsumption := 0; END_IF
				
			//Peaks from <> 3 KW activate timer to wait 2.5 seconds before calculate
			IF lrActualSurplusOrConsumption >= (lrActualSurplusOrConsumptionOld + 3) OR lrActualSurplusOrConsumption <= (lrActualSurplusOrConsumptionOld - 3) THEN timCutPeaks.IN := TRUE; ELSE timCutPeaks.IN := FALSE; END_IF 
				lrActualSurplusOrConsumptionOld := lrActualSurplusOrConsumption;
		
			IF timCalculateNewPowerValue.Q AND NOT timCutPeaks.Q THEN 
				uiState := 50; 
					//Set here to 0 because if other devices has Prio 1 or 255 the EMS not can finsih the Step why we leave Step 30
					liNrOfNotDoneDevices := 0; 
						//On this Operation Mode the batterys are always active. So we dont need the Step 30. See the PID Controllers for this mode
						IF ((bSurplusAvailable AND diNumberOfDevicesFromEachType = 0) OR (diNumberOfActiveBatterys = 0 AND bSurplusAvailable) OR (diNumberOfActiveBatterys <> 0 AND bSurplusAvailable)) THEN arrActualPrioInTurn[1] := 255; arrMinPrioReached[1] := FALSE; arrMaxPrioReached[1] := TRUE; END_IF
							IF ((NOT bSurplusAvailable AND diNumberOfDevicesFromEachType = 0) OR (diNumberOfActiveBatterys = 0 AND NOT bSurplusAvailable) OR (diNumberOfActiveBatterys <> 0 AND NOT bSurplusAvailable)) THEN arrActualPrioInTurn[1] := 1; arrMinPrioReached[1] := TRUE; arrMaxPrioReached[1] := FALSE; END_IF
			END_IF;
		END_IF
		
		//Surplus calculation in the load managemant mode 
		IF NOT bEPMActive AND eOperationMode = E_OperatingMode_EMS.eLoadManagement THEN	
			lrActualSurplusOrConsumption := 0;
				FOR liLPActualSurplusOrConsumption := 1 TO Constants_Energy.diMaxNumberOfGridConnections BY 1 DO
					lrActualSurplusOrConsumption := lrActualSurplusOrConsumption + Lynus_Standards.GVL_Energy.stDataGridConnections[diNrOfEMS_OUT,liLPActualSurplusOrConsumption].lrPower;
				END_FOR
				
				lrActualSurplusOrConsumption := (lrSizeGridConnection) - lrActualSurplusOrConsumption;
					lrActualSurplusOrConsumption := lrActualSurplusOrConsumption * - 1;
				
					IF lrActualSurplusOrConsumption < - Constants_Energy.rToleranceSurplusConsumption THEN bSurplusAvailable := TRUE; END_IF
						IF lrActualSurplusOrConsumption >= Constants_Energy.rToleranceSurplusConsumption THEN bSurplusAvailable := FALSE; END_IF	
							IF lrActualSurplusOrConsumption >= - Constants_Energy.rToleranceSurplusConsumption AND lrActualSurplusOrConsumption < Constants_Energy.rToleranceSurplusConsumption THEN bSurplusAvailable := FALSE; lrActualSurplusOrConsumption := 0; END_IF
			
			//Peaks from <> 3 KW activate timer to wait 2.5 seconds before calculate
			IF lrActualSurplusOrConsumption >= (lrActualSurplusOrConsumptionOld + 3) OR lrActualSurplusOrConsumption <= (lrActualSurplusOrConsumptionOld - 3) THEN timCutPeaks.IN := TRUE; ELSE timCutPeaks.IN := FALSE; END_IF 
				lrActualSurplusOrConsumptionOld := lrActualSurplusOrConsumption;
			
			IF timCalculateNewPowerValue.Q AND NOT timCutPeaks.Q THEN 
				uiState := 50; 
					//Set here to 0 because if other devices has Prio 1 or 255 the EMS not can finsih the Step why we leave Step 30
					liNrOfNotDoneDevices := 0; 
						//On this Operation Mode the batterys are always active. So we dont need the Step 30. See the PID Controllers for this mode
						IF ((bSurplusAvailable AND diNumberOfDevicesFromEachType = 0) OR (diNumberOfActiveBatterys = 0 AND bSurplusAvailable) OR (diNumberOfActiveBatterys <> 0 AND bSurplusAvailable)) THEN arrActualPrioInTurn[1] := 255; arrMinPrioReached[1] := FALSE; arrMaxPrioReached[1] := TRUE; END_IF
							IF ((NOT bSurplusAvailable AND diNumberOfDevicesFromEachType = 0) OR (diNumberOfActiveBatterys = 0 AND NOT bSurplusAvailable) OR (diNumberOfActiveBatterys <> 0 AND NOT bSurplusAvailable)) THEN arrActualPrioInTurn[1] := 1; arrMinPrioReached[1] := TRUE; arrMaxPrioReached[1] := FALSE; END_IF
			END_IF
		END_IF
		
		//Surplus calculation in the emergency power mode
		IF bEPMActive THEN	
			lrActualSurplusOrConsumption := 0;
				FOR liLPActualSurplusOrConsumption := 1 TO Constants_Energy.diMaxNumberOfBatteryInverters BY 1 DO
					IF Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPActualSurplusOrConsumption].bWorkOnIslandMode THEN lrActualSurplusOrConsumption := lrActualSurplusOrConsumption + Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPActualSurplusOrConsumption].lrPowerOnIslandMode; END_IF
				END_FOR
					IF lrActualSurplusOrConsumption < - Constants_Energy.rToleranceSurplusConsumption THEN bSurplusAvailable := TRUE; END_IF
						IF lrActualSurplusOrConsumption >= Constants_Energy.rToleranceSurplusConsumption THEN bSurplusAvailable := FALSE; END_IF
							IF lrActualSurplusOrConsumption >= - Constants_Energy.rToleranceSurplusConsumption AND lrActualSurplusOrConsumption < Constants_Energy.rToleranceSurplusConsumption THEN bSurplusAvailable := FALSE; lrActualSurplusOrConsumption := 0; END_IF
			
			//Peaks from <> 3 KW activate timer to wait 2.5 seconds before calculate
			IF lrActualSurplusOrConsumption >= (lrActualSurplusOrConsumptionOld + 3) OR lrActualSurplusOrConsumption <= (lrActualSurplusOrConsumptionOld - 3) THEN timCutPeaks.IN := TRUE; ELSE timCutPeaks.IN := FALSE; END_IF 
				lrActualSurplusOrConsumptionOld := lrActualSurplusOrConsumption;
			
			IF timCalculateNewPowerValue.Q AND NOT timCutPeaks.Q AND rControllerQPIDEPO <= 0 THEN uiState := 21; END_IF;
		END_IF
		
	21:	//If emergency power is active then first charge batteries that are build the island mode until byPrioMinChargeBattSOCInEPO, only then start normal mode according to priorities. 
		//Batterys or battery inverters that do not work on island mode, are only loaded afterwards based on the priority.  
		//As long as this SOC from byPrioMinChargeBattSOCInEPO is undercut, all other devices are regulated to 0.
		IF dwAvarageBatterySOCInEPO < stSetupEMS.byPrioChrgBattSOCInEPO THEN
			uiState := 0;
				bSurplusAvailable := FALSE;
					lrActualSurplusOrConsumption := 0;
						arrMinPrioReached[1] := TRUE; arrMinPrioReached[2] := TRUE; arrMinPrioReached[3] := TRUE; arrMinPrioReached[4] := TRUE; arrMinPrioReached[5] := TRUE;
							arrMaxPrioReached[1] := FALSE; arrMaxPrioReached[2] := FALSE; arrMaxPrioReached[3] := FALSE; arrMaxPrioReached[4] := FALSE; arrMaxPrioReached[5] := FALSE;
								bChargePrioBatterysOnEPO := TRUE;
		END_IF
			IF (dwAvarageBatterySOCInEPO >= (stSetupEMS.byPrioChrgBattSOCInEPO + 1) AND stSetupEMS.byPrioChrgBattSOCInEPO < 75) OR
				(dwAvarageBatterySOCInEPO >= stSetupEMS.byPrioChrgBattSOCInEPO AND stSetupEMS.byPrioChrgBattSOCInEPO >= 75) THEN
					bChargePrioBatterysOnEPO := FALSE;
						uiState := 30;
			END_IF
		
	30: //Check the priority for battery or battery inverters to controll (Batterys they are in island mode are not considered here)
		uiState_CP := uiState;
		
		//First check if we have min 1 of this Device Type. If not, complete this Device Type and go to the next step
		//Check also the bigest Priority of this Device Type
		diNumberOfDevicesFromEachType := 0; bySearchBigestPrio := 0;
		FOR liLPCheckDeviceAndPrio := 1 TO Constants_Energy.diMaxNumberOfBatteryInverters BY 1 DO
			IF Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPCheckDeviceAndPrio].byPriority <> 0 THEN diNumberOfDevicesFromEachType := diNumberOfDevicesFromEachType + 1; END_IF
			 IF Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPCheckDeviceAndPrio].byPriority > bySearchBigestPrio THEN bySearchBigestPrio := Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPCheckDeviceAndPrio].byPriority; END_IF  	
		END_FOR 
			IF bSurplusAvailable AND arrActualPrioInTurn[1] > bySearchBigestPrio AND uiState = 30 THEN arrActualPrioInTurn[1] := 255; END_IF
				IF NOT bSurplusAvailable AND arrActualPrioInTurn[1] > bySearchBigestPrio AND uiState = 30 THEN arrActualPrioInTurn[1] := bySearchBigestPrio; END_IF     
		
			IF bSurplusAvailable AND diNumberOfDevicesFromEachType = 0 THEN arrActualPrioInTurn[1] := 255; END_IF
				IF NOT bSurplusAvailable AND diNumberOfDevicesFromEachType = 0 THEN arrActualPrioInTurn[1] := 1; END_IF
		
		//Count up each Device
		arrCTCheckActivePrio[1] := arrCTCheckActivePrio[1] + 1;
			arrCTCheckActivePrio[1] := LIMIT(1,arrCTCheckActivePrio[1],Constants_Energy.diMaxNumberOfBatteryInverters);		
				
			//Surplus
			IF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,arrCTCheckActivePrio[1]].byPriority = arrActualPrioInTurn[1] AND Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,arrCTCheckActivePrio[1]].rTargetPowerEMS > -100 AND NOT Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,arrCTCheckActivePrio[1]].bWorkOnIslandMode THEN
				arrMaxPrioReached[1] := FALSE;
					arrMinPrioReached[1] := FALSE;
						arrCTCheckActivePrio[1] := 0; liNrOfNotDoneDevices := 0; liCounterCkeckDeviceAndPrio := 0; //Set here to 0 because in next Step we dont can work with a loop (performance Problems on small PLC)
							uiState := 50;
			ELSE
				IF bSurplusAvailable AND arrActualPrioInTurn[1] < 255 AND uiState = 30 AND arrCTCheckActivePrio[1] = Constants_Energy.diMaxNumberOfBatteryInverters THEN arrActualPrioInTurn[1] := arrActualPrioInTurn[1] + 1; arrCTCheckActivePrio[1] := 0; END_IF
			END_IF
				//No surplus
				IF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,arrCTCheckActivePrio[1]].byPriority = arrActualPrioInTurn[1] AND Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,arrCTCheckActivePrio[1]].rTargetPowerEMS < 0 AND NOT Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,arrCTCheckActivePrio[1]].bWorkOnIslandMode THEN
					arrMaxPrioReached[1] := FALSE;
						arrMinPrioReached[1] := FALSE;
							arrCTCheckActivePrio[1] := 0; liNrOfNotDoneDevices := 0; liCounterCkeckDeviceAndPrio := 0;
								uiState := 50;
				ELSE
					IF NOT bSurplusAvailable AND arrActualPrioInTurn[1] > 1 AND uiState = 30 AND arrCTCheckActivePrio[1] = Constants_Energy.diMaxNumberOfBatteryInverters THEN arrActualPrioInTurn[1] := arrActualPrioInTurn[1] - 1; arrCTCheckActivePrio[1] := 0; END_IF
				END_IF
		
		//Go to next step if we are on min prio or on max prio and the target power is just set to the min or to the max value.
		liNrOfNotDoneDevices := 0;
			IF uiState = 30 THEN
				FOR liLPCheckDeviceAndPrio := 1 TO Constants_Energy.diMaxNumberOfBatteryInverters BY 1 DO
					IF arrActualPrioInTurn[1] = 1 AND Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPCheckDeviceAndPrio].rTargetPowerEMS <> 0 AND Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPCheckDeviceAndPrio].byPriority = 1 THEN
						liNrOfNotDoneDevices := liNrOfNotDoneDevices + 1;	
					END_IF
						IF arrActualPrioInTurn[1] = 255 AND Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPCheckDeviceAndPrio].rTargetPowerEMS > - 100 AND Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPCheckDeviceAndPrio].byPriority = 255 THEN
							liNrOfNotDoneDevices := liNrOfNotDoneDevices + 1;	
						END_IF
				END_FOR	
			END_IF
		
		IF arrActualPrioInTurn[1] = 1 AND uiState = 30 AND liNrOfNotDoneDevices = 0 AND arrCTCheckActivePrio[1] = Constants_Energy.diMaxNumberOfBatteryInverters THEN 
			arrMinPrioReached[1] := TRUE; arrMaxPrioReached[1] := FALSE; liNrOfNotDoneDevices := 0; uiState := 50; arrCTCheckActivePrio[1] := 0; liCounterCkeckDeviceAndPrio := 0;
		END_IF
		IF arrActualPrioInTurn[1] = 255 AND uiState = 30 AND liNrOfNotDoneDevices = 0 AND arrCTCheckActivePrio[1] = Constants_Energy.diMaxNumberOfBatteryInverters THEN 
			arrMaxPrioReached[1] := TRUE; arrMinPrioReached[1] := FALSE; liNrOfNotDoneDevices := 0; uiState := 50; arrCTCheckActivePrio[1] := 0; liCounterCkeckDeviceAndPrio := 0;
		END_IF
		
		//Timout, go to next step
		IF timTimeout.Q AND uiState = 30 THEN uiState := 50; END_IF
		
	50: //Check the priority for the heating pump incl. the steps to controll it
		uiState_CP := uiState;	
	
		//Counter to ckeck if we reached at the min or the max prio
		IF uiState = 50 THEN liCounterCkeckDeviceAndPrio := liCounterCkeckDeviceAndPrio + 1; END_IF
	
		//First check if we have min 1 of this Device Type. If not, complete this Device Type and go to the next step
		//Check also the bigest Priority of this Device Type
		diNumberOfDevicesFromEachType := 0; bySearchBigestPrio := 0;
		FOR liLPCheckDeviceAndPrio := 1 TO Constants_Energy.diMaxNumberOfHeatingPumps BY 1 DO
			IF Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPCheckDeviceAndPrio].byPriority <> 0 THEN diNumberOfDevicesFromEachType := diNumberOfDevicesFromEachType + 1; END_IF
				IF Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPCheckDeviceAndPrio].byPriority > bySearchBigestPrio THEN bySearchBigestPrio := Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPCheckDeviceAndPrio].byPriority; END_IF  
		END_FOR 
			IF bSurplusAvailable AND arrActualPrioInTurn[2] > bySearchBigestPrio AND uiState = 50 THEN arrActualPrioInTurn[2] := 255; END_IF
				IF NOT bSurplusAvailable AND arrActualPrioInTurn[2] > bySearchBigestPrio AND uiState = 50 THEN arrActualPrioInTurn[2] := bySearchBigestPrio; END_IF
		
			IF bSurplusAvailable AND diNumberOfDevicesFromEachType = 0 THEN arrActualPrioInTurn[2] := 255; END_IF
				IF NOT bSurplusAvailable AND diNumberOfDevicesFromEachType = 0 THEN arrActualPrioInTurn[2] := 1; END_IF
		
		//Count up each Device
		arrCTCheckActivePrio[2] := arrCTCheckActivePrio[2] + 1;
			arrCTCheckActivePrio[2] := LIMIT(1,arrCTCheckActivePrio[2],Constants_Energy.diMaxNumberOfHeatingPumps);
	
			//Surplus
			IF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].byPriority = arrActualPrioInTurn[2] AND NOT Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].bIsStepSwitched AND NOT 
				Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].arrTargetPowerEMS[1] < 100 THEN
					arrActualStepInTurn[1] := 1;	
						arrMaxPrioReached[2] := FALSE;
							arrMinPrioReached[2] := FALSE;
								arrCTCheckActivePrio[2] := 0; liNrOfNotDoneDevices := 0; liCounterCkeckDeviceAndPrio := 0; //Set here to 0 because in next Step we dont can work with a loop (performance Problems on small PLC)
									uiState := 70;
			ELSIF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].byPriority = arrActualPrioInTurn[2] AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].byNumberOfSteps = 0 AND
				Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].arrTargetPowerEMS[1] < 100 THEN 
					arrActualStepInTurn[1] := 1;	
						arrMaxPrioReached[2] := FALSE;
							arrMinPrioReached[2] := FALSE;
								arrCTCheckActivePrio[2] := 0; liNrOfNotDoneDevices := 0; liCounterCkeckDeviceAndPrio := 0;
									uiState := 70;
			ELSIF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].byPriority = arrActualPrioInTurn[2] AND NOT Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].bIsStepSwitched AND 
				Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].arrTargetPowerEMS[1] < 100 THEN 
					arrActualStepInTurn[1] := 1;	
						arrMaxPrioReached[2] := FALSE;
							arrMinPrioReached[2] := FALSE;
								arrCTCheckActivePrio[2] := 0; liNrOfNotDoneDevices := 0; liCounterCkeckDeviceAndPrio := 0;
									uiState := 70;
			ELSIF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].byPriority = arrActualPrioInTurn[2] AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].bIsStepSwitched AND 
				Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].byNumberOfSteps = 1 AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].arrTargetPowerEMS[1] < 100 THEN 
					arrActualStepInTurn[1] := 1;	
						arrMaxPrioReached[2] := FALSE;
							arrMinPrioReached[2] := FALSE;
								arrCTCheckActivePrio[2] := 0; liNrOfNotDoneDevices := 0; liCounterCkeckDeviceAndPrio := 0;
									uiState := 70;
			ELSIF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].byPriority = arrActualPrioInTurn[2] AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].bIsStepSwitched AND 
				Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].byNumberOfSteps = 2 AND (Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].arrTargetPowerEMS[1] < 100 OR Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].arrTargetPowerEMS[2] < 100) THEN 
					IF Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].arrTargetPowerEMS[1] >= 100 THEN arrActualStepInTurn[1] := 2; ELSE arrActualStepInTurn[1] := 1; END_IF
						arrMaxPrioReached[2] := FALSE; 
							arrMinPrioReached[2] := FALSE;
								arrCTCheckActivePrio[2] := 0; liNrOfNotDoneDevices := 0; liCounterCkeckDeviceAndPrio := 0;
									uiState := 70;
			ELSE
				IF bSurplusAvailable AND arrActualPrioInTurn[2] < 255 AND uiState = 50 AND arrCTCheckActivePrio[2] = Constants_Energy.diMaxNumberOfHeatingPumps THEN 
					arrActualPrioInTurn[2] := arrActualPrioInTurn[2] + 1; arrCTCheckActivePrio[2] := 0; liCounterCkeckDeviceAndPrio := 0; liNrOfNotDoneDevices := 0; 
				END_IF
			END_IF
				//No surplus
				IF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].byPriority = arrActualPrioInTurn[2] AND NOT Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].bIsStepSwitched AND NOT 
					Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].arrTargetPowerEMS[1] > 0 THEN
						arrActualStepInTurn[1] := 1;	
							arrMaxPrioReached[2] := FALSE;
								arrMinPrioReached[2] := FALSE;
									arrCTCheckActivePrio[2] := 0; liNrOfNotDoneDevices := 0; liCounterCkeckDeviceAndPrio := 0;
										uiState := 70;
				ELSIF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].byPriority = arrActualPrioInTurn[2] AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].byNumberOfSteps = 0 AND 
					Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].arrTargetPowerEMS[1] > 0 THEN
						arrActualStepInTurn[1] := 1;	
							arrMaxPrioReached[2] := FALSE;
								arrMinPrioReached[2] := FALSE;
									arrCTCheckActivePrio[2] := 0; liNrOfNotDoneDevices := 0; liCounterCkeckDeviceAndPrio := 0;
										uiState := 70;
				ELSIF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].byPriority = arrActualPrioInTurn[2] AND NOT Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].bIsStepSwitched AND 
					Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].arrTargetPowerEMS[1] > 0 THEN
						arrActualStepInTurn[1] := 1;	
							arrMaxPrioReached[2] := FALSE;
								arrMinPrioReached[2] := FALSE;
									arrCTCheckActivePrio[2] := 0; liNrOfNotDoneDevices := 0; liCounterCkeckDeviceAndPrio := 0;
										uiState := 70;
				ELSIF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].byPriority = arrActualPrioInTurn[2] AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].bIsStepSwitched AND 
					Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].byNumberOfSteps = 1 AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].arrTargetPowerEMS[1] > 0 THEN
						arrActualStepInTurn[1] := 1;	
							arrMaxPrioReached[2] := FALSE;
								arrMinPrioReached[2] := FALSE;
									arrCTCheckActivePrio[2] := 0; liNrOfNotDoneDevices := 0; liCounterCkeckDeviceAndPrio := 0;
										uiState := 70;
				ELSIF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].byPriority = arrActualPrioInTurn[2] AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].bIsStepSwitched AND 
					Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].byNumberOfSteps = 2 AND (Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].arrTargetPowerEMS[1] > 0 OR Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].arrTargetPowerEMS[2] > 0) THEN
						IF Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrCTCheckActivePrio[2]].arrTargetPowerEMS[2] <= 0 THEN arrActualStepInTurn[1] := 1; ELSE arrActualStepInTurn[1] := 2; END_IF
							arrMaxPrioReached[2] := FALSE;
								arrMinPrioReached[2] := FALSE;	
									arrCTCheckActivePrio[2] := 0; liNrOfNotDoneDevices := 0; liCounterCkeckDeviceAndPrio := 0;
										uiState := 70;
				ELSE
					IF NOT bSurplusAvailable AND arrActualPrioInTurn[2] > 1 AND uiState = 50 AND arrCTCheckActivePrio[2] = Constants_Energy.diMaxNumberOfHeatingPumps THEN 
						arrActualPrioInTurn[2] := arrActualPrioInTurn[2] - 1; arrCTCheckActivePrio[2] := 0; liCounterCkeckDeviceAndPrio := 0;  liNrOfNotDoneDevices := 0; 
					END_IF
				END_IF 	  
		
		//Go to next step if we are on min prio or on max prio and the target power is just set to the min or to the max value.
		liCounterCkeckDeviceAndPrio := LIMIT(0,liCounterCkeckDeviceAndPrio,Constants_Energy.diMaxNumberOfHeatingPumps);
		
			IF arrActualPrioInTurn[2] = 1 AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].byPriority = 1 AND
				(Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[1] <> 0 OR Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[2] <> 0) THEN 
					liNrOfNotDoneDevices := liNrOfNotDoneDevices + 1; 
			END_IF
				//1 Step
				IF arrActualPrioInTurn[2] = 255 AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].byPriority = 255 AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].byNumberOfSteps = 1 AND  
					Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[1] < 100 THEN 
						liNrOfNotDoneDevices := liNrOfNotDoneDevices + 1; 
				//2 Steps
				ELSIF arrActualPrioInTurn[2] = 255 AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].byPriority = 255 AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].byNumberOfSteps = 2 AND  
					(Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[1] < 100 OR Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[2] < 100) THEN 
						liNrOfNotDoneDevices := liNrOfNotDoneDevices + 1; 
				END_IF
			
		
		IF arrActualPrioInTurn[2] = 1 AND uiState = 50 AND liNrOfNotDoneDevices = 0 AND arrCTCheckActivePrio[2] = Constants_Energy.diMaxNumberOfHeatingPumps AND liCounterCkeckDeviceAndPrio = Constants_Energy.diMaxNumberOfHeatingPumps THEN 
			arrMinPrioReached[2] := TRUE; arrMaxPrioReached[2] := FALSE; liNrOfNotDoneDevices := 0; uiState := 70; arrCTCheckActivePrio[2] := 0; liCounterCkeckDeviceAndPrio := 0; 
		END_IF
		IF arrActualPrioInTurn[2] = 255 AND uiState = 50 AND liNrOfNotDoneDevices = 0 AND arrCTCheckActivePrio[2] = Constants_Energy.diMaxNumberOfHeatingPumps AND  liCounterCkeckDeviceAndPrio = Constants_Energy.diMaxNumberOfHeatingPumps THEN 
			arrMaxPrioReached[2] := TRUE; arrMinPrioReached[2] := FALSE; liNrOfNotDoneDevices := 0; uiState := 70; arrCTCheckActivePrio[2] := 0; liCounterCkeckDeviceAndPrio := 0;
		END_IF
		
		//Timout, go to next step
		IF timTimeout.Q AND uiState = 50 THEN uiState := 70; END_IF
		
	70: //Check the priority for the electric heating element incl. the steps to controll it
		uiState_CP := uiState;
	
		//Counter to ckeck if we reached at the min or the max prio
		IF uiState = 70 THEN liCounterCkeckDeviceAndPrio := liCounterCkeckDeviceAndPrio + 1; END_IF
	
		//First check if we have min 1 of this Device Type. If not, complete this Device Type and go to the next step
		//Check also the bigest Priority of this Device Type
		diNumberOfDevicesFromEachType := 0; bySearchBigestPrio := 0;
		FOR liLPCheckDeviceAndPrio := 1 TO Constants_Energy.diMaxNumberOfElectricHeatingElements BY 1 DO
			IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPCheckDeviceAndPrio].byPriority <> 0 THEN diNumberOfDevicesFromEachType := diNumberOfDevicesFromEachType + 1; END_IF
				IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPCheckDeviceAndPrio].byPriority > bySearchBigestPrio THEN bySearchBigestPrio := Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPCheckDeviceAndPrio].byPriority; END_IF   
		END_FOR 
			IF bSurplusAvailable AND arrActualPrioInTurn[3] > bySearchBigestPrio AND uiState = 70 THEN arrActualPrioInTurn[3] := 255; END_IF
				IF NOT bSurplusAvailable AND arrActualPrioInTurn[3] > bySearchBigestPrio AND uiState = 70 THEN arrActualPrioInTurn[3] := bySearchBigestPrio; END_IF
		
			IF bSurplusAvailable AND diNumberOfDevicesFromEachType = 0 THEN arrActualPrioInTurn[3] := 255; END_IF
				IF NOT bSurplusAvailable AND diNumberOfDevicesFromEachType = 0 THEN arrActualPrioInTurn[3] := 1; END_IF
		
		//Count up each Device
		arrCTCheckActivePrio[3] := arrCTCheckActivePrio[3] + 1;
			arrCTCheckActivePrio[3] := LIMIT(1,arrCTCheckActivePrio[3],Constants_Energy.diMaxNumberOfElectricHeatingElements);
		
			//Surplus
			IF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byPriority = arrActualPrioInTurn[3] AND NOT Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsStepSwitched AND NOT 
				Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] < 100 THEN
					arrActualStepInTurn[2] := 1;	
						arrMaxPrioReached[3] := FALSE;
							arrMinPrioReached[3] := FALSE;
								arrCTCheckActivePrio[3] := 0;
									uiState := 90;
			ELSIF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byPriority = arrActualPrioInTurn[3] AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byNumberOfSteps = 0 AND
				Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] < 100 THEN 
					arrActualStepInTurn[2] := 1;	
						arrMaxPrioReached[3] := FALSE;
							arrMinPrioReached[3] := FALSE;
								arrCTCheckActivePrio[3] := 0;
									uiState := 90;
			ELSIF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byPriority = arrActualPrioInTurn[3] AND NOT Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsStepSwitched AND 
				Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] < 100 THEN
					arrActualStepInTurn[2] := 1;	
						arrMaxPrioReached[3] := FALSE;
							arrMinPrioReached[3] := FALSE;
								arrCTCheckActivePrio[3] := 0;
									uiState := 90;	
			ELSIF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byPriority = arrActualPrioInTurn[3] AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsStepSwitched AND 
				Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byNumberOfSteps = 1 AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] < 100 THEN 
					arrActualStepInTurn[2] := 1;	
						arrMaxPrioReached[3] := FALSE;
							arrMinPrioReached[3] := FALSE;
								arrCTCheckActivePrio[3] := 0;
									uiState := 90;
			ELSIF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byPriority = arrActualPrioInTurn[3] AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsStepSwitched AND 
				Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byNumberOfSteps = 2 AND (Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] < 100) THEN
					IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] >= 100 THEN arrActualStepInTurn[2] := 2; ELSE arrActualStepInTurn[2] := 1; END_IF
						arrMaxPrioReached[3] := FALSE;
							arrMinPrioReached[3] := FALSE;
								arrCTCheckActivePrio[3] := 0;
									uiState := 90;
			ELSIF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byPriority = arrActualPrioInTurn[3] AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsStepSwitched AND 
				Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byNumberOfSteps = 3 AND (Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3] < 100) THEN
					IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] < 100 THEN arrActualStepInTurn[2] := 1; END_IF
					IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] >= 100 THEN arrActualStepInTurn[2] := 2; END_IF
					IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] >= 100 THEN arrActualStepInTurn[2] := 3; END_IF
						arrMaxPrioReached[3] := FALSE;
							arrMinPrioReached[3] := FALSE;
								arrCTCheckActivePrio[3] := 0;
									uiState := 90;
			ELSIF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byPriority = arrActualPrioInTurn[3] AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsStepSwitched AND 
				Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byNumberOfSteps = 4 AND 
					(Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3] < 100 OR
						Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[4] < 100) THEN
							IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] < 100 THEN arrActualStepInTurn[2] := 1; END_IF
							IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] >= 100 THEN arrActualStepInTurn[2] := 2; END_IF
							IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] >= 100 THEN arrActualStepInTurn[2] := 3; END_IF
							IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3] >= 100 THEN arrActualStepInTurn[2] := 4; END_IF
								arrMaxPrioReached[3] := FALSE;
									arrMinPrioReached[3] := FALSE;
										arrCTCheckActivePrio[3] := 0;
											uiState := 90;
			ELSIF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byPriority = arrActualPrioInTurn[3] AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsStepSwitched AND 
				Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byNumberOfSteps = 5 AND 
					(Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3] < 100 OR
						Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[4] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[5] < 100) THEN
							IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] < 100 THEN arrActualStepInTurn[2] := 1; END_IF
							IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] >= 100 THEN arrActualStepInTurn[2] := 2; END_IF
							IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] >= 100 THEN arrActualStepInTurn[2] := 3; END_IF
							IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3] >= 100 THEN arrActualStepInTurn[2] := 4; END_IF
							IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[4] >= 100 THEN arrActualStepInTurn[2] := 5; END_IF
								arrMaxPrioReached[3] := FALSE;
									arrMinPrioReached[3] := FALSE;
										arrCTCheckActivePrio[3] := 0;
											uiState := 90;
			ELSIF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byPriority = arrActualPrioInTurn[3] AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsStepSwitched AND 
				Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byNumberOfSteps = 6 AND 
					(Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2]< 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3]< 100 OR
						Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[4] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[5] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[6] < 100) THEN
							IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] < 100 THEN arrActualStepInTurn[2] := 1; END_IF
							IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] >= 100 THEN arrActualStepInTurn[2] := 2; END_IF
							IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] >= 100 THEN arrActualStepInTurn[2] := 3; END_IF
							IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3] >= 100 THEN arrActualStepInTurn[2] := 4; END_IF
							IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[4] >= 100 THEN arrActualStepInTurn[2] := 5; END_IF
							IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[5] >= 100 THEN arrActualStepInTurn[2] := 6; END_IF
								arrMaxPrioReached[3] := FALSE;
									arrMinPrioReached[3] := FALSE;
										arrCTCheckActivePrio[3] := 0;
											uiState := 90;
			ELSIF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byPriority = arrActualPrioInTurn[3] AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsStepSwitched AND 
				Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byNumberOfSteps= 7 AND 
					(Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3] < 100 OR
						Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[4] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[5] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[6] < 100 OR
							Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[7] < 100) THEN
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] < 100 THEN arrActualStepInTurn[2] := 1; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] >= 100 THEN arrActualStepInTurn[2] := 2; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] >= 100 THEN arrActualStepInTurn[2] := 3; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3] >= 100 THEN arrActualStepInTurn[2] := 4; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[4] >= 100 THEN arrActualStepInTurn[2] := 5; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[5] >= 100 THEN arrActualStepInTurn[2] := 6; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[6] >= 100 THEN arrActualStepInTurn[2] := 7; END_IF
									arrMaxPrioReached[3] := FALSE;
										arrMinPrioReached[3] := FALSE;
											arrCTCheckActivePrio[3] := 0;
												uiState := 90;
			ELSIF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byPriority = arrActualPrioInTurn[3] AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsStepSwitched AND 
				Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byNumberOfSteps = 8 AND 
					(Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3] < 100 OR
						Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[4] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[5] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[6] < 100 OR
							Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[7] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[8] < 100) THEN
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] < 100 THEN arrActualStepInTurn[2] := 1; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] >= 100 THEN arrActualStepInTurn[2] := 2; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] >= 100 THEN arrActualStepInTurn[2] := 3; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3] >= 100 THEN arrActualStepInTurn[2] := 4; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[4] >= 100 THEN arrActualStepInTurn[2] := 5; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[5] >= 100 THEN arrActualStepInTurn[2] := 6; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[6] >= 100 THEN arrActualStepInTurn[2] := 7; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[7] >= 100 THEN arrActualStepInTurn[2] := 8; END_IF
									arrMaxPrioReached[3] := FALSE;
										arrMinPrioReached[3] := FALSE;
											arrCTCheckActivePrio[3] := 0;
												uiState := 90;
			ELSIF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byPriority = arrActualPrioInTurn[3] AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsStepSwitched AND 
				Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byNumberOfSteps = 9 AND 
					(Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3] < 100 OR
						Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[4] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[5] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[6] < 100 OR
							Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[7] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[8] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[9] < 100) THEN
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] < 100 THEN arrActualStepInTurn[2] := 1; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] >= 100 THEN arrActualStepInTurn[2] := 2; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] >= 100 THEN arrActualStepInTurn[2] := 3; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3] >= 100 THEN arrActualStepInTurn[2] := 4; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[4] >= 100 THEN arrActualStepInTurn[2] := 5; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[5] >= 100 THEN arrActualStepInTurn[2] := 6; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[6] >= 100 THEN arrActualStepInTurn[2] := 7; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[7] >= 100 THEN arrActualStepInTurn[2] := 8; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[8] >= 100 THEN arrActualStepInTurn[2] := 9; END_IF
									arrMaxPrioReached[3] := FALSE;
										arrMinPrioReached[3] := FALSE;
											arrCTCheckActivePrio[3] := 0;
												uiState := 90;
			ELSIF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byPriority = arrActualPrioInTurn[3] AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsStepSwitched AND 
				Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byNumberOfSteps = 10 AND 
					(Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3] < 100 OR
						Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[4] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[5] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[6] < 100 OR
							Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[7] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[8] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[9] < 100 OR
								Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[10] < 100) THEN
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] < 100 THEN arrActualStepInTurn[2] := 1; END_IF
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] >= 100 THEN arrActualStepInTurn[2] := 2; END_IF
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] >= 100 THEN arrActualStepInTurn[2] := 3; END_IF
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3] >= 100 THEN arrActualStepInTurn[2] := 4; END_IF
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[4] >= 100 THEN arrActualStepInTurn[2] := 5; END_IF
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[5] >= 100 THEN arrActualStepInTurn[2] := 6; END_IF
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[6] >= 100 THEN arrActualStepInTurn[2] := 7; END_IF
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[7] >= 100 THEN arrActualStepInTurn[2] := 8; END_IF
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[8] >= 100 THEN arrActualStepInTurn[2] := 9; END_IF
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[9] >= 100 THEN arrActualStepInTurn[2] := 10; END_IF
										arrMaxPrioReached[3] := FALSE;
											arrMinPrioReached[3] := FALSE;
												arrCTCheckActivePrio[3] := 0;
													uiState := 90;
			ELSE
				IF bSurplusAvailable AND arrActualPrioInTurn[3] < 255 AND uiState = 70 AND arrCTCheckActivePrio[3] = Constants_Energy.diMaxNumberOfElectricHeatingElements THEN 
					arrActualPrioInTurn[3] := arrActualPrioInTurn[3] + 1; arrCTCheckActivePrio[3] := 0; liCounterCkeckDeviceAndPrio := 0; liNrOfNotDoneDevices := 0; 
				END_IF
			END_IF
				//No surplus
				IF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byPriority = arrActualPrioInTurn[3] AND NOT Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsStepSwitched AND NOT 
					Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] > 0 THEN
						arrActualStepInTurn[2] := 1;	
							arrMaxPrioReached[3] := FALSE;
								arrMinPrioReached[3] := FALSE;
									arrCTCheckActivePrio[3] := 0;
										uiState := 90;
				ELSIF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byPriority = arrActualPrioInTurn[3] AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byNumberOfSteps = 0 AND
					Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] > 0 THEN 
						arrActualStepInTurn[2] := 1;	
							arrMaxPrioReached[3] := FALSE;
								arrMinPrioReached[3] := FALSE;
									arrCTCheckActivePrio[3] := 0;
										uiState := 90;
				ELSIF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byPriority = arrActualPrioInTurn[3] AND NOT Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsStepSwitched AND 
					Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] > 0 THEN
						arrActualStepInTurn[2] := 1;	
							arrMaxPrioReached[3] := FALSE;
								arrMinPrioReached[3] := FALSE;
									arrCTCheckActivePrio[3] := 0;
										uiState := 90;	
				ELSIF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byPriority = arrActualPrioInTurn[3] AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsStepSwitched AND 
					Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byNumberOfSteps = 1 AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] > 0 THEN 
						arrActualStepInTurn[2] := 1;	
							arrMaxPrioReached[3] := FALSE;
								arrMinPrioReached[3] := FALSE;
									arrCTCheckActivePrio[3] := 0;
										uiState := 90;
				ELSIF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byPriority = arrActualPrioInTurn[3] AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsStepSwitched AND 
					Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byNumberOfSteps = 2 AND (Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] > 0) THEN
						IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] <= 0 THEN arrActualStepInTurn[2] := 1; ELSE arrActualStepInTurn[2] := 2; END_IF
							arrMaxPrioReached[3] := FALSE;
								arrMinPrioReached[3] := FALSE;
									arrCTCheckActivePrio[3] := 0;
										uiState := 90;
				ELSIF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byPriority = arrActualPrioInTurn[3] AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsStepSwitched AND 
					Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byNumberOfSteps = 3 AND (Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3] > 0) THEN
						IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] <= 0 THEN arrActualStepInTurn[2] := 1; END_IF
						IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] > 0 THEN arrActualStepInTurn[2] := 2; END_IF
						IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3] > 0 THEN arrActualStepInTurn[2] := 3; END_IF
							arrMaxPrioReached[3] := FALSE;
								arrMinPrioReached[3] := FALSE;
									arrCTCheckActivePrio[3] := 0;
										uiState := 90;
				ELSIF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byPriority = arrActualPrioInTurn[3] AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsStepSwitched AND 
					Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byNumberOfSteps = 4 AND 
						(Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3] > 0 OR
							Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[4] > 0) THEN
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] <= 0 THEN arrActualStepInTurn[2] := 1; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] > 0 THEN arrActualStepInTurn[2] := 2; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3] > 0 THEN arrActualStepInTurn[2] := 3; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[4] > 0 THEN arrActualStepInTurn[2] := 4; END_IF
									arrMaxPrioReached[3] := FALSE;
										arrMinPrioReached[3] := FALSE;
											arrCTCheckActivePrio[3] := 0;
												uiState := 90;
				ELSIF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byPriority = arrActualPrioInTurn[3] AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsStepSwitched AND 
					Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byNumberOfSteps = 5 AND 
						(Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3] > 0 OR
							Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[4] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[5] > 0) THEN
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] <= 0 THEN arrActualStepInTurn[2] := 1; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] > 0 THEN arrActualStepInTurn[2] := 2; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3] > 0 THEN arrActualStepInTurn[2] := 3; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[4] > 0 THEN arrActualStepInTurn[2] := 4; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[5] > 0 THEN arrActualStepInTurn[2] := 5; END_IF
									arrMaxPrioReached[3] := FALSE;
										arrMinPrioReached[3] := FALSE;
											arrCTCheckActivePrio[3] := 0;
												uiState := 90;
				ELSIF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byPriority = arrActualPrioInTurn[3] AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsStepSwitched AND 
					Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byNumberOfSteps = 6 AND 
						(Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3] > 0 OR
							Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[4] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[5] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[6] > 0) THEN
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] <= 0 THEN arrActualStepInTurn[2] := 1; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] > 0 THEN arrActualStepInTurn[2] := 2; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3] > 0 THEN arrActualStepInTurn[2] := 3; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[4] > 0 THEN arrActualStepInTurn[2] := 4; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[5] > 0 THEN arrActualStepInTurn[2] := 5; END_IF
								IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[6] > 0 THEN arrActualStepInTurn[2] := 6; END_IF
									arrMaxPrioReached[3] := FALSE;
										arrMinPrioReached[3] := FALSE;
											arrCTCheckActivePrio[3] := 0;
												uiState := 90;
				ELSIF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byPriority = arrActualPrioInTurn[3] AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsStepSwitched AND 
					Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byNumberOfSteps = 7 AND 
						(Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3] > 0 OR
							Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[4] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[5] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[6] > 0 OR
								Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[7] > 0) THEN
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] <= 0 THEN arrActualStepInTurn[2] := 1; END_IF
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] > 0 THEN arrActualStepInTurn[2] := 2; END_IF
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3] > 0 THEN arrActualStepInTurn[2] := 3; END_IF
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[4] > 0 THEN arrActualStepInTurn[2] := 4; END_IF
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[5] > 0 THEN arrActualStepInTurn[2] := 5; END_IF
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[6] > 0 THEN arrActualStepInTurn[2] := 6; END_IF
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[7] > 0 THEN arrActualStepInTurn[2] := 7; END_IF
										arrMaxPrioReached[3] := FALSE;
											arrMinPrioReached[3] := FALSE;
												arrCTCheckActivePrio[3] := 0;
													uiState := 90;
				ELSIF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byPriority = arrActualPrioInTurn[3] AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsStepSwitched AND 
					Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byNumberOfSteps = 8 AND 
						(Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3] > 0 OR
							Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[4] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[5] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[6] > 0 OR
								Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[7] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[8] > 0) THEN
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] <= 0 THEN arrActualStepInTurn[2] := 1; END_IF
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] > 0 THEN arrActualStepInTurn[2] := 2; END_IF
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3] > 0 THEN arrActualStepInTurn[2] := 3; END_IF
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[4] > 0 THEN arrActualStepInTurn[2] := 4; END_IF
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[5] > 0 THEN arrActualStepInTurn[2] := 5; END_IF
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[6] > 0 THEN arrActualStepInTurn[2] := 6; END_IF
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[7] > 0 THEN arrActualStepInTurn[2] := 7; END_IF
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[8] > 0 THEN arrActualStepInTurn[2] := 8; END_IF
										arrMaxPrioReached[3] := FALSE;
											arrMinPrioReached[3] := FALSE;
												arrCTCheckActivePrio[3] := 0;
													uiState := 90;
				ELSIF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byPriority = arrActualPrioInTurn[3] AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsStepSwitched AND 
					Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byNumberOfSteps = 9 AND 
						(Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3] > 0 OR
							Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[4] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[5] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[6] > 0 OR
								Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[7] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[8] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[9] > 0) THEN
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] <= 0 THEN arrActualStepInTurn[2] := 1; END_IF
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] > 0 THEN arrActualStepInTurn[2] := 2; END_IF
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3] > 0 THEN arrActualStepInTurn[2] := 3; END_IF
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[4] > 0 THEN arrActualStepInTurn[2] := 4; END_IF
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[5] > 0 THEN arrActualStepInTurn[2] := 5; END_IF
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[6] > 0 THEN arrActualStepInTurn[2] := 6; END_IF
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[7] > 0 THEN arrActualStepInTurn[2] := 7; END_IF
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[8] > 0 THEN arrActualStepInTurn[2] := 8; END_IF
									IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[9] > 0 THEN arrActualStepInTurn[2] := 9; END_IF
										arrMaxPrioReached[3] := FALSE;
											arrMinPrioReached[3] := FALSE;
												arrCTCheckActivePrio[3] := 0;
													uiState := 90;
				ELSIF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byPriority = arrActualPrioInTurn[3] AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsStepSwitched AND 
					Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].bIsControllable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].byNumberOfSteps = 10 AND 
						(Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[1] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3] > 0 OR
							Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[4] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[5] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[6] > 0 OR
								Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[7] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[8] > 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[9] > 0 OR
									Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[10] > 0) THEN
										IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] <= 0 THEN arrActualStepInTurn[2] := 1; END_IF
										IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[2] > 0 THEN arrActualStepInTurn[2] := 2; END_IF
										IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[3] > 0 THEN arrActualStepInTurn[2] := 3; END_IF
										IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[4] > 0 THEN arrActualStepInTurn[2] := 4; END_IF
										IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[5] > 0 THEN arrActualStepInTurn[2] := 5; END_IF
										IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[6] > 0 THEN arrActualStepInTurn[2] := 6; END_IF
										IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[7] > 0 THEN arrActualStepInTurn[2] := 7; END_IF
										IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[8] > 0 THEN arrActualStepInTurn[2] := 8; END_IF
										IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[9] > 0 THEN arrActualStepInTurn[2] := 9; END_IF
										IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrCTCheckActivePrio[3]].arrTargetPowerEMS[10] > 0 THEN arrActualStepInTurn[2] := 10; END_IF
											arrMaxPrioReached[3] := FALSE;
												arrMinPrioReached[3] := FALSE;
													arrCTCheckActivePrio[3] := 0;
														uiState := 90;
				ELSE
					IF NOT bSurplusAvailable AND arrActualPrioInTurn[3] > 1 AND uiState = 70 AND arrCTCheckActivePrio[3] = Constants_Energy.diMaxNumberOfElectricHeatingElements THEN 
						arrActualPrioInTurn[3] := arrActualPrioInTurn[3] - 1; arrCTCheckActivePrio[3] := 0; liCounterCkeckDeviceAndPrio := 0; liNrOfNotDoneDevices := 0; 
					END_IF
				END_IF
		
		//Go to next step if we are on min prio or on max prio and the target power is just set to the min or to the max value.
		liCounterCkeckDeviceAndPrio := LIMIT(1,liCounterCkeckDeviceAndPrio,Constants_Energy.diMaxNumberOfElectricHeatingElements);
		
			IF arrActualPrioInTurn[3] = 1 AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].byPriority = 1 AND
				(Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[1] <> 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[2] <> 0 OR
					Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[3] <> 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[4] <> 0 OR
						Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[5] <> 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[6] <> 0 OR
							Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[7] <> 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[8] <> 0 OR
								Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[9] <> 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[10] <> 0) THEN 
									liNrOfNotDoneDevices := liNrOfNotDoneDevices + 1; 
			END_IF
				//1 Step
				IF arrActualPrioInTurn[3] = 255 AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].byPriority = 255 AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].byNumberOfSteps = 1 AND 
					Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[1] < 100 THEN 
						liNrOfNotDoneDevices := liNrOfNotDoneDevices + 1; 
				//2 Steps
				ELSIF arrActualPrioInTurn[3] = 255 AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].byPriority = 255 AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].byNumberOfSteps = 2 AND 
					(Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[1] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[2] < 100) THEN 
						liNrOfNotDoneDevices := liNrOfNotDoneDevices + 1; 
				//3 Steps
				ELSIF arrActualPrioInTurn[3] = 255 AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].byPriority = 255 AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].byNumberOfSteps = 3 AND 
					(Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[1] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[2] < 100 OR
						Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[3] < 100) THEN 
							liNrOfNotDoneDevices := liNrOfNotDoneDevices + 1;
				//4 Steps
				ELSIF arrActualPrioInTurn[3] = 255 AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].byPriority = 255 AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].byNumberOfSteps = 4 AND 
					(Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[1] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[2] < 100 OR
						Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[3] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[4] < 100) THEN 
							liNrOfNotDoneDevices := liNrOfNotDoneDevices + 1;  
				//5 Steps
				ELSIF arrActualPrioInTurn[3] = 255 AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].byPriority = 255 AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].byNumberOfSteps = 5 AND 
					(Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[1] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[2] < 100 OR
						Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[3] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[4] < 100 OR
							Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[5] < 100) THEN 
								liNrOfNotDoneDevices := liNrOfNotDoneDevices + 1; 
				//6 Steps
				ELSIF arrActualPrioInTurn[3] = 255 AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].byPriority = 255 AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].byNumberOfSteps = 6 AND 
					(Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[1] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[2] < 100 OR
						Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[3] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[4] < 100 OR
							Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[5] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[6] < 100) THEN 
								liNrOfNotDoneDevices := liNrOfNotDoneDevices + 1; 
				//7 Steps
				ELSIF arrActualPrioInTurn[3] = 255 AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].byPriority = 255 AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].byNumberOfSteps = 7 AND 
					(Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[1] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[2] < 100 OR
						Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[3] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[4] < 100 OR
							Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[5] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[6] < 100 OR
								Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[7] < 100) THEN 
									liNrOfNotDoneDevices := liNrOfNotDoneDevices + 1; 
				//8 Steps
				ELSIF arrActualPrioInTurn[3] = 255 AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].byPriority = 255 AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].byNumberOfSteps = 8 AND 
					(Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[1] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[2] < 100 OR
						Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[3] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[4] < 100 OR
							Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[5] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[6] < 100 OR
								Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[7] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[8] < 100) THEN 
									liNrOfNotDoneDevices := liNrOfNotDoneDevices + 1; 
				//9 Steps
				ELSIF arrActualPrioInTurn[3] = 255 AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].byPriority = 255 AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].byNumberOfSteps = 9 AND 
					(Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[1] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[2] < 100 OR
						Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[3] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[4] < 100 OR
							Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[5] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[6] < 100 OR
								Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[7] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[8] < 100 OR
									Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[9] < 100) THEN 
										liNrOfNotDoneDevices := liNrOfNotDoneDevices + 1; 
				//10 Steps
				ELSIF arrActualPrioInTurn[3] = 255 AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].byPriority = 255 AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].byNumberOfSteps = 10 AND 
					(Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[1] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[2] < 100 OR
						Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[3] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[4] < 100 OR
							Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[5] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[6] < 100 OR
								Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[7] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[8] < 100 OR
									Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[9] < 100 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liCounterCkeckDeviceAndPrio].arrTargetPowerEMS[10] < 100) THEN 
										liNrOfNotDoneDevices := liNrOfNotDoneDevices + 1; 
				END_IF
		
		IF arrActualPrioInTurn[3] = 1 AND uiState = 70 AND liNrOfNotDoneDevices = 0 AND arrCTCheckActivePrio[3] = Constants_Energy.diMaxNumberOfElectricHeatingElements AND liCounterCkeckDeviceAndPrio = Constants_Energy.diMaxNumberOfElectricHeatingElements THEN 
			arrMinPrioReached[3] := TRUE; arrMaxPrioReached[3] := FALSE; liNrOfNotDoneDevices := 0; uiState := 90; arrCTCheckActivePrio[3] := 0; liCounterCkeckDeviceAndPrio := 0; 
		END_IF
		IF arrActualPrioInTurn[3] = 255 AND uiState = 70 AND liNrOfNotDoneDevices = 0 AND arrCTCheckActivePrio[3] = Constants_Energy.diMaxNumberOfElectricHeatingElements AND liCounterCkeckDeviceAndPrio = Constants_Energy.diMaxNumberOfElectricHeatingElements THEN 
			arrMaxPrioReached[3] := TRUE; arrMinPrioReached[3] := FALSE; liNrOfNotDoneDevices := 0; uiState := 90; arrCTCheckActivePrio[3] := 0; liCounterCkeckDeviceAndPrio := 0; 
		END_IF
		
		//Timout, go to next step
		IF timTimeout.Q AND uiState = 70 THEN uiState := 90; END_IF
		
	90: //Check the priority for the big consumer to controll it
		uiState_CP := uiState;
	
		//First check if we have min 1 of this Device Type. If not, complete this Device Type and go to the next step
		//Check also the bigest Priority of this Device Type
		diNumberOfDevicesFromEachType := 0; bySearchBigestPrio := 0;
		FOR liLPCheckDeviceAndPrio := 1 TO Constants_Energy.diMaxNumberOfOtherBigConsumers BY 1 DO
			IF Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPCheckDeviceAndPrio].byPriority <> 0 THEN diNumberOfDevicesFromEachType := diNumberOfDevicesFromEachType + 1; END_IF
				IF Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPCheckDeviceAndPrio].byPriority > bySearchBigestPrio THEN bySearchBigestPrio := Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPCheckDeviceAndPrio].byPriority; END_IF   
		END_FOR 
			IF bSurplusAvailable AND arrActualPrioInTurn[4] > bySearchBigestPrio AND uiState = 90 THEN arrActualPrioInTurn[4] := 255; END_IF
				IF NOT bSurplusAvailable AND arrActualPrioInTurn[4] > bySearchBigestPrio AND uiState = 90 THEN arrActualPrioInTurn[4] := bySearchBigestPrio; END_IF
		
			IF bSurplusAvailable AND diNumberOfDevicesFromEachType = 0 THEN arrActualPrioInTurn[4] := 255; END_IF
				IF NOT bSurplusAvailable AND diNumberOfDevicesFromEachType = 0 THEN arrActualPrioInTurn[4] := 1; END_IF
		
		//Count up each Device
		arrCTCheckActivePrio[4] := arrCTCheckActivePrio[4] + 1;
			arrCTCheckActivePrio[4] := LIMIT(1,arrCTCheckActivePrio[4],Constants_Energy.diMaxNumberOfOtherBigConsumers);
		
			//Surplus
			IF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,arrCTCheckActivePrio[4]].byPriority = arrActualPrioInTurn[4] AND Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,arrCTCheckActivePrio[4]].rTargetPowerEMS < 100 THEN
				arrMaxPrioReached[4] := FALSE;
					arrMinPrioReached[4] := FALSE;
						arrCTCheckActivePrio[4] := 0;
							uiState := 109; 
			ELSE
				IF bSurplusAvailable AND arrActualPrioInTurn[4] < 255 AND uiState = 90 AND arrCTCheckActivePrio[4] = Constants_Energy.diMaxNumberOfOtherBigConsumers THEN arrActualPrioInTurn[4] := arrActualPrioInTurn[4] + 1; arrCTCheckActivePrio[4] := 0; END_IF
			END_IF
				//No surplus
				IF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,arrCTCheckActivePrio[4]].byPriority = arrActualPrioInTurn[4] AND Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,arrCTCheckActivePrio[4]].rTargetPowerEMS > 0 THEN
					arrMaxPrioReached[4] := FALSE;
						arrMinPrioReached[4] := FALSE;
							arrCTCheckActivePrio[4] := 0;
								uiState := 109;
				ELSE
					IF NOT bSurplusAvailable AND arrActualPrioInTurn[4] > 1 AND uiState = 90 AND arrCTCheckActivePrio[4] = Constants_Energy.diMaxNumberOfOtherBigConsumers THEN arrActualPrioInTurn[4] := arrActualPrioInTurn[4] - 1; arrCTCheckActivePrio[4] := 0; END_IF
				END_IF
		
		
		//Go to next step if we are on min prio or on max prio and the target power is just set to the min or to the max value.
		liNrOfNotDoneDevices := 0;
			FOR liLPCheckDeviceAndPrio := 1 TO Constants_Energy.diMaxNumberOfOtherBigConsumers BY 1 DO
				IF arrActualPrioInTurn[4] = 1 AND Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPCheckDeviceAndPrio].rTargetPowerEMS <> 0 AND Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPCheckDeviceAndPrio].byPriority = 1 THEN
					liNrOfNotDoneDevices := liNrOfNotDoneDevices + 1;	
				END_IF
					IF arrActualPrioInTurn[4] = 255 AND Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPCheckDeviceAndPrio].rTargetPowerEMS < 100 AND Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPCheckDeviceAndPrio].byPriority = 255 THEN
						liNrOfNotDoneDevices := liNrOfNotDoneDevices + 1;	
					END_IF
			END_FOR	
		
		IF arrActualPrioInTurn[4] = 1 AND uiState = 90 AND liNrOfNotDoneDevices = 0 AND arrCTCheckActivePrio[4] = Constants_Energy.diMaxNumberOfOtherBigConsumers THEN 
			arrMinPrioReached[4] := TRUE; arrMaxPrioReached[4] := FALSE; liNrOfNotDoneDevices := 0; uiState := 109; arrCTCheckActivePrio[4] := 0; 
		END_IF
		IF arrActualPrioInTurn[4] = 255 AND uiState = 90 AND liNrOfNotDoneDevices = 0 AND arrCTCheckActivePrio[4] = Constants_Energy.diMaxNumberOfOtherBigConsumers THEN 
			arrMaxPrioReached[4] := TRUE; arrMinPrioReached[4] := FALSE; liNrOfNotDoneDevices := 0; uiState := 109; arrCTCheckActivePrio[4] := 0; 
		END_IF
		
		//Timout, go to next step
		IF timTimeout.Q AND uiState = 90 THEN uiState := 109; END_IF
		
	109://Check if in Load management mode or Peak shaving mode some electric Fuse Line use to much power when we have here surplus
		uiState_CP := uiState;

		//Count up each Device
		arrCTCheckActivePrio[5] := arrCTCheckActivePrio[5] + 1;
			arrCTCheckActivePrio[5] := LIMIT(1,arrCTCheckActivePrio[5],Constants_Energy.diMaxNumberOfElectricChargingStations);
		
		IF ((eOperationMode = E_OperatingMode_EMS.eLoadManagement OR eOperationMode = E_OperatingMode_EMS.ePeakLoadCapping) AND bSurplusAvailable AND stSetupEMS.bEnableMainFuseFunc) THEN
			IF Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,arrCTCheckActivePrio[5]].byPriority = arrActualPrioInTurn[5] AND
				Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,arrCTCheckActivePrio[5]].byElectricFuseLine > 0 AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,arrCTCheckActivePrio[5]].byElectricFuseLine <= 30 THEN
					//This ECS on this Fuse Line use to much power. So dont give here more power. Go to next priority
					IF arrNoPowerForECS[Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,arrCTCheckActivePrio[5]].byElectricFuseLine] THEN
						//Go to next prio that we can go forward with the other Devices with same priority. Controlling for ECS see down on the Part on wich we limit the charging station about the electric Fuse Lines
						IF arrActualPrioInTurn[5] < 255 THEN arrActualPrioInTurn[5] := arrActualPrioInTurn[5] + 1; END_IF
							uiState := 110;
								arrCTCheckActivePrio[5] := 0;	
					END_IF
			END_IF 
		ELSE
			uiState := 110;
				arrCTCheckActivePrio[5] := 0;
		END_IF
		
		//Go to next step if wa have checked every ECS without resluts
		IF arrCTCheckActivePrio[5] >= Constants_Energy.diMaxNumberOfElectricChargingStations AND uiState = 109 THEN
			uiState := 110;
				arrCTCheckActivePrio[5] := 0;
		END_IF 
	 	
		//Timout, go to next step
		IF timTimeout.Q AND uiState = 109 THEN uiState := 110; arrCTCheckActivePrio[5] := 0; END_IF
		
	110: //Check the priority for the electric charging stations to controll it
		uiState_CP := uiState;
	
		//First check if we have min 1 of this Device Type. If not, complete this Device Type and go to the next step
		//Check also the bigest Priority of this Device Type
		diNumberOfDevicesFromEachType := 0; bySearchBigestPrio := 0;
		FOR liLPCheckDeviceAndPrio := 1 TO Constants_Energy.diMaxNumberOfElectricChargingStations BY 1 DO
			IF Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCheckDeviceAndPrio].byPriority <> 0 THEN diNumberOfDevicesFromEachType := diNumberOfDevicesFromEachType + 1; END_IF
				IF Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCheckDeviceAndPrio].byPriority > bySearchBigestPrio THEN bySearchBigestPrio := Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCheckDeviceAndPrio].byPriority; END_IF   
		END_FOR 
			IF bSurplusAvailable AND arrActualPrioInTurn[5] > bySearchBigestPrio AND uiState = 110 THEN arrActualPrioInTurn[5] := 255; END_IF
				IF NOT bSurplusAvailable AND arrActualPrioInTurn[5] > bySearchBigestPrio AND uiState = 110 THEN arrActualPrioInTurn[5] := bySearchBigestPrio; END_IF
		
			IF bSurplusAvailable AND diNumberOfDevicesFromEachType = 0 THEN arrActualPrioInTurn[5] := 255; END_IF
				IF NOT bSurplusAvailable AND diNumberOfDevicesFromEachType = 0 THEN arrActualPrioInTurn[5] := 1; END_IF
		
		//Count up each Device
		arrCTCheckActivePrio[5] := arrCTCheckActivePrio[5] + 1;
			arrCTCheckActivePrio[5] := LIMIT(1,arrCTCheckActivePrio[5],Constants_Energy.diMaxNumberOfElectricChargingStations);
		
			//Surplus
			IF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,arrCTCheckActivePrio[5]].byPriority = arrActualPrioInTurn[5] AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,arrCTCheckActivePrio[5]].rTargetPowerEMS < 100 THEN
				arrMaxPrioReached[5] := FALSE;
					arrMinPrioReached[5] := FALSE;
						arrCTCheckActivePrio[5] := 0;
							uiState := 130;
			ELSE
				IF bSurplusAvailable AND arrActualPrioInTurn[5] < 255 AND uiState = 110 AND arrCTCheckActivePrio[5] = Constants_Energy.diMaxNumberOfElectricChargingStations THEN arrActualPrioInTurn[5] := arrActualPrioInTurn[5] + 1; arrCTCheckActivePrio[5] := 0; END_IF
			END_IF
				//No surplus
				IF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,arrCTCheckActivePrio[5]].byPriority = arrActualPrioInTurn[5] AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,arrCTCheckActivePrio[5]].rTargetPowerEMS > 0 THEN
					arrMaxPrioReached[5] := FALSE;
						arrMinPrioReached[5] := FALSE;
							arrCTCheckActivePrio[5] := 0;
								uiState := 130;
				ELSE
					IF NOT bSurplusAvailable AND arrActualPrioInTurn[5] > 1 AND uiState = 110 AND arrCTCheckActivePrio[5] = Constants_Energy.diMaxNumberOfElectricChargingStations THEN arrActualPrioInTurn[5] := arrActualPrioInTurn[5] - 1; arrCTCheckActivePrio[5] := 0; END_IF
				END_IF
		
		//Go to next step if we are on min prio or on max prio and the target power is just set to the min or to the max value.
		liNrOfNotDoneDevices := 0;
			FOR liLPCheckDeviceAndPrio := 1 TO Constants_Energy.diMaxNumberOfElectricChargingStations BY 1 DO
				IF arrActualPrioInTurn[5] = 1 AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCheckDeviceAndPrio].rTargetPowerEMS <> 0 AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCheckDeviceAndPrio].byPriority = 1 THEN
					liNrOfNotDoneDevices := liNrOfNotDoneDevices + 1;	
				END_IF
					IF arrActualPrioInTurn[5] = 255 AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCheckDeviceAndPrio].rTargetPowerEMS < 100 AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCheckDeviceAndPrio].byPriority = 255 THEN
						liNrOfNotDoneDevices := liNrOfNotDoneDevices + 1;	
					END_IF
			END_FOR
		
		IF arrActualPrioInTurn[5] = 1 AND uiState = 110 AND liNrOfNotDoneDevices = 0 AND arrCTCheckActivePrio[5] = Constants_Energy.diMaxNumberOfElectricChargingStations THEN 
			arrMinPrioReached[5] := TRUE; arrMaxPrioReached[5] := FALSE; liNrOfNotDoneDevices := 0; uiState := 130; arrCTCheckActivePrio[5] := 0; 
		END_IF
		IF arrActualPrioInTurn[5] = 255 AND uiState = 110 AND liNrOfNotDoneDevices = 0 AND arrCTCheckActivePrio[5] = Constants_Energy.diMaxNumberOfElectricChargingStations THEN 
			arrMaxPrioReached[5] := TRUE; arrMinPrioReached[5] := FALSE; liNrOfNotDoneDevices := 0; uiState := 130; arrCTCheckActivePrio[5] := 0; 
		END_IF	
		
		//Timout, go to next step
		IF timTimeout.Q AND uiState = 110 THEN uiState := 130; END_IF
		
	130: //Search the smallest/biggest common priority and the number of devices with the same priority  
		IF bSurplusAvailable THEN bySmGrActiveCommonPrio := 255; END_IF
		IF NOT bSurplusAvailable THEN bySmGrActiveCommonPrio := 1; END_IF
	
		FOR byLPSmActiveCommonPrio := 1 TO 5 BY 1 DO
			IF bSurplusAvailable AND arrActualPrioInTurn[byLPSmActiveCommonPrio] < bySmGrActiveCommonPrio THEN bySmGrActiveCommonPrio := arrActualPrioInTurn[byLPSmActiveCommonPrio]; END_IF 
			IF NOT bSurplusAvailable AND arrActualPrioInTurn[byLPSmActiveCommonPrio] > bySmGrActiveCommonPrio THEN bySmGrActiveCommonPrio := arrActualPrioInTurn[byLPSmActiveCommonPrio]; END_IF 
		END_FOR
		
		//Back to the start when complete power is awarded, all power is set on 0 or we haven't common priority 	
		IF (arrMaxPrioReached[1] AND arrMaxPrioReached[2] AND arrMaxPrioReached[3] AND arrMaxPrioReached[4] AND arrMaxPrioReached[5]) OR
			(arrMinPrioReached[1] AND arrMinPrioReached[2] AND arrMinPrioReached[3] AND arrMinPrioReached[4] AND arrMinPrioReached[5]) THEN
				uiState := 10;
		ELSE
				uiState := 131;
		END_IF
		
	131: //Ckeck if the Batterys are full or not when we have no surplus. Thus the problem can be avoided if the battery FB regulates the power internally to 0, but the EMS still sends power to the inverter.
		 //Because otherwise it always takes too long when we have a small consumption and the battery must first be regulated to 0% in the GVL, although you are already full and you can therefore no longer be regulated back.
		 
		IF eOperationMode = E_OperatingMode_EMS.eSelfConsumption THEN 
			FOR liLPDataBatteryInverter := 1 TO Constants_Energy.diMaxNumberOfBatteryInverters BY 1 DO
				IF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPDataBatteryInverter].byPriority = bySmGrActiveCommonPrio AND 
					arrTimBatterysAreFull[liLPDataBatteryInverter].Q THEN
						Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPDataBatteryInverter].rTargetPowerEMS := 0;
				END_IF	  
			END_FOR 
	
			//When we have a surplus again and the battery is full, we control it again with - 99.99%, so that the following devices do not have to wait too long to be controlled. 	
			//It must be set to 99.99, otherwise an error would occur in the next step.
			FOR liLPDataBatteryInverter := 1 TO Constants_Energy.diMaxNumberOfBatteryInverters BY 1 DO
				IF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPDataBatteryInverter].byPriority = bySmGrActiveCommonPrio AND 
					arrTimBatterysAreFull[liLPDataBatteryInverter].Q THEN
						Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPDataBatteryInverter].rTargetPowerEMS := - 99.99;
				END_IF	  
			END_FOR
		END_IF
		
		//Go to the next Step
		uiState := 150;
		
	150: //Calcualte the % power from each device with the same priority
		lrMaxPowerDevicesWithActualPrio := 0;
			bMissingPowerData := FALSE;
		
		//Batterys are only a "normal" Device, when the self consumption mode is active.
		IF eOperationMode = E_OperatingMode_EMS.eSelfConsumption THEN 
			//Batteryinverters
			FOR liLPCheckMaxPower := 1 TO Constants_Energy.diMaxNumberOfBatteryInverters BY 1 DO
				IF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPCheckMaxPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPCheckMaxPower].rTargetPowerEMS > -100 AND NOT Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPCheckMaxPower].bWorkOnIslandMode THEN lrMaxPowerDevicesWithActualPrio := lrMaxPowerDevicesWithActualPrio + Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPCheckMaxPower].rMaxChargePower; END_IF
				IF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPCheckMaxPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPCheckMaxPower].rTargetPowerEMS < 0 AND NOT Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPCheckMaxPower].bWorkOnIslandMode THEN lrMaxPowerDevicesWithActualPrio := lrMaxPowerDevicesWithActualPrio + Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPCheckMaxPower].rMaxChargePower; END_IF 
			END_FOR
		END_IF
			//Heating pumps
			IF arrActualStepInTurn[1] >= 1 AND arrActualStepInTurn[1] <= 2 THEN
				FOR liLPCheckMaxPower := 1 TO Constants_Energy.diMaxNumberOfHeatingPumps BY 1 DO
					IF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPCheckMaxPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPCheckMaxPower].arrTargetPowerEMS[arrActualStepInTurn[1]] < 100 THEN lrMaxPowerDevicesWithActualPrio := lrMaxPowerDevicesWithActualPrio + Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPCheckMaxPower].arrMaxPower[arrActualStepInTurn[1]]; END_IF
					IF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPCheckMaxPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPCheckMaxPower].arrTargetPowerEMS[arrActualStepInTurn[1]] > 0 THEN lrMaxPowerDevicesWithActualPrio := lrMaxPowerDevicesWithActualPrio + Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPCheckMaxPower].arrMaxPower[arrActualStepInTurn[1]]; END_IF
				END_FOR
			END_IF
				//Electric heating elements
				IF arrActualStepInTurn[2] >= 1 AND arrActualStepInTurn[2] <= 10 THEN
					FOR liLPCheckMaxPower := 1 TO Constants_Energy.diMaxNumberOfElectricHeatingElements BY 1 DO
						IF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPCheckMaxPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPCheckMaxPower].arrTargetPowerEMS[arrActualStepInTurn[2]] < 100 THEN lrMaxPowerDevicesWithActualPrio := lrMaxPowerDevicesWithActualPrio + Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPCheckMaxPower].arrMaxPower[arrActualStepInTurn[2]]; END_IF 
						IF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPCheckMaxPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPCheckMaxPower].arrTargetPowerEMS[arrActualStepInTurn[2]] > 0 THEN lrMaxPowerDevicesWithActualPrio := lrMaxPowerDevicesWithActualPrio + Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPCheckMaxPower].arrMaxPower[arrActualStepInTurn[2]]; END_IF 
					END_FOR	
				END_IF
					//Other big consumer
					FOR liLPCheckMaxPower := 1 TO Constants_Energy.diMaxNumberOfOtherBigConsumers BY 1 DO
						IF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPCheckMaxPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPCheckMaxPower].rTargetPowerEMS < 100 THEN lrMaxPowerDevicesWithActualPrio := lrMaxPowerDevicesWithActualPrio + Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPCheckMaxPower].rMaxPower; END_IF
						IF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPCheckMaxPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPCheckMaxPower].rTargetPowerEMS > 0 THEN lrMaxPowerDevicesWithActualPrio := lrMaxPowerDevicesWithActualPrio + Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPCheckMaxPower].rMaxPower; END_IF
					END_FOR
						//Electric charging stations
						FOR liLPCheckMaxPower := 1 TO Constants_Energy.diMaxNumberOfElectricChargingStations BY 1 DO
							IF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCheckMaxPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCheckMaxPower].rTargetPowerEMS < 100 THEN lrMaxPowerDevicesWithActualPrio := lrMaxPowerDevicesWithActualPrio + Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCheckMaxPower].rMaxPower; END_IF
							IF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCheckMaxPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCheckMaxPower].rTargetPowerEMS > 0 THEN lrMaxPowerDevicesWithActualPrio := lrMaxPowerDevicesWithActualPrio + Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCheckMaxPower].rMaxPower; END_IF 
						END_FOR
		
		//Check is somthing has changed at the actual priority or at the actual step 
		//Priority or step now is higher as before
		IF (bSurplusAvailable AND MEMCMP(ADR(bySmGrActiveCommonPrio),ADR(bySmGrActiveCommonPrio_CP),SIZEOF(bySmGrActiveCommonPrio_CP)) <> 0) OR (bSurplusAvailable AND MEMCMP(ADR(arrActualStepInTurn),ADR(arrActualStepInTurn_CP),SIZEOF(arrActualStepInTurn_CP)) <> 0) THEN
			bySmGrActiveCommonPrio_CP := bySmGrActiveCommonPrio;
				arrActualStepInTurn_CP := arrActualStepInTurn;
					bStepWasOn100 := FALSE;		
		END_IF
			//Priority or step now is lower as before
			IF (NOT bSurplusAvailable AND MEMCMP(ADR(bySmGrActiveCommonPrio),ADR(bySmGrActiveCommonPrio_CP),SIZEOF(bySmGrActiveCommonPrio_CP)) <> 0) OR (NOT bSurplusAvailable AND MEMCMP(ADR(arrActualStepInTurn),ADR(arrActualStepInTurn_CP),SIZEOF(arrActualStepInTurn_CP)) <> 0) THEN
				bySmGrActiveCommonPrio_CP := bySmGrActiveCommonPrio;
					arrActualStepInTurn_CP := arrActualStepInTurn;
						bStepWasOn100 := TRUE;			
			END_IF						
						
		IF lrMaxPowerDevicesWithActualPrio > 0 THEN
			//Calcualte the power for the controllable devices
			IF bSurplusAvailable THEN rValuePercentToControllableDevices := LREAL_TO_REAL((100 * (lrActualSurplusOrConsumption * - 1)) / lrMaxPowerDevicesWithActualPrio); END_IF
  			IF NOT bSurplusAvailable THEN rValuePercentToControllableDevices := LREAL_TO_REAL((100 * lrActualSurplusOrConsumption) / lrMaxPowerDevicesWithActualPrio); END_IF
			//Calcualte the power for the On/Off or step switched devices
			IF bSurplusAvailable THEN rValuePercentToStepSwitchedDevices := LREAL_TO_REAL((100 * (lrActualSurplusOrConsumption * - 1)) / lrMaxPowerDevicesWithActualPrio); END_IF
			IF NOT bSurplusAvailable THEN rValuePercentToStepSwitchedDevices := (100 - LREAL_TO_REAL((100 * lrActualSurplusOrConsumption) / lrMaxPowerDevicesWithActualPrio)); END_IF
				IF bSurplusAvailable AND rValuePercentToStepSwitchedDevices >= 100 THEN bStepWasOn100 := TRUE; END_IF
				IF NOT bSurplusAvailable AND rValuePercentToStepSwitchedDevices < Constants_Energy.byTargetOffPowerForOnOffDevices THEN bStepWasOn100 := FALSE; END_IF
					IF bStepWasOn100 THEN rValuePercentToStepSwitchedDevices := 100; END_IF
					IF NOT bStepWasOn100 THEN rValuePercentToStepSwitchedDevices := 0; END_IF		
		ELSE
			//Power inputs from the setups of the devices are missing. Set the target power automatically to 0
			bMissingPowerData := TRUE;
			IF bSurplusAvailable THEN
				rValuePercentToControllableDevices := - 100;
				rValuePercentToStepSwitchedDevices := 0;
			END_IF
				IF NOT bSurplusAvailable THEN
					rValuePercentToControllableDevices := 100;
					rValuePercentToStepSwitchedDevices := 0;
				END_IF
		END_IF
		
		//If we have more surplus than the maximum power of the devices is, then we can set the target power directly to 100%
		IF bSurplusAvailable AND (lrActualSurplusOrConsumption * - 1) >= lrMaxPowerDevicesWithActualPrio AND NOT bMissingPowerData THEN rValuePercentToControllableDevices := 100; END_IF
		IF bSurplusAvailable AND (lrActualSurplusOrConsumption * - 1) >= lrMaxPowerDevicesWithActualPrio AND NOT bMissingPowerData THEN rValuePercentToStepSwitchedDevices := 100; bStepWasOn100 := TRUE; END_IF
		
		//If more power is consumed than the maximum power of the devices, 0% power can be commanded (for controllable devices 100% as it is deducted).
		IF NOT bSurplusAvailable AND lrActualSurplusOrConsumption >= lrMaxPowerDevicesWithActualPrio AND NOT bMissingPowerData THEN rValuePercentToControllableDevices := 100; END_IF
		IF NOT bSurplusAvailable AND lrActualSurplusOrConsumption >= lrMaxPowerDevicesWithActualPrio AND NOT bMissingPowerData THEN rValuePercentToStepSwitchedDevices := 0; bStepWasOn100 := FALSE; END_IF
		
		//Check the limits
		rValuePercentToControllableDevices := LIMIT(0,rValuePercentToControllableDevices,100);
			rValuePercentToStepSwitchedDevices := LIMIT(0,rValuePercentToStepSwitchedDevices,100);
				
		uiState := 170;
		
	170: //Set the target power to each device
		//Batterys or battery inverters
		//Batterys are only a "normal" Device, when the self consumption mode is active.
		IF eOperationMode = E_OperatingMode_EMS.eSelfConsumption THEN 
			FOR liLPSetPercentPower := 1 TO Constants_Energy.diMaxNumberOfBatteryInverters BY 1 DO
				IF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPSetPercentPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS > -100 THEN Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS := Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS - rValuePercentToControllableDevices; END_IF
				IF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS < -100 THEN Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS := -100; END_IF 
					IF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPSetPercentPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS < 0 THEN Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS := Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS + rValuePercentToControllableDevices; END_IF
					IF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS > 0 THEN Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS := 0; END_IF
						//Power Data is Missing
						IF bMissingPowerData AND Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPSetPercentPower].byPriority = bySmGrActiveCommonPrio THEN 
							Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS := 0;	
						END_IF 
							//Limit
							Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS := LIMIT(-100,Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS,100);	
			END_FOR
		END_IF
			//Heating pumps
			IF arrActualStepInTurn[1] >= 1 AND arrActualStepInTurn[1] <= 2 THEN
				FOR liLPSetPercentPower := 1 TO Constants_Energy.diMaxNumberOfHeatingPumps BY 1 DO
					//On/Off
					IF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[1]] < 100 AND NOT 
						Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].bIsControllable AND NOT Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].bIsStepSwitched THEN
							Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[1]] := rValuePercentToStepSwitchedDevices; 
					END_IF
					//Controllable linear
					IF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[1]] < 100 AND 
						Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].bIsControllable AND NOT Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].bIsStepSwitched THEN
							Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[1]] := Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[1]] + rValuePercentToControllableDevices; 
					END_IF
					//Step switched
					IF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[1]] < 100 AND 
						Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].bIsControllable AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].bIsStepSwitched THEN
							Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[1]] := rValuePercentToStepSwitchedDevices; 
					END_IF
					IF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[1]] > 100 THEN Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[1]] := 100; END_IF 
						//On/Off
						IF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[1]] > 0 AND NOT 
							Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].bIsControllable AND NOT Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].bIsStepSwitched THEN
								Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[1]] := rValuePercentToStepSwitchedDevices; 
						END_IF
						//Controllable linear
						IF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[1]] > 0 AND 
							Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].bIsControllable AND NOT Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].bIsStepSwitched THEN
								Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[1]] := Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[1]] - rValuePercentToControllableDevices; 
						END_IF
						//Step switched
						IF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[1]] > 0 AND 
							Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].bIsControllable AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].bIsStepSwitched THEN
								Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[1]] := rValuePercentToStepSwitchedDevices; 
						END_IF
						IF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[1]] < 0 THEN Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[1]] := 0; END_IF
							//Limit
							Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[1]] := LIMIT(0,Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[1]],100);
				END_FOR
			END_IF
				//electric heating element
				IF arrActualStepInTurn[2] >= 1 AND arrActualStepInTurn[2] <= 10 THEN
					FOR liLPSetPercentPower := 1 TO Constants_Energy.diMaxNumberOfElectricHeatingElements BY 1 DO
						//On/Off
						IF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[2]] < 100 AND NOT
							Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].bIsControllable AND NOT Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].bIsStepSwitched THEN
								Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[2]] := rValuePercentToStepSwitchedDevices;
						END_IF
						//Controllable linear
						IF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[2]] < 100 AND
							Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].bIsControllable AND NOT Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].bIsStepSwitched THEN
								Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[2]] := Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[2]] + rValuePercentToControllableDevices;
						END_IF
						//Step switched
						IF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[2]] < 100 AND
							Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].bIsControllable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].bIsStepSwitched THEN
								Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[2]] := rValuePercentToStepSwitchedDevices;
						END_IF
						IF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[2]] > 100 THEN Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[2]] := 100; END_IF
							//On/Off
							IF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[2]] > 0 AND NOT
								Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].bIsControllable AND NOT Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].bIsStepSwitched THEN
									Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[2]] := rValuePercentToStepSwitchedDevices;
							END_IF
							//Controllable linear
							IF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[2]] > 0 AND
								Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].bIsControllable AND NOT Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].bIsStepSwitched THEN
									Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[2]] := Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[2]] - rValuePercentToControllableDevices;
							END_IF
							//Step switched
							IF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[2]] > 0 AND
								Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].bIsControllable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].bIsStepSwitched THEN
									Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[2]] := rValuePercentToStepSwitchedDevices;
							END_IF	
							IF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[2]] < 0 THEN Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[2]] := 0; END_IF 
								//Limit
								Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[2]] := LIMIT(0,Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,liLPSetPercentPower].arrTargetPowerEMS[arrActualStepInTurn[2]],100);
					END_FOR			
				END_IF
					//Other big consumer
					FOR liLPSetPercentPower := 1 TO Constants_Energy.diMaxNumberOfOtherBigConsumers BY 1 DO
						//On/Off
						IF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPSetPercentPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS < 100 AND NOT
							Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPSetPercentPower].bIsControllable THEN Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS := rValuePercentToStepSwitchedDevices; 
						END_IF
						//Controllable linear
						IF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPSetPercentPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS < 100 AND
							Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPSetPercentPower].bIsControllable THEN Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS := Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS + rValuePercentToControllableDevices;
						END_IF
						IF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS > 100 THEN Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS := 100; END_IF
							//On/Off
							IF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPSetPercentPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS > 0 AND NOT
								Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPSetPercentPower].bIsControllable THEN Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS := rValuePercentToStepSwitchedDevices; 
							END_IF
							//Controllable linear
							IF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPSetPercentPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS > 0 AND
								Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPSetPercentPower].bIsControllable THEN Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS := Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS - rValuePercentToControllableDevices;
							END_IF
							IF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS < 0 THEN Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS := 0; END_IF
								//Limit
								Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS := LIMIT(0,Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS,100);
					END_FOR
						//Electric charging stations
						FOR liLPSetPercentPower := 1 TO Constants_Energy.diMaxNumberOfElectricChargingStations BY 1 DO
							//On/Off
							IF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPSetPercentPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS < 100 AND NOT 
								Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPSetPercentPower].bIsControllable AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPSetPercentPower].byElectricFuseLine <= 30 THEN
									//No power on ECS because on the Electric Fuse Line we take to much Power on witch the ECS is conected
									IF NOT arrNoPowerForECS[Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPSetPercentPower].byElectricFuseLine] THEN  
										Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS := rValuePercentToStepSwitchedDevices;	
									END_IF	
							END_IF
							//Controllable linear
							IF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPSetPercentPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS < 100 AND 
								Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPSetPercentPower].bIsControllable AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPSetPercentPower].byElectricFuseLine <= 30 THEN
									//No power on ECS because on the Electric Fuse Line we take to much Power on witch the ECS is conected
									IF NOT arrNoPowerForECS[Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPSetPercentPower].byElectricFuseLine] THEN 
										Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS := Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS + rValuePercentToControllableDevices;		
									END_IF
							END_IF
							IF bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS > 100 THEN Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS := 100; END_IF
								//On/Off
								IF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPSetPercentPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS > 0 AND NOT 
									Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPSetPercentPower].bIsControllable THEN 
										Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS := rValuePercentToStepSwitchedDevices;		
								END_IF
								//Controllable linear
								IF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPSetPercentPower].byPriority = bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS > 0 AND 
									Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPSetPercentPower].bIsControllable THEN 
										Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS := Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS - rValuePercentToControllableDevices;		
								END_IF
								IF NOT bSurplusAvailable AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS < 0 THEN Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS := 0; END_IF	
									//Limit
									Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS := LIMIT(0,Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPSetPercentPower].rTargetPowerEMS,100);
						END_FOR 
		uiState := 10;
END_CASE

(*-------------------------------------------------------------------------------------Correction Charging stations regarding max fuse power for each electric Fuse Line---------------------------------------------------------------------------------------------------------------*)

bSEnableMainFuseFunc := stSetupEMS.bEnableMainFuseFunc;

//Check the Data of all Electric Meters
//Copy the Data from the Input Structure to a internal Array to handel it
MEMCPY(ADR(arrNrOfEM_IN_ECS),ADR(stNrOfEM_IN_ECS),SIZEOF(stNrOfEM_IN_ECS));
MEMCPY(ADR(arrSizeMainFuseCS),ADR(stSizeMainFuseCS),SIZEOF(stSizeMainFuseCS));

//Reset the Values in the Arrays
FOR byLPDataEMECS := 1 TO 30 BY 1 DO
	arrEMECS_State[byLPDataEMECS] := 0;
		arrEMECS_ErrorWarning[byLPDataEMECS] := 0;
			arrEMECS_Power[byLPDataEMECS] := 0;
END_FOR
	FOR byLPDataEMECS := 1 TO 30 BY 1 DO
		//EM is Enabled for the Limit Logic for ECS
		IF arrNrOfEM_IN_ECS[byLPDataEMECS] <> 0 AND arrSizeMainFuseCS[byLPDataEMECS] > 0 AND Lynus_Standards.GVL_Energy.stDataElectricMeters[arrNrOfEM_IN_ECS[byLPDataEMECS]].bEnabled THEN arrEMECS_State[byLPDataEMECS] := 1; END_IF
		//EM is Dissabled or not Ready for the Limit Logic for ECS
		IF arrNrOfEM_IN_ECS[byLPDataEMECS] <> 0 AND NOT Lynus_Standards.GVL_Energy.stDataElectricMeters[arrNrOfEM_IN_ECS[byLPDataEMECS]].bEnabled THEN arrEMECS_State[byLPDataEMECS] := 2; END_IF
		IF arrSizeMainFuseCS[byLPDataEMECS] > 0 AND NOT Lynus_Standards.GVL_Energy.stDataElectricMeters[arrNrOfEM_IN_ECS[byLPDataEMECS]].bEnabled THEN arrEMECS_State[byLPDataEMECS] := 2; END_IF
		IF arrSizeMainFuseCS[byLPDataEMECS] = 0 AND arrNrOfEM_IN_ECS[byLPDataEMECS] <> 0 AND Lynus_Standards.GVL_Energy.stDataElectricMeters[arrNrOfEM_IN_ECS[byLPDataEMECS]].bEnabled THEN arrEMECS_State[byLPDataEMECS] := 2; END_IF
			//Power Consumption from the Electric Meter
			IF arrEMECS_State[byLPDataEMECS] = 1 THEN arrEMECS_Power[byLPDataEMECS] := Lynus_Standards.GVL_Energy.stDataElectricMeters[arrNrOfEM_IN_ECS[byLPDataEMECS]].lrPowerConsumption; END_IF   
				//Error Warning
				IF arrNrOfEM_IN_ECS[byLPDataEMECS] <> 0 THEN arrEMECS_ErrorWarning[byLPDataEMECS] := Lynus_Standards.GVL_Energy.stDataElectricMeters[arrNrOfEM_IN_ECS[byLPDataEMECS]].byErrorWarning; END_IF  
	END_FOR 

//Correction for the charging station power that the target power is not bigger then the maximum of the fuse. Active on mode peak load capping (Index from meter > 0 and fuse value > 0) and load management (always).
//Work only with controllable charging station. Not work for On/off stations.
IF (stSetupEMS.bEnableMainFuseFunc AND bEnable AND (eOperationMode = E_OperatingMode_EMS.ePeakLoadCapping OR eOperationMode = E_OperatingMode_EMS.eLoadManagement)) THEN

//Timer to make the correction for the charging stations
IF (NOT arrMinPrioReached[5] AND byCounterActiveFuseLineToControllECS = 0 AND bEnable AND (eOperationMode = E_OperatingMode_EMS.ePeakLoadCapping OR eOperationMode = E_OperatingMode_EMS.eLoadManagement)) THEN  
	timCorrectionECS.IN := TRUE;
END_IF
	
IF arrMaxPrioReached[5] THEN bECSPrio255 := TRUE; END_IF
	IF NOT bSurplusAvailable THEN bECSPrio255 := FALSE; END_IF

	//Start the correction Power for the ECS
	IF timCorrectionECS.Q THEN	
		
		//Count up the Counter for Active Fuse Line to regulate it
		byCounterActiveFuseLineToControllECS := byCounterActiveFuseLineToControllECS + 1;
	
		lrPowerDiffFuseECS := (arrSizeMainFuseCS[byCounterActiveFuseLineToControllECS] * 0.95) - arrEMECS_Power[byCounterActiveFuseLineToControllECS];	
			//Make little tolerance that we dont regulate up and down 
			IF lrPowerDiffFuseECS > 0 AND lrPowerDiffFuseECS <= 0.1 THEN lrPowerDiffFuseECS := 0; END_IF  
				IF lrPowerDiffFuseECS > 0 THEN lrPowerDiffFuseECS := lrPowerDiffFuseECS - 0.1; END_IF 
			
					//No power for ECS on normal EMS Step
					IF lrPowerDiffFuseECS < 0 THEN 
						arrNoPowerForECS[byCounterActiveFuseLineToControllECS] := TRUE; 
					ELSE
						arrNoPowerForECS[byCounterActiveFuseLineToControllECS] := FALSE;
					END_IF
				
			diNumberOfECS := 0;		
				FOR liLPCorrectionPowerCS := 1 TO Constants_Energy.diMaxNumberOfElectricChargingStations BY 1 DO
					//Count number of charging stations when we have surplus on Fuse Line
					IF NOT arrMinPrioReached[5] AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCorrectionPowerCS].byPriority <= bySmGrActiveCommonPrio AND 
						Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCorrectionPowerCS].bEnabled AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCorrectionPowerCS].byElectricFuseLine = byCounterActiveFuseLineToControllECS AND 
							Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCorrectionPowerCS].rTargetPowerEMS < 100 AND lrPowerDiffFuseECS >= 0 THEN 
								diNumberOfECS := diNumberOfECS + 1; 
					END_IF
						//Count number of charging stations when we have NO surplus on Fuse Line
						IF NOT arrMinPrioReached[5] AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCorrectionPowerCS].byPriority <= bySmGrActiveCommonPrio AND 
							Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCorrectionPowerCS].bEnabled AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCorrectionPowerCS].byElectricFuseLine = byCounterActiveFuseLineToControllECS AND 
								Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCorrectionPowerCS].rTargetPowerEMS > 0 AND lrPowerDiffFuseECS < 0 THEN 
									diNumberOfECS := diNumberOfECS + 1; 
						END_IF 
				END_FOR
					//Calculate the power in % for each charging station
					//Actual Power is <= then stSetupEMS.rSizeMainFuseCS 
					IF diNumberOfECS > 0 AND lrPowerDiffFuseECS >= 0 THEN lrPowerForCalculateECS := lrPowerDiffFuseECS / diNumberOfECS; END_IF  
						//Actual Power is > then stSetupEMS.rSizeMainFuseCS
						IF diNumberOfECS > 0 AND lrPowerDiffFuseECS < 0 THEN lrPowerForCalculateECS := (lrPowerDiffFuseECS * - 1) / diNumberOfECS; END_IF 
		
		//Set the new power to the charging stations with priority < common priority in progress
		lrTargetPowerCorrectionECS := 0;
			FOR liLPCorrectionPowerCS := 1 TO Constants_Energy.diMaxNumberOfElectricChargingStations BY 1 DO 	
				IF (NOT arrMinPrioReached[5] AND timCorrectionECS.Q AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCorrectionPowerCS].byPriority < bySmGrActiveCommonPrio AND eOperationMode = E_OperatingMode_EMS.ePeakLoadCapping AND arrEMECS_ErrorWarning[byCounterActiveFuseLineToControllECS] <> 2 AND arrEMECS_State[byCounterActiveFuseLineToControllECS] = 1 AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCorrectionPowerCS].byElectricFuseLine = byCounterActiveFuseLineToControllECS) OR
					(NOT arrMinPrioReached[5] AND timCorrectionECS.Q AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCorrectionPowerCS].byPriority < bySmGrActiveCommonPrio AND eOperationMode = E_OperatingMode_EMS.eLoadManagement AND arrEMECS_ErrorWarning[byCounterActiveFuseLineToControllECS] <> 2 AND arrEMECS_State[byCounterActiveFuseLineToControllECS] = 1 AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCorrectionPowerCS].byElectricFuseLine = byCounterActiveFuseLineToControllECS) OR
						(NOT arrMinPrioReached[5] AND timCorrectionECS.Q AND lrPowerDiffFuseECS < 0 AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCorrectionPowerCS].byPriority = bySmGrActiveCommonPrio AND eOperationMode = E_OperatingMode_EMS.ePeakLoadCapping AND arrEMECS_ErrorWarning[byCounterActiveFuseLineToControllECS] <> 2 AND arrEMECS_State[byCounterActiveFuseLineToControllECS] = 1 AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCorrectionPowerCS].byElectricFuseLine = byCounterActiveFuseLineToControllECS) OR
						(NOT arrMinPrioReached[5] AND timCorrectionECS.Q AND lrPowerDiffFuseECS < 0 AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCorrectionPowerCS].byPriority = bySmGrActiveCommonPrio AND eOperationMode = E_OperatingMode_EMS.eLoadManagement AND arrEMECS_ErrorWarning[byCounterActiveFuseLineToControllECS] <> 2 AND arrEMECS_State[byCounterActiveFuseLineToControllECS] = 1 AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCorrectionPowerCS].byElectricFuseLine = byCounterActiveFuseLineToControllECS) OR				
							(NOT arrMinPrioReached[5] AND timCorrectionECS.Q AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCorrectionPowerCS].byPriority = 255 AND bECSPrio255 AND eOperationMode = E_OperatingMode_EMS.ePeakLoadCapping AND arrEMECS_ErrorWarning[byCounterActiveFuseLineToControllECS] <> 2 AND arrEMECS_State[byCounterActiveFuseLineToControllECS] = 1 AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCorrectionPowerCS].byElectricFuseLine = byCounterActiveFuseLineToControllECS) OR	
							(NOT arrMinPrioReached[5] AND timCorrectionECS.Q AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCorrectionPowerCS].byPriority = 255 AND bECSPrio255 AND eOperationMode = E_OperatingMode_EMS.eLoadManagement AND arrEMECS_ErrorWarning[byCounterActiveFuseLineToControllECS] <> 2 AND arrEMECS_State[byCounterActiveFuseLineToControllECS] = 1 AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCorrectionPowerCS].byElectricFuseLine = byCounterActiveFuseLineToControllECS) THEN
								//Calcualte the new % value for each charging station	
								IF Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCorrectionPowerCS].rMaxPower > 0 THEN 
									lrTargetPowerCorrectionECS := (100 * lrPowerForCalculateECS) / Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCorrectionPowerCS].rMaxPower;	
										lrTargetPowerCorrectionECS := LIMIT(0,lrTargetPowerCorrectionECS,100);
								ELSE
									//Without power data on the setups from the charging station set target powert to -100 or +100 to dissable the charging station
									IF lrPowerDiffFuseECS >= 0 THEN lrTargetPowerCorrectionECS := - 100; ELSE lrTargetPowerCorrectionECS := 100; END_IF 
								END_IF	
									IF lrPowerDiffFuseECS >= 0 AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCorrectionPowerCS].bIsControllable THEN 
										Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCorrectionPowerCS].rTargetPowerEMS := Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCorrectionPowerCS].rTargetPowerEMS + LREAL_TO_REAL(lrTargetPowerCorrectionECS); 
									END_IF
										IF lrPowerDiffFuseECS < 0 AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCorrectionPowerCS].bIsControllable THEN 
											Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCorrectionPowerCS].rTargetPowerEMS := Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCorrectionPowerCS].rTargetPowerEMS - LREAL_TO_REAL(lrTargetPowerCorrectionECS); 
										END_IF	
											//Limits
											Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCorrectionPowerCS].rTargetPowerEMS := LIMIT(0,Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,liLPCorrectionPowerCS].rTargetPowerEMS,100);			
				END_IF
			END_FOR
		
			//Restart the Timer
			IF byCounterActiveFuseLineToControllECS >= 30 THEN byCounterActiveFuseLineToControllECS := 0; timCorrectionECS.IN := FALSE; END_IF
		
	END_IF
	
	//Dissable the ECS complete when the EM has a Error
	FOR byLPDataEMECS := 1 TO 30 BY 1 DO
		IF (arrEMECS_ErrorWarning[byLPDataEMECS] = 2 AND (eOperationMode = E_OperatingMode_EMS.eLoadManagement OR eOperationMode = E_OperatingMode_EMS.ePeakLoadCapping)) THEN 
			arrResetDisableECS[byLPDataEMECS](IN:= TRUE, PT:= T#10S, Q=> , ET=> );
		ELSE
			arrResetDisableECS[byLPDataEMECS](IN:= FALSE, PT:= T#10S, Q=> , ET=> );
		END_IF 
	END_FOR
	
ELSE
	FOR byLPDataEMECS := 1 TO 30 BY 1 DO
		arrResetDisableECS[byLPDataEMECS](IN:= FALSE, PT:= T#10S, Q=> , ET=> );	
			arrNoPowerForECS[byLPDataEMECS] := FALSE;
	END_FOR 
		timCorrectionECS.IN := FALSE;
			bECSPrio255 := FALSE;
				byCounterActiveFuseLineToControllECS := 0;		
END_IF		

//Timer
timCorrectionECS(IN:= , PT:= tDelayPwrCorrectionECS, Q=> , ET=> );

//Counter to count each Fuse Line for ECS to dissable the charging station on this line when the EM has a Error or neccessary Inputs are missing 	
byCounterActiveFuseLineToDissableECS := byCounterActiveFuseLineToDissableECS + 1;
	IF byCounterActiveFuseLineToDissableECS > 30 THEN byCounterActiveFuseLineToDissableECS := 1; END_IF
	
(*-------------------------------------------------------------------------------------Set the power to 0 on each device---------------------------------------------------------------------------------------------------------------*)	
	
//When a device has the priority 0, the priority is bigger then who was at the moment in progress, the EMS function is not enabled, a positv or negative edge came when the emergency power mode start or stop or when the operation mode is changing then the EMS start from new and all devices are set to defaul target power 0.
//Set the target power to 0 where there should no power 

FPEPO(CLK:= bEPMActive, Q=> );
	FNEPO(CLK:= bEPMActive, Q=> );
	
diMemCmpOperationState := MEMCMP(ADR(eOperationMode),ADR(eOperationModeEMS_CP),SIZEOF(eOperationModeEMS_CP)); 	

//Battery	
FOR arrLPPrioZeroSetToZeroP[1] := 1 TO Constants_Energy.diMaxNumberOfBatteryInverters BY 1 DO
	IF Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,arrLPPrioZeroSetToZeroP[1]].byPriority = 0 OR Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,arrLPPrioZeroSetToZeroP[1]].byPriority > arrActualPrioInTurn[1] OR arrMinPrioReached[1] OR NOT bEnable OR FPEPO.Q OR FNEPO.Q OR 
		diMemCmpOperationState <> 0 OR eOperationMode = E_OperatingMode_EMS.eAllOff OR bStopAll THEN 
			Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,arrLPPrioZeroSetToZeroP[1]].rTargetPowerEMS := 0; 
	END_IF
END_FOR
	//Heating Pumps
	FOR arrLPPrioZeroSetToZeroP[2] := 1 TO Constants_Energy.diMaxNumberOfHeatingPumps BY 1 DO
		IF Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrLPPrioZeroSetToZeroP[2]].byPriority = 0 OR Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrLPPrioZeroSetToZeroP[2]].byPriority > arrActualPrioInTurn[2] OR arrMinPrioReached[2] OR NOT bEnable OR FPEPO.Q OR FNEPO.Q OR 
			diMemCmpOperationState <> 0 OR eOperationMode = E_OperatingMode_EMS.eAllOff OR bStopAll THEN
				Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrLPPrioZeroSetToZeroP[2]].arrTargetPowerEMS[1] := 0;
					Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrLPPrioZeroSetToZeroP[2]].arrTargetPowerEMS[2] := 0;
						//Switch off external on command for heating pumps
						Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,arrLPPrioZeroSetToZeroP[2]].bExternalOnCommand := FALSE;
		END_IF
	END_FOR
		//EHE
		FOR arrLPPrioZeroSetToZeroP[3] := 1 TO Constants_Energy.diMaxNumberOfElectricHeatingElements BY 1 DO
			IF Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrLPPrioZeroSetToZeroP[3]].byPriority = 0 OR Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrLPPrioZeroSetToZeroP[3]].byPriority > arrActualPrioInTurn[3] OR arrMinPrioReached[3] OR NOT bEnable OR FPEPO.Q OR FNEPO.Q OR 
				diMemCmpOperationState <> 0 OR eOperationMode = E_OperatingMode_EMS.eAllOff OR bStopAll THEN 
					Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrLPPrioZeroSetToZeroP[3]].arrTargetPowerEMS[1] := 0;
						Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrLPPrioZeroSetToZeroP[3]].arrTargetPowerEMS[2] := 0;
							Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrLPPrioZeroSetToZeroP[3]].arrTargetPowerEMS[3] := 0;
								Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrLPPrioZeroSetToZeroP[3]].arrTargetPowerEMS[4] := 0;
									Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrLPPrioZeroSetToZeroP[3]].arrTargetPowerEMS[5] := 0;
					Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrLPPrioZeroSetToZeroP[3]].arrTargetPowerEMS[6] := 0;
						Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrLPPrioZeroSetToZeroP[3]].arrTargetPowerEMS[7] := 0;
							Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrLPPrioZeroSetToZeroP[3]].arrTargetPowerEMS[8] := 0;
								Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrLPPrioZeroSetToZeroP[3]].arrTargetPowerEMS[9] := 0;
									Lynus_Standards.GVL_Energy.stDataElectricHeatingElements[diNrOfEMS_OUT,arrLPPrioZeroSetToZeroP[3]].arrTargetPowerEMS[10] := 0;
			END_IF
		END_FOR
			//OBC
			FOR arrLPPrioZeroSetToZeroP[4] := 1 TO Constants_Energy.diMaxNumberOfOtherBigConsumers BY 1 DO
				IF Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,arrLPPrioZeroSetToZeroP[4]].byPriority = 0 OR Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,arrLPPrioZeroSetToZeroP[4]].byPriority > arrActualPrioInTurn[4] OR arrMinPrioReached[4] OR NOT bEnable OR FPEPO.Q OR 
					FNEPO.Q OR diMemCmpOperationState <> 0 OR eOperationMode = E_OperatingMode_EMS.eAllOff OR bStopAll THEN
						Lynus_Standards.GVL_Energy.stDataOtherBigConsumers[diNrOfEMS_OUT,arrLPPrioZeroSetToZeroP[4]].rTargetPowerEMS := 0;
				END_IF
			END_FOR
				//ECS
				FOR arrLPPrioZeroSetToZeroP[5] := 1 TO Constants_Energy.diMaxNumberOfElectricChargingStations BY 1 DO
					IF Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,arrLPPrioZeroSetToZeroP[5]].byPriority = 0 OR Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,arrLPPrioZeroSetToZeroP[5]].byPriority > arrActualPrioInTurn[5] OR arrMinPrioReached[5] OR NOT bEnable OR FPEPO.Q OR FNEPO.Q OR 
						diMemCmpOperationState <> 0 OR eOperationMode = E_OperatingMode_EMS.eAllOff OR bStopAll OR 
							((eOperationMode = E_OperatingMode_EMS.ePeakLoadCapping OR eOperationMode = E_OperatingMode_EMS.eLoadManagement) AND stSetupEMS.bEnableMainFuseFunc AND Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,arrLPPrioZeroSetToZeroP[5]].byElectricFuseLine = byCounterActiveFuseLineToDissableECS AND (arrEMECS_State[byCounterActiveFuseLineToDissableECS] = 2 OR arrResetDisableECS[byCounterActiveFuseLineToDissableECS].Q)) THEN
								Lynus_Standards.GVL_Energy.stDataElectricChargingStations[diNrOfEMS_OUT,arrLPPrioZeroSetToZeroP[5]].rTargetPowerEMS := 0;
					END_IF
				END_FOR

(*----------------------------------------------------------------------------------------------------Controller to discharge/charge the batterys on the different modes----------------------------------------------------------------------------------------------------------*)
(*----------------------------------------------------------------------------------------------------Controller to discharge the battery in the self consumption mode----------------------------------------------------------------------------------------------------------*)

lrErrorPIDCorrectionBattSC := ABS(0 - lrGridPower);

//Controller weighting
IF eSpeedModeLocalController = E_SpeedModeLocalController_EMS.eSlow THEN 
	IF lrErrorPIDCorrectionBattSC <= 0.5 THEN fbPIDBatterySC.rPValue := 0.05; fbPIDBatterySC.udiIValue := 450;
	ELSIF lrErrorPIDCorrectionBattSC > 0.5 AND lrErrorPIDCorrectionBattSC <= 1 THEN fbPIDBatterySC.rPValue := 0.07; fbPIDBatterySC.udiIValue := 450;
	ELSIF lrErrorPIDCorrectionBattSC > 1 AND lrErrorPIDCorrectionBattSC <= 1.5 THEN fbPIDBatterySC.rPValue := 0.09; fbPIDBatterySC.udiIValue := 450; 
	ELSIF lrErrorPIDCorrectionBattSC > 1.5 AND lrErrorPIDCorrectionBattSC <= 2 THEN fbPIDBatterySC.rPValue := 0.11; fbPIDBatterySC.udiIValue := 450; 	
	ELSIF lrErrorPIDCorrectionBattSC > 2 AND lrErrorPIDCorrectionBattSC <= 2.5 THEN fbPIDBatterySC.rPValue := 0.13; fbPIDBatterySC.udiIValue := 675; 
	ELSIF lrErrorPIDCorrectionBattSC > 2.5 AND lrErrorPIDCorrectionBattSC <= 3 THEN fbPIDBatterySC.rPValue := 0.15; fbPIDBatterySC.udiIValue := 675;
	ELSIF lrErrorPIDCorrectionBattSC > 3 AND lrErrorPIDCorrectionBattSC <= 3.5 THEN fbPIDBatterySC.rPValue := 0.17; fbPIDBatterySC.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattSC > 3.5 AND lrErrorPIDCorrectionBattSC <= 4 THEN fbPIDBatterySC.rPValue := 0.19; fbPIDBatterySC.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattSC > 4 AND lrErrorPIDCorrectionBattSC <= 4.5 THEN fbPIDBatterySC.rPValue := 0.21; fbPIDBatterySC.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattSC > 4.5 AND lrErrorPIDCorrectionBattSC <= 5 THEN fbPIDBatterySC.rPValue := 0.23; fbPIDBatterySC.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattSC > 5 THEN fbPIDBatterySC.rPValue := 0.25; fbPIDBatterySC.udiIValue := 900;
	END_IF
ELSIF eSpeedModeLocalController = E_SpeedModeLocalController_EMS.eBalanced THEN 
	IF lrErrorPIDCorrectionBattSC <= 0.5 THEN fbPIDBatterySC.rPValue := 0.10; fbPIDBatterySC.udiIValue := 450;
	ELSIF lrErrorPIDCorrectionBattSC > 0.5 AND lrErrorPIDCorrectionBattSC <= 1 THEN fbPIDBatterySC.rPValue := 0.14; fbPIDBatterySC.udiIValue := 450;
	ELSIF lrErrorPIDCorrectionBattSC > 1 AND lrErrorPIDCorrectionBattSC <= 1.5 THEN fbPIDBatterySC.rPValue := 0.18; fbPIDBatterySC.udiIValue := 450; 
	ELSIF lrErrorPIDCorrectionBattSC > 1.5 AND lrErrorPIDCorrectionBattSC <= 2 THEN fbPIDBatterySC.rPValue := 0.22; fbPIDBatterySC.udiIValue := 450; 	
	ELSIF lrErrorPIDCorrectionBattSC > 2 AND lrErrorPIDCorrectionBattSC <= 2.5 THEN fbPIDBatterySC.rPValue := 0.26; fbPIDBatterySC.udiIValue := 675; 
	ELSIF lrErrorPIDCorrectionBattSC > 2.5 AND lrErrorPIDCorrectionBattSC <= 3 THEN fbPIDBatterySC.rPValue := 0.30; fbPIDBatterySC.udiIValue := 675;
	ELSIF lrErrorPIDCorrectionBattSC > 3 AND lrErrorPIDCorrectionBattSC <= 3.5 THEN fbPIDBatterySC.rPValue := 0.34; fbPIDBatterySC.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattSC > 3.5 AND lrErrorPIDCorrectionBattSC <= 4 THEN fbPIDBatterySC.rPValue := 0.38; fbPIDBatterySC.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattSC > 4 AND lrErrorPIDCorrectionBattSC <= 4.5 THEN fbPIDBatterySC.rPValue := 0.42; fbPIDBatterySC.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattSC > 4.5 AND lrErrorPIDCorrectionBattSC <= 5 THEN fbPIDBatterySC.rPValue := 0.46; fbPIDBatterySC.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattSC > 5 THEN fbPIDBatterySC.rPValue := 0.50; fbPIDBatterySC.udiIValue := 900;
	END_IF
ELSIF eSpeedModeLocalController = E_SpeedModeLocalController_EMS.eFast THEN
	IF lrErrorPIDCorrectionBattSC <= 0.5 THEN fbPIDBatterySC.rPValue := 0.30; fbPIDBatterySC.udiIValue := 275;
	ELSIF lrErrorPIDCorrectionBattSC > 0.5 AND lrErrorPIDCorrectionBattSC <= 1 THEN fbPIDBatterySC.rPValue := 0.33; fbPIDBatterySC.udiIValue := 275;
	ELSIF lrErrorPIDCorrectionBattSC > 1 AND lrErrorPIDCorrectionBattSC <= 1.5 THEN fbPIDBatterySC.rPValue := 0.36; fbPIDBatterySC.udiIValue := 275; 
	ELSIF lrErrorPIDCorrectionBattSC > 1.5 AND lrErrorPIDCorrectionBattSC <= 2 THEN fbPIDBatterySC.rPValue := 0.39; fbPIDBatterySC.udiIValue := 275; 	
	ELSIF lrErrorPIDCorrectionBattSC > 2 AND lrErrorPIDCorrectionBattSC <= 2.5 THEN fbPIDBatterySC.rPValue := 0.42; fbPIDBatterySC.udiIValue := 500; 
	ELSIF lrErrorPIDCorrectionBattSC > 2.5 AND lrErrorPIDCorrectionBattSC <= 3 THEN fbPIDBatterySC.rPValue := 0.45; fbPIDBatterySC.udiIValue := 500;
	ELSIF lrErrorPIDCorrectionBattSC > 3 AND lrErrorPIDCorrectionBattSC <= 3.5 THEN fbPIDBatterySC.rPValue := 0.48; fbPIDBatterySC.udiIValue := 750;
	ELSIF lrErrorPIDCorrectionBattSC > 3.5 AND lrErrorPIDCorrectionBattSC <= 4 THEN fbPIDBatterySC.rPValue := 0.51; fbPIDBatterySC.udiIValue := 750;
	ELSIF lrErrorPIDCorrectionBattSC > 4 AND lrErrorPIDCorrectionBattSC <= 4.5 THEN fbPIDBatterySC.rPValue := 0.54; fbPIDBatterySC.udiIValue := 750;
	ELSIF lrErrorPIDCorrectionBattSC > 4.5 AND lrErrorPIDCorrectionBattSC <= 5 THEN fbPIDBatterySC.rPValue := 0.57; fbPIDBatterySC.udiIValue := 750;
	ELSIF lrErrorPIDCorrectionBattSC > 5 THEN fbPIDBatterySC.rPValue := 0.60; fbPIDBatterySC.udiIValue := 750;
	END_IF
END_IF

IF bEnable AND eOperationMode = E_OperatingMode_EMS.eSelfConsumption AND NOT bEPMActive AND NOT bStopAll AND NOT bDischrgCmdFromBackendOK AND 
	arrMinPrioReached[1] AND arrMinPrioReached[2] AND arrMinPrioReached[3] AND arrMinPrioReached[4] AND arrMinPrioReached[5] THEN
		fbPIDBatterySC.bEnable := TRUE;
ELSE
		fbPIDBatterySC.bEnable := FALSE;
END_IF

fbPIDBatterySC( 
	bEnable:= , 
	rSetpoint:= 0, 
	udiIValue:= , 
	udiDValue:= 0, 
	udiDamping:= 0, 
	rPValue:= , 
	rMaxValue:= 100, 
	rMinValue:= 0, 
	rNeutralZone:= 0.1, 
	bDirection:= TRUE, 
	rActualValue:= LREAL_TO_REAL(lrGridPower), 
	rQController=> rControllerQPIDSC);

//Set the Controller output	to 0 when we have surplus. (Because its possible that the controller output is not set 100% to 0 regarding internal discrepancies)
IF rControllerQPIDSC <= 0.4 AND fbPIDBatterySC.bEnable AND lrGridPower <= - Constants_Energy.rToleranceSurplusConsumption THEN 
	timPIDSC.IN := TRUE;
ELSE
	timPIDSC.IN := FALSE;
END_IF

timPIDSC(IN:= , PT:= T#15S, Q=> , ET=> );
	IF timPIDSC.Q THEN rControllerQPIDSC := 0; END_IF	

FOR liLPDataBatteryInverter := 1 TO Constants_Energy.diMaxNumberOfBatteryInverters BY 1 DO
	IF Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPDataBatteryInverter].byPriority <> 0 AND NOT bEPMActive AND eOperationMode = E_OperatingMode_EMS.eSelfConsumption AND	
		arrMinPrioReached[1] AND arrMinPrioReached[2] AND arrMinPrioReached[3] AND arrMinPrioReached[4] AND arrMinPrioReached[5] THEN
			Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPDataBatteryInverter].rTargetPowerEMS := rControllerQPIDSC;
	END_IF 
END_FOR	

(*----------------------------------------------------------------------------------------------------Controller to charge and discharge the battery in the peak load capping mode and load management mode----------------------------------------------------------------------------------------------------------*)

//IMPORTANT : On this 2 modes the Batterys are allways active.
//This means that in these two modes the battery is not processed via the state machine like other devices.
//They are there to limit the power to the grid connection. The batteries charge according to the release when the power on the grid is below the grid connection or when power is fed back to the grid.
//The 95% are used so that the remaining 5% are still seen as surplus and thus the remaining consumers can still be regulated up to take advantage of the full grid connection.
//The batteries are processed with their priorities during charging. THIS means that only those batteries are active which also match the current active priority in the EMS.

(*--------------------------------------------------------------------------------------------------------------------Discharge the batterys-----------------------------------------------------------------------------------------------------------------------------------------------*)

lrErrorPIDCorrectionBattPLCLM_Dischrg := ABS(lrGridPower - (lrSizeGridConnection * 0.95));

//Controller weighting
IF eSpeedModeLocalController = E_SpeedModeLocalController_EMS.eSlow THEN 
	IF lrErrorPIDCorrectionBattPLCLM_Dischrg <= 0.5 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.05; fbPIDBatteryPLCLM_Dischrg.udiIValue := 450;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Dischrg > 0.5 AND lrErrorPIDCorrectionBattPLCLM_Dischrg <= 1 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.07; fbPIDBatteryPLCLM_Dischrg.udiIValue := 450;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Dischrg > 1 AND lrErrorPIDCorrectionBattPLCLM_Dischrg <= 1.5 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.09; fbPIDBatteryPLCLM_Dischrg.udiIValue := 450; 
	ELSIF lrErrorPIDCorrectionBattPLCLM_Dischrg > 1.5 AND lrErrorPIDCorrectionBattPLCLM_Dischrg <= 2 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.11; fbPIDBatteryPLCLM_Dischrg.udiIValue := 450; 	
	ELSIF lrErrorPIDCorrectionBattPLCLM_Dischrg > 2 AND lrErrorPIDCorrectionBattPLCLM_Dischrg <= 2.5 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.13; fbPIDBatteryPLCLM_Dischrg.udiIValue := 675; 
	ELSIF lrErrorPIDCorrectionBattPLCLM_Dischrg > 2.5 AND lrErrorPIDCorrectionBattPLCLM_Dischrg <= 3 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.15; fbPIDBatteryPLCLM_Dischrg.udiIValue := 675;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Dischrg > 3 AND lrErrorPIDCorrectionBattPLCLM_Dischrg <= 3.5 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.17; fbPIDBatteryPLCLM_Dischrg.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Dischrg > 3.5 AND lrErrorPIDCorrectionBattPLCLM_Dischrg <= 4 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.19; fbPIDBatteryPLCLM_Dischrg.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Dischrg > 4 AND lrErrorPIDCorrectionBattPLCLM_Dischrg <= 4.5 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.21; fbPIDBatteryPLCLM_Dischrg.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Dischrg > 4.5 AND lrErrorPIDCorrectionBattPLCLM_Dischrg <= 5 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.23; fbPIDBatteryPLCLM_Dischrg.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Dischrg > 5 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.25; fbPIDBatteryPLCLM_Dischrg.udiIValue := 900;
	END_IF
ELSIF eSpeedModeLocalController = E_SpeedModeLocalController_EMS.eBalanced THEN
	IF lrErrorPIDCorrectionBattPLCLM_Dischrg <= 0.5 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.10; fbPIDBatteryPLCLM_Dischrg.udiIValue := 450;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Dischrg > 0.5 AND lrErrorPIDCorrectionBattPLCLM_Dischrg <= 1 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.14; fbPIDBatteryPLCLM_Dischrg.udiIValue := 450;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Dischrg > 1 AND lrErrorPIDCorrectionBattPLCLM_Dischrg <= 1.5 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.18; fbPIDBatteryPLCLM_Dischrg.udiIValue := 450; 
	ELSIF lrErrorPIDCorrectionBattPLCLM_Dischrg > 1.5 AND lrErrorPIDCorrectionBattPLCLM_Dischrg <= 2 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.22; fbPIDBatteryPLCLM_Dischrg.udiIValue := 450; 	
	ELSIF lrErrorPIDCorrectionBattPLCLM_Dischrg > 2 AND lrErrorPIDCorrectionBattPLCLM_Dischrg <= 2.5 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.26; fbPIDBatteryPLCLM_Dischrg.udiIValue := 675; 
	ELSIF lrErrorPIDCorrectionBattPLCLM_Dischrg > 2.5 AND lrErrorPIDCorrectionBattPLCLM_Dischrg <= 3 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.30; fbPIDBatteryPLCLM_Dischrg.udiIValue := 675;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Dischrg > 3 AND lrErrorPIDCorrectionBattPLCLM_Dischrg <= 3.5 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.34; fbPIDBatteryPLCLM_Dischrg.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Dischrg > 3.5 AND lrErrorPIDCorrectionBattPLCLM_Dischrg <= 4 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.38; fbPIDBatteryPLCLM_Dischrg.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Dischrg > 4 AND lrErrorPIDCorrectionBattPLCLM_Dischrg <= 4.5 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.42; fbPIDBatteryPLCLM_Dischrg.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Dischrg > 4.5 AND lrErrorPIDCorrectionBattPLCLM_Dischrg <= 5 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.46; fbPIDBatteryPLCLM_Dischrg.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Dischrg > 5 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.50; fbPIDBatteryPLCLM_Dischrg.udiIValue := 900;
	END_IF
ELSIF eSpeedModeLocalController = E_SpeedModeLocalController_EMS.eFast THEN
	IF lrErrorPIDCorrectionBattPLCLM_Dischrg <= 0.5 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.30; fbPIDBatteryPLCLM_Dischrg.udiIValue := 275;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Dischrg > 0.5 AND lrErrorPIDCorrectionBattPLCLM_Dischrg <= 1 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.33; fbPIDBatteryPLCLM_Dischrg.udiIValue := 275;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Dischrg > 1 AND lrErrorPIDCorrectionBattPLCLM_Dischrg <= 1.5 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.36; fbPIDBatteryPLCLM_Dischrg.udiIValue := 275; 
	ELSIF lrErrorPIDCorrectionBattPLCLM_Dischrg > 1.5 AND lrErrorPIDCorrectionBattPLCLM_Dischrg <= 2 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.39; fbPIDBatteryPLCLM_Dischrg.udiIValue := 275; 	
	ELSIF lrErrorPIDCorrectionBattPLCLM_Dischrg > 2 AND lrErrorPIDCorrectionBattPLCLM_Dischrg <= 2.5 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.42; fbPIDBatteryPLCLM_Dischrg.udiIValue := 500; 
	ELSIF lrErrorPIDCorrectionBattPLCLM_Dischrg > 2.5 AND lrErrorPIDCorrectionBattPLCLM_Dischrg <= 3 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.45; fbPIDBatteryPLCLM_Dischrg.udiIValue := 500;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Dischrg > 3 AND lrErrorPIDCorrectionBattPLCLM_Dischrg <= 3.5 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.48; fbPIDBatteryPLCLM_Dischrg.udiIValue := 750;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Dischrg > 3.5 AND lrErrorPIDCorrectionBattPLCLM_Dischrg <= 4 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.51; fbPIDBatteryPLCLM_Dischrg.udiIValue := 750;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Dischrg > 4 AND lrErrorPIDCorrectionBattPLCLM_Dischrg <= 4.5 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.54; fbPIDBatteryPLCLM_Dischrg.udiIValue := 750;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Dischrg > 4.5 AND lrErrorPIDCorrectionBattPLCLM_Dischrg <= 5 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.57; fbPIDBatteryPLCLM_Dischrg.udiIValue := 750;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Dischrg > 5 THEN fbPIDBatteryPLCLM_Dischrg.rPValue := 0.60; fbPIDBatteryPLCLM_Dischrg.udiIValue := 750;
	END_IF
END_IF

IF (bEnable AND eOperationMode = E_OperatingMode_EMS.ePeakLoadCapping AND NOT bEPMActive AND NOT bStopAll AND NOT bDischrgCmdFromBackendOK AND NOT fbPIDBatteryPLCLM_Chrg.bEnable AND lrGridPower >= (lrSizeGridConnection * 0.95)) OR 
	(bEnable AND eOperationMode = E_OperatingMode_EMS.eLoadManagement AND NOT bEPMActive AND NOT bStopAll AND NOT bDischrgCmdFromBackendOK AND NOT fbPIDBatteryPLCLM_Chrg.bEnable AND lrGridPower >= (lrSizeGridConnection * 0.95)) THEN
		fbPIDBatteryPLCLM_Dischrg.bEnable := TRUE;
END_IF
	IF NOT bEnable OR diNumberOfActiveBatterys = 0 OR bEPMActive OR bStopAll OR bDischrgCmdFromBackendOK OR fbPIDBatteryPLCLM_Chrg.bEnable OR eOperationMode = E_OperatingMode_EMS.eAllOff OR eOperationMode = E_OperatingMode_EMS.eSelfConsumption OR
		(lrGridPower < (lrSizeGridConnection * 0.95) AND fbPIDBatteryPLCLM_Dischrg.rQController <= 0) THEN
			fbPIDBatteryPLCLM_Dischrg.bEnable := FALSE;
	END_IF    

fbPIDBatteryPLCLM_Dischrg( 
	bEnable:= , 
	rSetpoint:= LREAL_TO_REAL(lrSizeGridConnection * 0.95), 
	udiIValue:= , 
	udiDValue:= 0, 
	udiDamping:= 0, 
	rPValue:= , 
	rMaxValue:= 100, 
	rMinValue:= 0, 
	rNeutralZone:= 0.1, 
	bDirection:= TRUE, 
	rActualValue:= LREAL_TO_REAL(lrGridPower), 
	rQController=> );

FOR liLPDataBatteryInverter := 1 TO Constants_Energy.diMaxNumberOfBatteryInverters BY 1 DO
	IF Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPDataBatteryInverter].byPriority <> 0 AND NOT bEPMActive AND fbPIDBatteryPLCLM_Dischrg.bEnable THEN
		Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPDataBatteryInverter].rTargetPowerEMS := fbPIDBatteryPLCLM_Dischrg.rQController;
	END_IF 
END_FOR	

(*--------------------------------------------------------------------------------------------------------------------Charge the batterys-----------------------------------------------------------------------------------------------------------------------------------------------*)

IF stSetupEMS.bAllowChrgFromGrid THEN 
	lrErrorPIDCorrectionBattPLCLM_Chrg := ABS(lrGridPower - (lrSizeGridConnection * 0.95));
ELSE
	lrErrorPIDCorrectionBattPLCLM_Chrg := ABS(0 - lrGridPower);
END_IF 

//Controller weighting
IF eSpeedModeLocalController = E_SpeedModeLocalController_EMS.eSlow THEN 
	IF lrErrorPIDCorrectionBattPLCLM_Chrg <= 0.5 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.05; fbPIDBatteryPLCLM_Chrg.udiIValue := 450;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Chrg > 0.5 AND lrErrorPIDCorrectionBattPLCLM_Chrg <= 1 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.07; fbPIDBatteryPLCLM_Chrg.udiIValue := 450;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Chrg > 1 AND lrErrorPIDCorrectionBattPLCLM_Chrg <= 1.5 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.09; fbPIDBatteryPLCLM_Chrg.udiIValue := 450; 
	ELSIF lrErrorPIDCorrectionBattPLCLM_Chrg > 1.5 AND lrErrorPIDCorrectionBattPLCLM_Chrg <= 2 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.11; fbPIDBatteryPLCLM_Chrg.udiIValue := 450; 	
	ELSIF lrErrorPIDCorrectionBattPLCLM_Chrg > 2 AND lrErrorPIDCorrectionBattPLCLM_Chrg <= 2.5 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.13; fbPIDBatteryPLCLM_Chrg.udiIValue := 675; 
	ELSIF lrErrorPIDCorrectionBattPLCLM_Chrg > 2.5 AND lrErrorPIDCorrectionBattPLCLM_Chrg <= 3 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.15; fbPIDBatteryPLCLM_Chrg.udiIValue := 675;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Chrg > 3 AND lrErrorPIDCorrectionBattPLCLM_Chrg <= 3.5 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.17; fbPIDBatteryPLCLM_Chrg.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Chrg > 3.5 AND lrErrorPIDCorrectionBattPLCLM_Chrg <= 4 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.19; fbPIDBatteryPLCLM_Chrg.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Chrg > 4 AND lrErrorPIDCorrectionBattPLCLM_Chrg <= 4.5 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.21; fbPIDBatteryPLCLM_Chrg.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Chrg > 4.5 AND lrErrorPIDCorrectionBattPLCLM_Chrg <= 5 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.23; fbPIDBatteryPLCLM_Chrg.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Chrg > 5 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.25; fbPIDBatteryPLCLM_Chrg.udiIValue := 900;
	END_IF
ELSIF eSpeedModeLocalController = E_SpeedModeLocalController_EMS.eBalanced THEN
	IF lrErrorPIDCorrectionBattPLCLM_Chrg <= 0.5 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.10; fbPIDBatteryPLCLM_Chrg.udiIValue := 450;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Chrg > 0.5 AND lrErrorPIDCorrectionBattPLCLM_Chrg <= 1 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.14; fbPIDBatteryPLCLM_Chrg.udiIValue := 450;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Chrg > 1 AND lrErrorPIDCorrectionBattPLCLM_Chrg <= 1.5 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.18; fbPIDBatteryPLCLM_Chrg.udiIValue := 450; 
	ELSIF lrErrorPIDCorrectionBattPLCLM_Chrg > 1.5 AND lrErrorPIDCorrectionBattPLCLM_Chrg <= 2 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.22; fbPIDBatteryPLCLM_Chrg.udiIValue := 450; 	
	ELSIF lrErrorPIDCorrectionBattPLCLM_Chrg > 2 AND lrErrorPIDCorrectionBattPLCLM_Chrg <= 2.5 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.26; fbPIDBatteryPLCLM_Chrg.udiIValue := 675; 
	ELSIF lrErrorPIDCorrectionBattPLCLM_Chrg > 2.5 AND lrErrorPIDCorrectionBattPLCLM_Chrg <= 3 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.30; fbPIDBatteryPLCLM_Chrg.udiIValue := 675;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Chrg > 3 AND lrErrorPIDCorrectionBattPLCLM_Chrg <= 3.5 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.34; fbPIDBatteryPLCLM_Chrg.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Chrg > 3.5 AND lrErrorPIDCorrectionBattPLCLM_Chrg <= 4 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.38; fbPIDBatteryPLCLM_Chrg.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Chrg > 4 AND lrErrorPIDCorrectionBattPLCLM_Chrg <= 4.5 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.42; fbPIDBatteryPLCLM_Chrg.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Chrg > 4.5 AND lrErrorPIDCorrectionBattPLCLM_Chrg <= 5 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.46; fbPIDBatteryPLCLM_Chrg.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Chrg > 5 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.50; fbPIDBatteryPLCLM_Chrg.udiIValue := 900;
	END_IF
ELSIF eSpeedModeLocalController = E_SpeedModeLocalController_EMS.eFast THEN
	IF lrErrorPIDCorrectionBattPLCLM_Chrg <= 0.5 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.30; fbPIDBatteryPLCLM_Chrg.udiIValue := 275;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Chrg > 0.5 AND lrErrorPIDCorrectionBattPLCLM_Chrg <= 1 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.33; fbPIDBatteryPLCLM_Chrg.udiIValue := 275;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Chrg > 1 AND lrErrorPIDCorrectionBattPLCLM_Chrg <= 1.5 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.36; fbPIDBatteryPLCLM_Chrg.udiIValue := 275; 
	ELSIF lrErrorPIDCorrectionBattPLCLM_Chrg > 1.5 AND lrErrorPIDCorrectionBattPLCLM_Chrg <= 2 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.39; fbPIDBatteryPLCLM_Chrg.udiIValue := 275; 	
	ELSIF lrErrorPIDCorrectionBattPLCLM_Chrg > 2 AND lrErrorPIDCorrectionBattPLCLM_Chrg <= 2.5 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.42; fbPIDBatteryPLCLM_Chrg.udiIValue := 500; 
	ELSIF lrErrorPIDCorrectionBattPLCLM_Chrg > 2.5 AND lrErrorPIDCorrectionBattPLCLM_Chrg <= 3 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.45; fbPIDBatteryPLCLM_Chrg.udiIValue := 500;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Chrg > 3 AND lrErrorPIDCorrectionBattPLCLM_Chrg <= 3.5 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.48; fbPIDBatteryPLCLM_Chrg.udiIValue := 750;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Chrg > 3.5 AND lrErrorPIDCorrectionBattPLCLM_Chrg <= 4 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.51; fbPIDBatteryPLCLM_Chrg.udiIValue := 750;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Chrg > 4 AND lrErrorPIDCorrectionBattPLCLM_Chrg <= 4.5 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.54; fbPIDBatteryPLCLM_Chrg.udiIValue := 750;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Chrg > 4.5 AND lrErrorPIDCorrectionBattPLCLM_Chrg <= 5 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.57; fbPIDBatteryPLCLM_Chrg.udiIValue := 750;
	ELSIF lrErrorPIDCorrectionBattPLCLM_Chrg > 5 THEN fbPIDBatteryPLCLM_Chrg.rPValue := 0.60; fbPIDBatteryPLCLM_Chrg.udiIValue := 750;
	END_IF	
END_IF

//Start and stop charge when charging from thr grid is allowed
IF (bEnable AND eOperationMode = E_OperatingMode_EMS.ePeakLoadCapping AND stSetupEMS.bAllowChrgFromGrid AND NOT bEPMActive AND NOT bStopAll AND NOT 
		fbPIDBatteryPLCLM_Dischrg.bEnable AND NOT fbPIDDischrgCmdFromBackend.bEnable AND lrGridPower < (lrSizeGridConnection * 0.95)) OR 
	(bEnable AND eOperationMode = E_OperatingMode_EMS.eLoadManagement AND stSetupEMS.bAllowChrgFromGrid AND NOT bEPMActive AND NOT bStopAll AND NOT 
		fbPIDBatteryPLCLM_Dischrg.bEnable AND NOT fbPIDDischrgCmdFromBackend.bEnable AND lrGridPower < (lrSizeGridConnection * 0.95)) THEN
			fbPIDBatteryPLCLM_Chrg.bEnable := TRUE;
END_IF
	IF (stSetupEMS.bAllowChrgFromGrid AND (NOT bEnable OR diNumberOfActiveBatterys = 0 OR bEPMActive OR bStopAll OR fbPIDBatteryPLCLM_Dischrg.bEnable OR eOperationMode = E_OperatingMode_EMS.eAllOff OR 
		eOperationMode = E_OperatingMode_EMS.eSelfConsumption OR fbPIDDischrgCmdFromBackend.bEnable OR (fbPIDBatteryPLCLM_Chrg.rQController >= 0 AND lrGridPower >= (lrSizeGridConnection * 0.95)))) THEN
			fbPIDBatteryPLCLM_Chrg.bEnable := FALSE;
	END_IF

//Start and stop charge when charging from thr grid is not allowed
IF (bEnable AND eOperationMode = E_OperatingMode_EMS.ePeakLoadCapping AND NOT stSetupEMS.bAllowChrgFromGrid AND NOT bEPMActive AND NOT bStopAll AND NOT 
		fbPIDBatteryPLCLM_Dischrg.bEnable AND NOT fbPIDDischrgCmdFromBackend.bEnable AND lrGridPower < 0) OR 
	(bEnable AND eOperationMode = E_OperatingMode_EMS.eLoadManagement AND NOT stSetupEMS.bAllowChrgFromGrid AND NOT bEPMActive AND NOT bStopAll AND NOT 
		fbPIDBatteryPLCLM_Dischrg.bEnable AND NOT fbPIDDischrgCmdFromBackend.bEnable AND lrGridPower < 0) THEN
			fbPIDBatteryPLCLM_Chrg.bEnable := TRUE;
END_IF
	IF (NOT stSetupEMS.bAllowChrgFromGrid AND (NOT bEnable OR diNumberOfActiveBatterys = 0 OR bEPMActive OR bStopAll OR fbPIDBatteryPLCLM_Dischrg.bEnable OR eOperationMode = E_OperatingMode_EMS.eAllOff OR 
		eOperationMode = E_OperatingMode_EMS.eSelfConsumption OR fbPIDDischrgCmdFromBackend.bEnable OR (fbPIDBatteryPLCLM_Chrg.rQController >= 0 AND lrGridPower >= 0))) THEN
			fbPIDBatteryPLCLM_Chrg.bEnable := FALSE;
	END_IF

//Set the Setpoint from the controller	
IF stSetupEMS.bAllowChrgFromGrid AND dwAvarageBatterySOC < stSetupEMS.byResChrgGridToBatt THEN 
	fbPIDBatteryPLCLM_Chrg.rSetpoint := LREAL_TO_REAL(lrSizeGridConnection * 0.95);
ELSE
	fbPIDBatteryPLCLM_Chrg.rSetpoint := 0;
END_IF 	
	
fbPIDBatteryPLCLM_Chrg( 
	bEnable:= , 
	rSetpoint:= , 
	udiIValue:= , 
	udiDValue:= 0, 
	udiDamping:= 0, 
	rPValue:= , 
	rMaxValue:= 0, 
	rMinValue:= - 100, 
	rNeutralZone:= 0.1, 
	bDirection:= TRUE, 
	rActualValue:= LREAL_TO_REAL(lrGridPower), 
	rQController=> );

FOR liLPDataBatteryInverter := 1 TO Constants_Energy.diMaxNumberOfBatteryInverters BY 1 DO
	IF Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPDataBatteryInverter].byPriority <= bySmGrActiveCommonPrio AND Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPDataBatteryInverter].byPriority <> 0 AND NOT 
		bEPMActive AND fbPIDBatteryPLCLM_Chrg.bEnable THEN
			Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPDataBatteryInverter].rTargetPowerEMS := fbPIDBatteryPLCLM_Chrg.rQController;
	END_IF 
END_FOR	

(*----------------------------------------------------------------------------------------------------Controller to discharge the battery in the emergency power mode----------------------------------------------------------------------------------------------------------*)

//All batterys what made active a island grid (Emergency power mode), the receive a target power form -100% to charge. The rest of the logic must implementet in each battery or batteryinverter function.
//Calculates the power from all batterys wich made a island grid
lrSizeBatteryPowerInEPO := 0;
FOR liLPDataBatteryInverter := 1 TO Constants_Energy.diMaxNumberOfBatteryInverters BY 1 DO
	IF Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPDataBatteryInverter].bWorkOnIslandMode AND bEPMActive AND NOT bStopAll THEN 
		Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPDataBatteryInverter].rTargetPowerEMS := -100; 
			lrSizeBatteryPowerInEPO := lrSizeBatteryPowerInEPO + Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPDataBatteryInverter].lrPowerOnIslandMode;  
	END_IF
END_FOR	

lrErrorPIDCorrectionBattEPO := ABS(0 - lrSizeBatteryPowerInEPO);

//Controller weighting
IF eSpeedModeLocalController = E_SpeedModeLocalController_EMS.eSlow THEN
	IF lrErrorPIDCorrectionBattEPO <= 0.5 THEN fbPIDBatteryEPO.rPValue := 0.05; fbPIDBatteryEPO.udiIValue := 450;
	ELSIF lrErrorPIDCorrectionBattEPO > 0.5 AND lrErrorPIDCorrectionBattEPO <= 1 THEN fbPIDBatteryEPO.rPValue := 0.07; fbPIDBatteryEPO.udiIValue := 450;
	ELSIF lrErrorPIDCorrectionBattEPO > 1 AND lrErrorPIDCorrectionBattEPO <= 1.5 THEN fbPIDBatteryEPO.rPValue := 0.09; fbPIDBatteryEPO.udiIValue := 450; 
	ELSIF lrErrorPIDCorrectionBattEPO > 1.5 AND lrErrorPIDCorrectionBattEPO <= 2 THEN fbPIDBatteryEPO.rPValue := 0.11; fbPIDBatteryEPO.udiIValue := 450; 	
	ELSIF lrErrorPIDCorrectionBattEPO > 2 AND lrErrorPIDCorrectionBattEPO <= 2.5 THEN fbPIDBatteryEPO.rPValue := 0.13; fbPIDBatteryEPO.udiIValue := 675; 
	ELSIF lrErrorPIDCorrectionBattEPO > 2.5 AND lrErrorPIDCorrectionBattEPO <= 3 THEN fbPIDBatteryEPO.rPValue := 0.15; fbPIDBatteryEPO.udiIValue := 675;
	ELSIF lrErrorPIDCorrectionBattEPO > 3 AND lrErrorPIDCorrectionBattEPO <= 3.5 THEN fbPIDBatteryEPO.rPValue := 0.17; fbPIDBatteryEPO.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattEPO > 3.5 AND lrErrorPIDCorrectionBattEPO <= 4 THEN fbPIDBatteryEPO.rPValue := 0.19; fbPIDBatteryEPO.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattEPO > 4 AND lrErrorPIDCorrectionBattEPO <= 4.5 THEN fbPIDBatteryEPO.rPValue := 0.21; fbPIDBatteryEPO.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattEPO > 4.5 AND lrErrorPIDCorrectionBattEPO <= 5 THEN fbPIDBatteryEPO.rPValue := 0.23; fbPIDBatteryEPO.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattEPO > 5 THEN fbPIDBatteryEPO.rPValue := 0.25; fbPIDBatteryEPO.udiIValue := 900;
	END_IF
ELSIF eSpeedModeLocalController = E_SpeedModeLocalController_EMS.eBalanced THEN
	IF lrErrorPIDCorrectionBattEPO <= 0.5 THEN fbPIDBatteryEPO.rPValue := 0.10; fbPIDBatteryEPO.udiIValue := 450;
	ELSIF lrErrorPIDCorrectionBattEPO > 0.5 AND lrErrorPIDCorrectionBattEPO <= 1 THEN fbPIDBatteryEPO.rPValue := 0.14; fbPIDBatteryEPO.udiIValue := 450;
	ELSIF lrErrorPIDCorrectionBattEPO > 1 AND lrErrorPIDCorrectionBattEPO <= 1.5 THEN fbPIDBatteryEPO.rPValue := 0.18; fbPIDBatteryEPO.udiIValue := 450; 
	ELSIF lrErrorPIDCorrectionBattEPO > 1.5 AND lrErrorPIDCorrectionBattEPO <= 2 THEN fbPIDBatteryEPO.rPValue := 0.22; fbPIDBatteryEPO.udiIValue := 450; 	
	ELSIF lrErrorPIDCorrectionBattEPO > 2 AND lrErrorPIDCorrectionBattEPO <= 2.5 THEN fbPIDBatteryEPO.rPValue := 0.26; fbPIDBatteryEPO.udiIValue := 675; 
	ELSIF lrErrorPIDCorrectionBattEPO > 2.5 AND lrErrorPIDCorrectionBattEPO <= 3 THEN fbPIDBatteryEPO.rPValue := 0.30; fbPIDBatteryEPO.udiIValue := 675;
	ELSIF lrErrorPIDCorrectionBattEPO > 3 AND lrErrorPIDCorrectionBattEPO <= 3.5 THEN fbPIDBatteryEPO.rPValue := 0.34; fbPIDBatteryEPO.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattEPO > 3.5 AND lrErrorPIDCorrectionBattEPO <= 4 THEN fbPIDBatteryEPO.rPValue := 0.38; fbPIDBatteryEPO.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattEPO > 4 AND lrErrorPIDCorrectionBattEPO <= 4.5 THEN fbPIDBatteryEPO.rPValue := 0.42; fbPIDBatteryEPO.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattEPO > 4.5 AND lrErrorPIDCorrectionBattEPO <= 5 THEN fbPIDBatteryEPO.rPValue := 0.46; fbPIDBatteryEPO.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionBattEPO > 5 THEN fbPIDBatteryEPO.rPValue := 0.50; fbPIDBatteryEPO.udiIValue := 900;
	END_IF
ELSIF eSpeedModeLocalController = E_SpeedModeLocalController_EMS.eFast THEN
	IF lrErrorPIDCorrectionBattEPO <= 0.5 THEN fbPIDBatteryEPO.rPValue := 0.30; fbPIDBatteryEPO.udiIValue := 275;
	ELSIF lrErrorPIDCorrectionBattEPO > 0.5 AND lrErrorPIDCorrectionBattEPO <= 1 THEN fbPIDBatteryEPO.rPValue := 0.33; fbPIDBatteryEPO.udiIValue := 275;
	ELSIF lrErrorPIDCorrectionBattEPO > 1 AND lrErrorPIDCorrectionBattEPO <= 1.5 THEN fbPIDBatteryEPO.rPValue := 0.36; fbPIDBatteryEPO.udiIValue := 275; 
	ELSIF lrErrorPIDCorrectionBattEPO > 1.5 AND lrErrorPIDCorrectionBattEPO <= 2 THEN fbPIDBatteryEPO.rPValue := 0.39; fbPIDBatteryEPO.udiIValue := 275; 	
	ELSIF lrErrorPIDCorrectionBattEPO > 2 AND lrErrorPIDCorrectionBattEPO <= 2.5 THEN fbPIDBatteryEPO.rPValue := 0.42; fbPIDBatteryEPO.udiIValue := 500; 
	ELSIF lrErrorPIDCorrectionBattEPO > 2.5 AND lrErrorPIDCorrectionBattEPO <= 3 THEN fbPIDBatteryEPO.rPValue := 0.45; fbPIDBatteryEPO.udiIValue := 500;
	ELSIF lrErrorPIDCorrectionBattEPO > 3 AND lrErrorPIDCorrectionBattEPO <= 3.5 THEN fbPIDBatteryEPO.rPValue := 0.48; fbPIDBatteryEPO.udiIValue := 750;
	ELSIF lrErrorPIDCorrectionBattEPO > 3.5 AND lrErrorPIDCorrectionBattEPO <= 4 THEN fbPIDBatteryEPO.rPValue := 0.51; fbPIDBatteryEPO.udiIValue := 750;
	ELSIF lrErrorPIDCorrectionBattEPO > 4 AND lrErrorPIDCorrectionBattEPO <= 4.5 THEN fbPIDBatteryEPO.rPValue := 0.54; fbPIDBatteryEPO.udiIValue := 750;
	ELSIF lrErrorPIDCorrectionBattEPO > 4.5 AND lrErrorPIDCorrectionBattEPO <= 5 THEN fbPIDBatteryEPO.rPValue := 0.57; fbPIDBatteryEPO.udiIValue := 750;
	ELSIF lrErrorPIDCorrectionBattEPO > 5 THEN fbPIDBatteryEPO.rPValue := 0.60; fbPIDBatteryEPO.udiIValue := 750;
	END_IF
END_IF

IF bEnable AND bEPMActive AND arrMinPrioReached[1] AND arrMinPrioReached[2] AND arrMinPrioReached[3] AND arrMinPrioReached[4] AND arrMinPrioReached[5] AND NOT bChargePrioBatterysOnEPO AND NOT bStopAll THEN
	fbPIDBatteryEPO.bEnable := TRUE;
ELSE
	fbPIDBatteryEPO.bEnable := FALSE;
END_IF

fbPIDBatteryEPO(
	bEnable:= , 
	rSetpoint:= 0, 
	udiIValue:= , 
	udiDValue:= 0, 
	udiDamping:= 0, 
	rPValue:= , 
	rMaxValue:= 100, 
	rMinValue:= 0, 
	rNeutralZone:= 0.1, 
	bDirection:= TRUE, 
	rActualValue:= LREAL_TO_REAL(lrSizeBatteryPowerInEPO), 
	rQController=> rControllerQPIDEPO);

//Set the Controller output	to 0 when we have surplus. (Because its possible that the controller output is not set 100% to 0 regarding internal discrepancies)
IF rControllerQPIDEPO <= 0.4 AND fbPIDBatteryEPO.bEnable AND lrSizeBatteryPowerInEPO <= - Constants_Energy.rToleranceSurplusConsumption THEN
	timPIDEPO.IN := TRUE;
ELSE
	timPIDEPO.IN := FALSE;
END_IF
	
timPIDEPO(IN:= , PT:= T#15S, Q=> , ET=> );
	IF timPIDEPO.Q THEN rControllerQPIDEPO := 0; END_IF

FOR liLPDataBatteryInverter := 1 TO Constants_Energy.diMaxNumberOfBatteryInverters BY 1 DO
	IF Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPDataBatteryInverter].byPriority <> 0 AND bEPMActive AND NOT Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPDataBatteryInverter].bWorkOnIslandMode AND 
		 arrMinPrioReached[1] AND arrMinPrioReached[2] AND arrMinPrioReached[3] AND arrMinPrioReached[4] AND arrMinPrioReached[5] AND NOT bChargePrioBatterysOnEPO THEN
			Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPDataBatteryInverter].rTargetPowerEMS := rControllerQPIDEPO;
	END_IF
END_FOR 

(*-----------------------------------------------------------Controll the Batterys and Heating pumps with the Backend Commands-----------------------------------------------------------------*)

//Controll the Heating Pumps
FOR liLPDischrgCmdFromBackend := 1 TO Constants_Energy.diMaxNumberOfHeatingPumps BY 1 DO  
	IF timErrorWarning.Q AND timEnergyOptReady.Q AND NOT timHB.Q THEN 
		Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPDischrgCmdFromBackend].bExternalOnCommand := bActivateHP; 
	ELSE
		Lynus_Standards.GVL_Energy.stDataHeatingPumps[diNrOfEMS_OUT,liLPDischrgCmdFromBackend].bExternalOnCommand := FALSE;
	END_IF
END_FOR
	//Reset the Activation from the HP (Maybe when we have communicaiton Error with the backend in this time when he well reset the command or somthing else...)
	timResetActivateHP(IN:= bActivateHP, PT:= T#2M, Q=> , ET=> );
		IF timResetActivateHP.Q THEN bActivateHP := FALSE; END_IF

//Controll the discharge power from the Batterys with the power command from the Backend
//Calculate the actual Battery Power
lrActualPowerBatterys := 0;
	FOR liLPDischrgCmdFromBackend := 1 TO Constants_Energy.diMaxNumberOfBatterys BY 1 DO
		lrActualPowerBatterys := lrActualPowerBatterys + Lynus_Standards.GVL_Energy.stDataOfBatterys[diNrOfEMS_OUT,liLPDischrgCmdFromBackend].lrPower;	
	END_FOR

//Reset the Controller when we have surplus in the slef consumption mode
IF bSurplusAvailable AND eOperationMode = E_OperatingMode_EMS.eSelfConsumption THEN 
	timPIDDischrgCmdFromBackend.IN := TRUE;
ELSE
	timPIDDischrgCmdFromBackend.IN := FALSE;
END_IF

//Reset the Controller when we have surplus in the Load capping or load management mode
IF ((eOperationMode = E_OperatingMode_EMS.eLoadManagement OR eOperationMode = E_OperatingMode_EMS.ePeakLoadCapping) AND (lrGridPower < (lrSizeGridConnection * 0.95))) THEN
	timPIDDischrgCmdFromBackend.IN := TRUE;
END_IF
	IF ((eOperationMode = E_OperatingMode_EMS.eLoadManagement OR eOperationMode = E_OperatingMode_EMS.ePeakLoadCapping) AND (lrGridPower >= (lrSizeGridConnection * 0.95))) THEN
		timPIDDischrgCmdFromBackend.IN := FALSE;
	END_IF	  

//Give the Controller 35 Seconds Time. So he can make 3 times a correction for the power when the Backend commands to much Battery power.
timPIDDischrgCmdFromBackend(IN:= , PT:= T#35S, Q=> , ET=> );

//Enable or dissable the controller when Self Consumption mode is active
IF bEnable AND NOT bEPMActive AND NOT bStopAll AND bDischrgCmdFromBackendOK AND eOperationMode <> E_OperatingMode_EMS.eAllOff AND diMemCmpOperationState = 0 AND 
	arrMinPrioReached[1] AND arrMinPrioReached[2] AND arrMinPrioReached[3] AND arrMinPrioReached[4] AND arrMinPrioReached[5] AND NOT timPIDDischrgCmdFromBackend.Q AND eOperationMode = E_OperatingMode_EMS.eSelfConsumption THEN
		fbPIDDischrgCmdFromBackend.bEnable := TRUE;
ELSE
		fbPIDDischrgCmdFromBackend.bEnable := FALSE;
END_IF	

//Enable or dissable the controller when Paeak Load capping or load management mode is active
IF bEnable AND NOT bEPMActive AND NOT bStopAll AND bDischrgCmdFromBackendOK AND eOperationMode <> E_OperatingMode_EMS.eAllOff AND diMemCmpOperationState = 0 AND 
	eOperationMode = E_OperatingMode_EMS.eLoadManagement AND NOT fbPIDBatteryPLCLM_Chrg.bEnable AND NOT timPIDDischrgCmdFromBackend.Q THEN
		fbPIDDischrgCmdFromBackend.bEnable := TRUE;
END_IF	
	IF eOperationMode = E_OperatingMode_EMS.eLoadManagement AND (NOT bEnable OR diNumberOfActiveBatterys = 0 OR bEPMActive OR bStopAll OR fbPIDBatteryPLCLM_Chrg.bEnable OR timPIDDischrgCmdFromBackend.Q) THEN fbPIDDischrgCmdFromBackend.bEnable := FALSE; END_IF

IF bEnable AND NOT bEPMActive AND NOT bStopAll AND bDischrgCmdFromBackendOK AND eOperationMode <> E_OperatingMode_EMS.eAllOff AND diMemCmpOperationState = 0 AND 
	eOperationMode = E_OperatingMode_EMS.ePeakLoadCapping AND NOT fbPIDBatteryPLCLM_Chrg.bEnable AND NOT timPIDDischrgCmdFromBackend.Q THEN
		fbPIDDischrgCmdFromBackend.bEnable := TRUE;
END_IF	
	IF eOperationMode = E_OperatingMode_EMS.ePeakLoadCapping AND (NOT bEnable OR diNumberOfActiveBatterys = 0 OR bEPMActive OR bStopAll OR fbPIDBatteryPLCLM_Chrg.bEnable OR timPIDDischrgCmdFromBackend.Q) THEN fbPIDDischrgCmdFromBackend.bEnable := FALSE; END_IF 

//Correction and safety for the Setpoint, that we dont give power back to the grid
//Set one time the new received Battery power and make then the correction (New reveived value from Backend or the PID Controller start from new)
FPEnablePID(CLK:= fbPIDDischrgCmdFromBackend.bEnable, Q=> );
	IF rNewBattPower <> rNewBattPower_CP OR FPEnablePID.Q THEN
		lrNewBatteryPowerWithCorrection := rNewBattPower;
			rNewBattPower_CP := rNewBattPower;
	END_IF

//Give the Controller and the Inverter time to set the new Setpoint
IF lrGridPower <> lrGridPower_CP AND NOT timCorrectionSetpoint.Q  AND bDischrgCmdFromBackendOK THEN
	timCorrectionSetpoint.IN := TRUE;
		lrGridPower_CP := lrGridPower;
ELSE
	timCorrectionSetpoint.IN := FALSE;
END_IF	 

//Make the correction a litte bit faster when the power on the grid is not so big
timCorrectionSetpoint.PT := T#10S;
IF lrGridPower >= - 0.30 AND lrGridPower <= 0.30 THEN timCorrectionSetpoint.PT := T#7.5S; END_IF
IF lrGridPower >= - 0.20 AND lrGridPower <= 0.20 THEN timCorrectionSetpoint.PT := T#5S; END_IF

timCorrectionSetpoint(IN:= , PT:= , Q=> , ET=> );
	FPMakeCorrection(CLK:= timCorrectionSetpoint.Q, Q=> );

//Batterycorrection when Self Consumption Mode is active
IF FPMakeCorrection.Q AND eOperationMode = E_OperatingMode_EMS.eSelfConsumption THEN
	lrNewBatteryPowerWithCorrection := lrNewBatteryPowerWithCorrection + lrGridPower;
END_IF
	//Batterycorrection when Peak load capping or load management Mode is active
	IF FPMakeCorrection.Q AND eOperationMode = E_OperatingMode_EMS.eLoadManagement OR eOperationMode = E_OperatingMode_EMS.ePeakLoadCapping THEN
		lrNewBatteryPowerWithCorrection := (lrNewBatteryPowerWithCorrection + (lrGridPower - (lrSizeGridConnection * 0.96)));
	END_IF

IF lrNewBatteryPowerWithCorrection < 0 THEN lrNewBatteryPowerWithCorrection := 0; END_IF
	IF lrNewBatteryPowerWithCorrection > rNewBattPower THEN lrNewBatteryPowerWithCorrection := rNewBattPower; END_IF 

lrErrorPIDCorrectionDischrgCmdFromBackend := ABS(lrNewBatteryPowerWithCorrection - lrActualPowerBatterys);

//Controller weighting
IF eSpeedModeBackendController = E_SpeedModeBackendController_EMS.eSlow THEN
	IF lrErrorPIDCorrectionDischrgCmdFromBackend <= 0.5 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.05; fbPIDDischrgCmdFromBackend.udiIValue := 450;
	ELSIF lrErrorPIDCorrectionDischrgCmdFromBackend > 0.5 AND lrErrorPIDCorrectionDischrgCmdFromBackend <= 1 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.07; fbPIDDischrgCmdFromBackend.udiIValue := 450;
	ELSIF lrErrorPIDCorrectionDischrgCmdFromBackend > 1 AND lrErrorPIDCorrectionDischrgCmdFromBackend <= 1.5 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.09; fbPIDDischrgCmdFromBackend.udiIValue := 450; 
	ELSIF lrErrorPIDCorrectionDischrgCmdFromBackend > 1.5 AND lrErrorPIDCorrectionDischrgCmdFromBackend <= 2 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.11; fbPIDDischrgCmdFromBackend.udiIValue := 450; 	
	ELSIF lrErrorPIDCorrectionDischrgCmdFromBackend > 2 AND lrErrorPIDCorrectionDischrgCmdFromBackend <= 2.5 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.13; fbPIDDischrgCmdFromBackend.udiIValue := 675; 
	ELSIF lrErrorPIDCorrectionDischrgCmdFromBackend > 2.5 AND lrErrorPIDCorrectionDischrgCmdFromBackend <= 3 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.15; fbPIDDischrgCmdFromBackend.udiIValue := 675;
	ELSIF lrErrorPIDCorrectionDischrgCmdFromBackend > 3 AND lrErrorPIDCorrectionDischrgCmdFromBackend <= 3.5 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.17; fbPIDDischrgCmdFromBackend.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionDischrgCmdFromBackend > 3.5 AND lrErrorPIDCorrectionDischrgCmdFromBackend <= 4 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.19; fbPIDDischrgCmdFromBackend.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionDischrgCmdFromBackend > 4 AND lrErrorPIDCorrectionDischrgCmdFromBackend <= 4.5 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.21; fbPIDDischrgCmdFromBackend.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionDischrgCmdFromBackend > 4.5 AND lrErrorPIDCorrectionDischrgCmdFromBackend <= 5 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.23; fbPIDDischrgCmdFromBackend.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionDischrgCmdFromBackend > 5 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.25; fbPIDDischrgCmdFromBackend.udiIValue := 900;
	END_IF
ELSIF eSpeedModeBackendController = E_SpeedModeBackendController_EMS.eBalanced THEN
	IF lrErrorPIDCorrectionDischrgCmdFromBackend <= 0.5 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.10; fbPIDDischrgCmdFromBackend.udiIValue := 450;
	ELSIF lrErrorPIDCorrectionDischrgCmdFromBackend > 0.5 AND lrErrorPIDCorrectionDischrgCmdFromBackend <= 1 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.14; fbPIDDischrgCmdFromBackend.udiIValue := 450;
	ELSIF lrErrorPIDCorrectionDischrgCmdFromBackend > 1 AND lrErrorPIDCorrectionDischrgCmdFromBackend <= 1.5 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.18; fbPIDDischrgCmdFromBackend.udiIValue := 450; 
	ELSIF lrErrorPIDCorrectionDischrgCmdFromBackend > 1.5 AND lrErrorPIDCorrectionDischrgCmdFromBackend <= 2 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.22; fbPIDDischrgCmdFromBackend.udiIValue := 450; 	
	ELSIF lrErrorPIDCorrectionDischrgCmdFromBackend > 2 AND lrErrorPIDCorrectionDischrgCmdFromBackend <= 2.5 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.26; fbPIDDischrgCmdFromBackend.udiIValue := 675; 
	ELSIF lrErrorPIDCorrectionDischrgCmdFromBackend > 2.5 AND lrErrorPIDCorrectionDischrgCmdFromBackend <= 3 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.30; fbPIDDischrgCmdFromBackend.udiIValue := 675;
	ELSIF lrErrorPIDCorrectionDischrgCmdFromBackend > 3 AND lrErrorPIDCorrectionDischrgCmdFromBackend <= 3.5 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.34; fbPIDDischrgCmdFromBackend.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionDischrgCmdFromBackend > 3.5 AND lrErrorPIDCorrectionDischrgCmdFromBackend <= 4 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.38; fbPIDDischrgCmdFromBackend.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionDischrgCmdFromBackend > 4 AND lrErrorPIDCorrectionDischrgCmdFromBackend <= 4.5 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.42; fbPIDDischrgCmdFromBackend.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionDischrgCmdFromBackend > 4.5 AND lrErrorPIDCorrectionDischrgCmdFromBackend <= 5 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.46; fbPIDDischrgCmdFromBackend.udiIValue := 900;
	ELSIF lrErrorPIDCorrectionDischrgCmdFromBackend > 5 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.50; fbPIDDischrgCmdFromBackend.udiIValue := 900;
	END_IF
ELSIF eSpeedModeBackendController = E_SpeedModeBackendController_EMS.eFast THEN
	IF lrErrorPIDCorrectionDischrgCmdFromBackend <= 0.5 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.40; fbPIDDischrgCmdFromBackend.udiIValue := 275;
	ELSIF lrErrorPIDCorrectionDischrgCmdFromBackend > 0.5 AND lrErrorPIDCorrectionDischrgCmdFromBackend <= 1 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.42; fbPIDDischrgCmdFromBackend.udiIValue := 275;
	ELSIF lrErrorPIDCorrectionDischrgCmdFromBackend > 1 AND lrErrorPIDCorrectionDischrgCmdFromBackend <= 1.5 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.44; fbPIDDischrgCmdFromBackend.udiIValue := 275; 
	ELSIF lrErrorPIDCorrectionDischrgCmdFromBackend > 1.5 AND lrErrorPIDCorrectionDischrgCmdFromBackend <= 2 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.46; fbPIDDischrgCmdFromBackend.udiIValue := 275; 	
	ELSIF lrErrorPIDCorrectionDischrgCmdFromBackend > 2 AND lrErrorPIDCorrectionDischrgCmdFromBackend <= 2.5 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.48; fbPIDDischrgCmdFromBackend.udiIValue := 500; 
	ELSIF lrErrorPIDCorrectionDischrgCmdFromBackend > 2.5 AND lrErrorPIDCorrectionDischrgCmdFromBackend <= 3 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.50; fbPIDDischrgCmdFromBackend.udiIValue := 500;
	ELSIF lrErrorPIDCorrectionDischrgCmdFromBackend > 3 AND lrErrorPIDCorrectionDischrgCmdFromBackend <= 3.5 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.52; fbPIDDischrgCmdFromBackend.udiIValue := 750;
	ELSIF lrErrorPIDCorrectionDischrgCmdFromBackend > 3.5 AND lrErrorPIDCorrectionDischrgCmdFromBackend <= 4 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.54; fbPIDDischrgCmdFromBackend.udiIValue := 750;
	ELSIF lrErrorPIDCorrectionDischrgCmdFromBackend > 4 AND lrErrorPIDCorrectionDischrgCmdFromBackend <= 4.5 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.56; fbPIDDischrgCmdFromBackend.udiIValue := 750;
	ELSIF lrErrorPIDCorrectionDischrgCmdFromBackend > 4.5 AND lrErrorPIDCorrectionDischrgCmdFromBackend <= 5 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.58; fbPIDDischrgCmdFromBackend.udiIValue := 750;
	ELSIF lrErrorPIDCorrectionDischrgCmdFromBackend > 5 THEN fbPIDDischrgCmdFromBackend.rPValue := 0.60; fbPIDDischrgCmdFromBackend.udiIValue := 750;
	END_IF
END_IF

fbPIDDischrgCmdFromBackend(
	bEnable:= , 
	rSetpoint:= LREAL_TO_REAL(lrNewBatteryPowerWithCorrection), 
	udiIValue:= , 
	udiDValue:= 0, 
	udiDamping:= 0, 
	rPValue:= , 
	rMaxValue:= 100, 
	rMinValue:= 0,
	rNeutralZone:= 0.1, 
	bDirection:= FALSE, 
	rActualValue:= LREAL_TO_REAL(lrActualPowerBatterys), 
	rQController=> rControllerQPIDDischrgCmdFromBackend);

IF eOperationMode = E_OperatingMode_EMS.eSelfConsumption THEN 
	FOR liLPDischrgCmdFromBackend := 1 TO Constants_Energy.diMaxNumberOfBatteryInverters BY 1 DO
		IF Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPDischrgCmdFromBackend].byPriority <> 0 AND NOT bEPMActive AND bDischrgCmdFromBackendOK AND	
			arrMinPrioReached[1] AND arrMinPrioReached[2] AND arrMinPrioReached[3] AND arrMinPrioReached[4] AND arrMinPrioReached[5] THEN
				Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPDischrgCmdFromBackend].rTargetPowerEMS := rControllerQPIDDischrgCmdFromBackend;
		END_IF 
	END_FOR	
ELSE
	FOR liLPDischrgCmdFromBackend := 1 TO Constants_Energy.diMaxNumberOfBatteryInverters BY 1 DO
		IF Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPDischrgCmdFromBackend].byPriority <> 0 AND NOT bEPMActive AND fbPIDDischrgCmdFromBackend.bEnable THEN
			Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPDischrgCmdFromBackend].rTargetPowerEMS := rControllerQPIDDischrgCmdFromBackend;
		END_IF 
	END_FOR	
END_IF

//On this Modes set the Battery Power to 0 when no charge and no discharge controller is active
IF eOperationMode = E_OperatingMode_EMS.eLoadManagement OR eOperationMode = E_OperatingMode_EMS.ePeakLoadCapping THEN
	IF NOT fbPIDBatteryPLCLM_Chrg.bEnable AND NOT fbPIDBatteryPLCLM_Dischrg.bEnable AND NOT fbPIDDischrgCmdFromBackend.bEnable THEN
		FOR liLPDischrgCmdFromBackend := 1 TO Constants_Energy.diMaxNumberOfBatteryInverters BY 1 DO
			Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPDischrgCmdFromBackend].rTargetPowerEMS := 0;
		END_FOR	
	END_IF
END_IF	    

(*------------------------------------------------------------------------------Progress and State----------------------------------------------------------------------------------------*)
	
IF NOT arrMinPrioReached[1] AND NOT arrMinPrioReached[2] AND NOT arrMinPrioReached[3] AND NOT arrMinPrioReached[4] AND NOT arrMinPrioReached[5] THEN
	byProgress := REAL_TO_BYTE(F_Scalvalue(x:= UINT_TO_REAL(uiState), x1:= 0, y1:= 0, x2:= 110, y2:= 100));
ELSE
	byProgress := 100;
END_IF 
	byProgress := LIMIT(0,byProgress,100);

uiState_OUT := uiState;
	
(*-----------------------------------------------------------Write data to Global structure for batterys and battery inverters-----------------------------------------------------------------*)

FOR liLPBatterysSetupData := 1 TO Constants_Energy.diMaxNumberOfBatteryInverters BY 1 DO
	Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPBatterysSetupData].byReserveSOCEPO := stSetupEMS.byReserveSOCEPO;
		Lynus_Standards.GVL_Energy.stDataOfBatteryInverters[diNrOfEMS_OUT,liLPBatterysSetupData].byMaxDepthOfDischargeEPO := stSetupEMS.byMaxDepthOfDischrgEPO;	
END_FOR

(*----------------------------------------------------------Handle messages from this device-----------------------------------------------------------------*)

fbMessagesEMS.wMessageCode := 0;

IF arrMinPrioReached[1] AND arrMinPrioReached[2] AND arrMinPrioReached[3] AND arrMinPrioReached[4] AND arrMinPrioReached[5] THEN fbMessagesEMS.wMessageCode := 1; END_IF
IF arrMaxPrioReached[1] AND arrMaxPrioReached[2] AND arrMaxPrioReached[3] AND arrMaxPrioReached[4] AND arrMaxPrioReached[5] THEN fbMessagesEMS.wMessageCode := 2; END_IF
IF bMissingPowerData THEN fbMessagesEMS.wMessageCode := 3; END_IF
IF bStopAll THEN fbMessagesEMS.wMessageCode := 4; END_IF
IF bStopAll AND timDissableFunctions.Q THEN fbMessagesEMS.wMessageCode := 5; END_IF

fbMessagesEMS(bEnable:= bEnable, wMessageCode:= , eMessageEMS=> eMessageEMS);

(*----------------------------------------------------------Save persistent data----------------------------------------------------------------*)

arrPD[1](lrValue:= BOOL_TO_LREAL(bEnable), bEventBasedActive=> );
arrPD[2](lrValue:= BYTE_TO_LREAL(stSetupEMS.byReserveSOCEPO), bEventBasedActive=> );
arrPD[3](lrValue:= BYTE_TO_LREAL(stSetupEMS.byMaxDepthOfDischrgEPO), bEventBasedActive=> );
arrPD[4](lrValue:= BYTE_TO_LREAL(stSetupEMS.byResChrgGridToBatt), bEventBasedActive=> );
arrPD[5](lrValue:= INT_TO_LREAL(eOperationMode), bEventBasedActive=> );
arrPD[6](lrValue:= UINT_TO_LREAL(stSetupEMS.uiUpdateTime), bEventBasedActive=> );
arrPD[7](lrValue:= INT_TO_LREAL(eSpeedModeBackendController), bEventBasedActive=> );
arrPD[8](lrValue:= BOOL_TO_LREAL(stSetupEMS.bAllowChrgFromGrid), bEventBasedActive=> );
arrPD[9](lrValue:= BOOL_TO_LREAL(stSetupEMS.bEnableMainFuseFunc), bEventBasedActive=> );
arrPD[10](lrValue:= BYTE_TO_LREAL(stSetupEMS.byPrioChrgBattSOCInEPO), bEventBasedActive=> );
arrPD[11](lrValue:= DINT_TO_LREAL(stNrOfEM_IN_ECS.diNrOfLine1), bEventBasedActive=> );
arrPD[12](lrValue:= DINT_TO_LREAL(stNrOfEM_IN_ECS.diNrOfLine2), bEventBasedActive=> );
arrPD[13](lrValue:= DINT_TO_LREAL(stNrOfEM_IN_ECS.diNrOfLine3), bEventBasedActive=> );
arrPD[14](lrValue:= DINT_TO_LREAL(stNrOfEM_IN_ECS.diNrOfLine4), bEventBasedActive=> );
arrPD[15](lrValue:= DINT_TO_LREAL(stNrOfEM_IN_ECS.diNrOfLine5), bEventBasedActive=> );
arrPD[16](lrValue:= DINT_TO_LREAL(stNrOfEM_IN_ECS.diNrOfLine6), bEventBasedActive=> );
arrPD[17](lrValue:= DINT_TO_LREAL(stNrOfEM_IN_ECS.diNrOfLine7), bEventBasedActive=> );
arrPD[18](lrValue:= DINT_TO_LREAL(stNrOfEM_IN_ECS.diNrOfLine8), bEventBasedActive=> );
arrPD[19](lrValue:= DINT_TO_LREAL(stNrOfEM_IN_ECS.diNrOfLine9), bEventBasedActive=> );
arrPD[20](lrValue:= DINT_TO_LREAL(stNrOfEM_IN_ECS.diNrOfLine10), bEventBasedActive=> );
arrPD[21](lrValue:= DINT_TO_LREAL(stNrOfEM_IN_ECS.diNrOfLine11), bEventBasedActive=> );
arrPD[22](lrValue:= DINT_TO_LREAL(stNrOfEM_IN_ECS.diNrOfLine12), bEventBasedActive=> );
arrPD[23](lrValue:= DINT_TO_LREAL(stNrOfEM_IN_ECS.diNrOfLine13), bEventBasedActive=> );
arrPD[24](lrValue:= DINT_TO_LREAL(stNrOfEM_IN_ECS.diNrOfLine14), bEventBasedActive=> );
arrPD[25](lrValue:= DINT_TO_LREAL(stNrOfEM_IN_ECS.diNrOfLine15), bEventBasedActive=> );
arrPD[26](lrValue:= DINT_TO_LREAL(stNrOfEM_IN_ECS.diNrOfLine16), bEventBasedActive=> );
arrPD[27](lrValue:= DINT_TO_LREAL(stNrOfEM_IN_ECS.diNrOfLine17), bEventBasedActive=> );
arrPD[28](lrValue:= DINT_TO_LREAL(stNrOfEM_IN_ECS.diNrOfLine18), bEventBasedActive=> );
arrPD[29](lrValue:= DINT_TO_LREAL(stNrOfEM_IN_ECS.diNrOfLine19), bEventBasedActive=> );
arrPD[30](lrValue:= DINT_TO_LREAL(stNrOfEM_IN_ECS.diNrOfLine20), bEventBasedActive=> );
arrPD[31](lrValue:= DINT_TO_LREAL(stNrOfEM_IN_ECS.diNrOfLine21), bEventBasedActive=> );
arrPD[32](lrValue:= DINT_TO_LREAL(stNrOfEM_IN_ECS.diNrOfLine22), bEventBasedActive=> );
arrPD[33](lrValue:= DINT_TO_LREAL(stNrOfEM_IN_ECS.diNrOfLine23), bEventBasedActive=> );
arrPD[34](lrValue:= DINT_TO_LREAL(stNrOfEM_IN_ECS.diNrOfLine24), bEventBasedActive=> );
arrPD[35](lrValue:= DINT_TO_LREAL(stNrOfEM_IN_ECS.diNrOfLine25), bEventBasedActive=> );
arrPD[36](lrValue:= DINT_TO_LREAL(stNrOfEM_IN_ECS.diNrOfLine26), bEventBasedActive=> );
arrPD[37](lrValue:= DINT_TO_LREAL(stNrOfEM_IN_ECS.diNrOfLine27), bEventBasedActive=> );
arrPD[38](lrValue:= DINT_TO_LREAL(stNrOfEM_IN_ECS.diNrOfLine28), bEventBasedActive=> );
arrPD[39](lrValue:= DINT_TO_LREAL(stNrOfEM_IN_ECS.diNrOfLine29), bEventBasedActive=> );
arrPD[40](lrValue:= DINT_TO_LREAL(stNrOfEM_IN_ECS.diNrOfLine30), bEventBasedActive=> );
arrPD[41](lrValue:= REAL_TO_LREAL(stSizeMainFuseCS.rElSizeLine1), bEventBasedActive=> );
arrPD[42](lrValue:= REAL_TO_LREAL(stSizeMainFuseCS.rElSizeLine2), bEventBasedActive=> );
arrPD[43](lrValue:= REAL_TO_LREAL(stSizeMainFuseCS.rElSizeLine3), bEventBasedActive=> );
arrPD[44](lrValue:= REAL_TO_LREAL(stSizeMainFuseCS.rElSizeLine4), bEventBasedActive=> );
arrPD[45](lrValue:= REAL_TO_LREAL(stSizeMainFuseCS.rElSizeLine5), bEventBasedActive=> );
arrPD[46](lrValue:= REAL_TO_LREAL(stSizeMainFuseCS.rElSizeLine6), bEventBasedActive=> );
arrPD[47](lrValue:= REAL_TO_LREAL(stSizeMainFuseCS.rElSizeLine7), bEventBasedActive=> );
arrPD[48](lrValue:= REAL_TO_LREAL(stSizeMainFuseCS.rElSizeLine8), bEventBasedActive=> );
arrPD[49](lrValue:= REAL_TO_LREAL(stSizeMainFuseCS.rElSizeLine9), bEventBasedActive=> );
arrPD[50](lrValue:= REAL_TO_LREAL(stSizeMainFuseCS.rElSizeLine10), bEventBasedActive=> );
arrPD[51](lrValue:= REAL_TO_LREAL(stSizeMainFuseCS.rElSizeLine11), bEventBasedActive=> );
arrPD[52](lrValue:= REAL_TO_LREAL(stSizeMainFuseCS.rElSizeLine12), bEventBasedActive=> );
arrPD[53](lrValue:= REAL_TO_LREAL(stSizeMainFuseCS.rElSizeLine13), bEventBasedActive=> );
arrPD[54](lrValue:= REAL_TO_LREAL(stSizeMainFuseCS.rElSizeLine14), bEventBasedActive=> );
arrPD[55](lrValue:= REAL_TO_LREAL(stSizeMainFuseCS.rElSizeLine15), bEventBasedActive=> );
arrPD[56](lrValue:= REAL_TO_LREAL(stSizeMainFuseCS.rElSizeLine16), bEventBasedActive=> );
arrPD[57](lrValue:= REAL_TO_LREAL(stSizeMainFuseCS.rElSizeLine17), bEventBasedActive=> );
arrPD[58](lrValue:= REAL_TO_LREAL(stSizeMainFuseCS.rElSizeLine18), bEventBasedActive=> );
arrPD[59](lrValue:= REAL_TO_LREAL(stSizeMainFuseCS.rElSizeLine19), bEventBasedActive=> );
arrPD[60](lrValue:= REAL_TO_LREAL(stSizeMainFuseCS.rElSizeLine20), bEventBasedActive=> );
arrPD[61](lrValue:= REAL_TO_LREAL(stSizeMainFuseCS.rElSizeLine21), bEventBasedActive=> );
arrPD[62](lrValue:= REAL_TO_LREAL(stSizeMainFuseCS.rElSizeLine22), bEventBasedActive=> );
arrPD[63](lrValue:= REAL_TO_LREAL(stSizeMainFuseCS.rElSizeLine23), bEventBasedActive=> );
arrPD[64](lrValue:= REAL_TO_LREAL(stSizeMainFuseCS.rElSizeLine24), bEventBasedActive=> );
arrPD[65](lrValue:= REAL_TO_LREAL(stSizeMainFuseCS.rElSizeLine25), bEventBasedActive=> );
arrPD[66](lrValue:= REAL_TO_LREAL(stSizeMainFuseCS.rElSizeLine26), bEventBasedActive=> );
arrPD[67](lrValue:= REAL_TO_LREAL(stSizeMainFuseCS.rElSizeLine27), bEventBasedActive=> );
arrPD[68](lrValue:= REAL_TO_LREAL(stSizeMainFuseCS.rElSizeLine28), bEventBasedActive=> );
arrPD[69](lrValue:= REAL_TO_LREAL(stSizeMainFuseCS.rElSizeLine29), bEventBasedActive=> );
arrPD[70](lrValue:= REAL_TO_LREAL(stSizeMainFuseCS.rElSizeLine30), bEventBasedActive=> );
]]></ST>
    </Implementation>
    <LineIds Name="FB_EMS_V2_T">
      <LineId Id="5580" Count="2" />
      <LineId Id="5578" Count="1" />
      <LineId Id="9" Count="1" />
      <LineId Id="15" Count="0" />
      <LineId Id="5583" Count="4" />
      <LineId Id="14204" Count="0" />
      <LineId Id="5588" Count="1" />
      <LineId Id="5735" Count="0" />
      <LineId Id="7297" Count="4" />
      <LineId Id="6239" Count="0" />
      <LineId Id="6678" Count="1" />
      <LineId Id="6243" Count="0" />
      <LineId Id="26" Count="0" />
      <LineId Id="25" Count="0" />
      <LineId Id="14109" Count="1" />
      <LineId Id="14113" Count="9" />
      <LineId Id="14124" Count="8" />
      <LineId Id="14123" Count="0" />
      <LineId Id="14134" Count="8" />
      <LineId Id="14133" Count="0" />
      <LineId Id="14143" Count="11" />
      <LineId Id="14156" Count="8" />
      <LineId Id="14155" Count="0" />
      <LineId Id="14166" Count="8" />
      <LineId Id="14165" Count="0" />
      <LineId Id="14111" Count="0" />
      <LineId Id="28" Count="0" />
      <LineId Id="94" Count="0" />
      <LineId Id="758" Count="0" />
      <LineId Id="6238" Count="0" />
      <LineId Id="7343" Count="2" />
      <LineId Id="14694" Count="0" />
      <LineId Id="14112" Count="0" />
      <LineId Id="2219" Count="1" />
      <LineId Id="14175" Count="8" />
      <LineId Id="14185" Count="8" />
      <LineId Id="14184" Count="0" />
      <LineId Id="14195" Count="8" />
      <LineId Id="14194" Count="0" />
      <LineId Id="95" Count="0" />
      <LineId Id="65" Count="0" />
      <LineId Id="67" Count="5" />
      <LineId Id="6040" Count="0" />
      <LineId Id="5944" Count="0" />
      <LineId Id="6221" Count="1" />
      <LineId Id="6230" Count="0" />
      <LineId Id="6542" Count="0" />
      <LineId Id="6546" Count="17" />
      <LineId Id="6580" Count="0" />
      <LineId Id="6543" Count="0" />
      <LineId Id="6941" Count="1" />
      <LineId Id="6959" Count="0" />
      <LineId Id="6973" Count="9" />
      <LineId Id="7001" Count="1" />
      <LineId Id="7004" Count="0" />
      <LineId Id="7003" Count="0" />
      <LineId Id="7338" Count="3" />
      <LineId Id="7853" Count="0" />
      <LineId Id="6983" Count="1" />
      <LineId Id="6971" Count="0" />
      <LineId Id="6970" Count="0" />
      <LineId Id="7988" Count="60" />
      <LineId Id="9855" Count="0" />
      <LineId Id="8049" Count="2" />
      <LineId Id="9856" Count="0" />
      <LineId Id="8052" Count="0" />
      <LineId Id="9857" Count="2" />
      <LineId Id="8053" Count="2" />
      <LineId Id="10000" Count="1" />
      <LineId Id="10007" Count="0" />
      <LineId Id="10006" Count="0" />
      <LineId Id="8056" Count="0" />
      <LineId Id="10009" Count="0" />
      <LineId Id="10008" Count="0" />
      <LineId Id="10029" Count="6" />
      <LineId Id="10039" Count="1" />
      <LineId Id="10061" Count="0" />
      <LineId Id="10038" Count="0" />
      <LineId Id="10036" Count="0" />
      <LineId Id="11970" Count="0" />
      <LineId Id="10002" Count="0" />
      <LineId Id="11981" Count="2" />
      <LineId Id="12765" Count="0" />
      <LineId Id="11974" Count="1" />
      <LineId Id="11977" Count="0" />
      <LineId Id="11972" Count="0" />
      <LineId Id="11978" Count="2" />
      <LineId Id="11971" Count="0" />
      <LineId Id="11984" Count="0" />
      <LineId Id="8057" Count="28" />
      <LineId Id="10012" Count="0" />
      <LineId Id="8087" Count="7" />
      <LineId Id="10042" Count="0" />
      <LineId Id="8096" Count="35" />
      <LineId Id="12138" Count="0" />
      <LineId Id="12133" Count="0" />
      <LineId Id="13969" Count="0" />
      <LineId Id="13967" Count="0" />
      <LineId Id="12135" Count="2" />
      <LineId Id="12134" Count="0" />
      <LineId Id="8133" Count="1" />
      <LineId Id="12141" Count="0" />
      <LineId Id="8136" Count="16" />
      <LineId Id="12147" Count="0" />
      <LineId Id="12131" Count="0" />
      <LineId Id="13970" Count="0" />
      <LineId Id="13968" Count="0" />
      <LineId Id="14844" Count="1" />
      <LineId Id="13966" Count="0" />
      <LineId Id="12132" Count="0" />
      <LineId Id="8154" Count="17" />
      <LineId Id="10045" Count="0" />
      <LineId Id="8173" Count="18" />
      <LineId Id="10016" Count="0" />
      <LineId Id="8192" Count="55" />
      <LineId Id="10046" Count="0" />
      <LineId Id="10048" Count="0" />
      <LineId Id="10047" Count="0" />
      <LineId Id="8248" Count="1" />
      <LineId Id="10017" Count="0" />
      <LineId Id="8250" Count="127" />
      <LineId Id="10049" Count="0" />
      <LineId Id="10051" Count="0" />
      <LineId Id="10050" Count="0" />
      <LineId Id="8378" Count="1" />
      <LineId Id="10018" Count="0" />
      <LineId Id="8380" Count="420" />
      <LineId Id="10052" Count="0" />
      <LineId Id="10054" Count="0" />
      <LineId Id="10053" Count="0" />
      <LineId Id="8801" Count="1" />
      <LineId Id="10020" Count="0" />
      <LineId Id="8803" Count="54" />
      <LineId Id="10055" Count="0" />
      <LineId Id="10057" Count="0" />
      <LineId Id="10056" Count="0" />
      <LineId Id="15008" Count="0" />
      <LineId Id="15010" Count="0" />
      <LineId Id="15020" Count="0" />
      <LineId Id="15022" Count="1" />
      <LineId Id="15014" Count="0" />
      <LineId Id="15021" Count="0" />
      <LineId Id="15013" Count="0" />
      <LineId Id="15016" Count="0" />
      <LineId Id="15026" Count="1" />
      <LineId Id="15032" Count="0" />
      <LineId Id="15031" Count="0" />
      <LineId Id="15030" Count="0" />
      <LineId Id="15033" Count="1" />
      <LineId Id="15029" Count="0" />
      <LineId Id="15028" Count="0" />
      <LineId Id="15018" Count="1" />
      <LineId Id="15025" Count="0" />
      <LineId Id="15017" Count="0" />
      <LineId Id="15015" Count="0" />
      <LineId Id="15046" Count="0" />
      <LineId Id="15042" Count="3" />
      <LineId Id="15041" Count="0" />
      <LineId Id="15012" Count="0" />
      <LineId Id="15024" Count="0" />
      <LineId Id="15009" Count="0" />
      <LineId Id="8858" Count="1" />
      <LineId Id="10022" Count="0" />
      <LineId Id="8860" Count="53" />
      <LineId Id="10058" Count="0" />
      <LineId Id="10060" Count="0" />
      <LineId Id="10059" Count="0" />
      <LineId Id="8914" Count="0" />
      <LineId Id="8916" Count="14" />
      <LineId Id="11769" Count="1" />
      <LineId Id="11780" Count="0" />
      <LineId Id="11986" Count="0" />
      <LineId Id="12160" Count="0" />
      <LineId Id="11772" Count="0" />
      <LineId Id="11776" Count="3" />
      <LineId Id="11815" Count="2" />
      <LineId Id="11823" Count="0" />
      <LineId Id="11818" Count="4" />
      <LineId Id="11775" Count="0" />
      <LineId Id="12162" Count="0" />
      <LineId Id="11795" Count="0" />
      <LineId Id="11791" Count="0" />
      <LineId Id="11788" Count="1" />
      <LineId Id="8932" Count="0" />
      <LineId Id="8934" Count="2" />
      <LineId Id="12767" Count="0" />
      <LineId Id="12163" Count="0" />
      <LineId Id="8937" Count="4" />
      <LineId Id="12164" Count="0" />
      <LineId Id="8942" Count="78" />
      <LineId Id="12768" Count="0" />
      <LineId Id="12165" Count="0" />
      <LineId Id="9021" Count="5" />
      <LineId Id="11812" Count="0" />
      <LineId Id="11814" Count="0" />
      <LineId Id="11813" Count="0" />
      <LineId Id="11811" Count="0" />
      <LineId Id="11802" Count="0" />
      <LineId Id="11801" Count="0" />
      <LineId Id="12166" Count="0" />
      <LineId Id="9027" Count="35" />
      <LineId Id="11804" Count="0" />
      <LineId Id="11803" Count="0" />
      <LineId Id="9063" Count="36" />
      <LineId Id="11806" Count="0" />
      <LineId Id="11805" Count="0" />
      <LineId Id="9100" Count="21" />
      <LineId Id="11808" Count="0" />
      <LineId Id="11807" Count="0" />
      <LineId Id="9122" Count="4" />
      <LineId Id="15051" Count="0" />
      <LineId Id="15202" Count="0" />
      <LineId Id="15048" Count="0" />
      <LineId Id="15052" Count="0" />
      <LineId Id="9127" Count="3" />
      <LineId Id="15053" Count="0" />
      <LineId Id="15203" Count="0" />
      <LineId Id="15047" Count="0" />
      <LineId Id="9131" Count="0" />
      <LineId Id="15054" Count="0" />
      <LineId Id="9132" Count="3" />
      <LineId Id="15049" Count="0" />
      <LineId Id="9136" Count="3" />
      <LineId Id="15050" Count="0" />
      <LineId Id="9140" Count="2" />
      <LineId Id="11810" Count="0" />
      <LineId Id="11809" Count="0" />
      <LineId Id="9143" Count="3" />
      <LineId Id="14696" Count="1" />
      <LineId Id="14205" Count="1" />
      <LineId Id="14333" Count="0" />
      <LineId Id="14215" Count="1" />
      <LineId Id="14227" Count="0" />
      <LineId Id="14220" Count="0" />
      <LineId Id="14222" Count="2" />
      <LineId Id="14230" Count="0" />
      <LineId Id="14221" Count="0" />
      <LineId Id="14207" Count="0" />
      <LineId Id="14226" Count="0" />
      <LineId Id="14219" Count="0" />
      <LineId Id="14334" Count="0" />
      <LineId Id="14233" Count="1" />
      <LineId Id="14331" Count="0" />
      <LineId Id="14231" Count="1" />
      <LineId Id="14225" Count="0" />
      <LineId Id="14228" Count="0" />
      <LineId Id="14218" Count="0" />
      <LineId Id="9147" Count="2" />
      <LineId Id="13685" Count="0" />
      <LineId Id="14502" Count="0" />
      <LineId Id="14504" Count="2" />
      <LineId Id="14509" Count="0" />
      <LineId Id="13684" Count="0" />
      <LineId Id="9150" Count="1" />
      <LineId Id="14517" Count="0" />
      <LineId Id="14512" Count="0" />
      <LineId Id="14511" Count="0" />
      <LineId Id="9152" Count="0" />
      <LineId Id="14528" Count="0" />
      <LineId Id="14530" Count="0" />
      <LineId Id="14529" Count="0" />
      <LineId Id="9153" Count="4" />
      <LineId Id="15003" Count="0" />
      <LineId Id="15001" Count="0" />
      <LineId Id="15004" Count="1" />
      <LineId Id="15007" Count="0" />
      <LineId Id="15006" Count="0" />
      <LineId Id="15002" Count="0" />
      <LineId Id="9158" Count="3" />
      <LineId Id="14692" Count="0" />
      <LineId Id="14992" Count="0" />
      <LineId Id="9162" Count="1" />
      <LineId Id="14994" Count="4" />
      <LineId Id="14993" Count="0" />
      <LineId Id="9164" Count="6" />
      <LineId Id="9191" Count="0" />
      <LineId Id="9194" Count="25" />
      <LineId Id="14532" Count="0" />
      <LineId Id="14535" Count="0" />
      <LineId Id="14533" Count="1" />
      <LineId Id="14514" Count="0" />
      <LineId Id="14536" Count="0" />
      <LineId Id="14539" Count="6" />
      <LineId Id="14537" Count="1" />
      <LineId Id="13687" Count="0" />
      <LineId Id="14249" Count="0" />
      <LineId Id="14251" Count="0" />
      <LineId Id="15000" Count="0" />
      <LineId Id="14250" Count="0" />
      <LineId Id="13690" Count="0" />
      <LineId Id="13692" Count="0" />
      <LineId Id="14519" Count="0" />
      <LineId Id="13686" Count="0" />
      <LineId Id="14525" Count="0" />
      <LineId Id="14527" Count="0" />
      <LineId Id="14526" Count="0" />
      <LineId Id="14332" Count="0" />
      <LineId Id="9229" Count="0" />
      <LineId Id="14315" Count="1" />
      <LineId Id="14314" Count="0" />
      <LineId Id="9230" Count="62" />
      <LineId Id="10062" Count="0" />
      <LineId Id="10073" Count="0" />
      <LineId Id="15846" Count="38" />
      <LineId Id="9300" Count="40" />
      <LineId Id="12736" Count="0" />
      <LineId Id="12731" Count="0" />
      <LineId Id="12766" Count="0" />
      <LineId Id="12733" Count="2" />
      <LineId Id="12732" Count="0" />
      <LineId Id="9341" Count="0" />
      <LineId Id="12228" Count="0" />
      <LineId Id="9346" Count="0" />
      <LineId Id="10089" Count="0" />
      <LineId Id="13219" Count="0" />
      <LineId Id="15885" Count="38" />
      <LineId Id="10090" Count="0" />
      <LineId Id="9347" Count="0" />
      <LineId Id="9356" Count="0" />
      <LineId Id="12158" Count="0" />
      <LineId Id="9358" Count="0" />
      <LineId Id="9361" Count="0" />
      <LineId Id="12232" Count="0" />
      <LineId Id="12234" Count="2" />
      <LineId Id="12171" Count="0" />
      <LineId Id="9363" Count="13" />
      <LineId Id="9386" Count="0" />
      <LineId Id="9388" Count="0" />
      <LineId Id="9390" Count="2" />
      <LineId Id="12176" Count="1" />
      <LineId Id="12758" Count="0" />
      <LineId Id="12761" Count="3" />
      <LineId Id="12760" Count="0" />
      <LineId Id="12229" Count="0" />
      <LineId Id="13231" Count="0" />
      <LineId Id="15924" Count="38" />
      <LineId Id="12178" Count="0" />
      <LineId Id="12738" Count="0" />
      <LineId Id="12196" Count="0" />
      <LineId Id="15689" Count="8" />
      <LineId Id="12238" Count="0" />
      <LineId Id="12739" Count="0" />
      <LineId Id="12574" Count="0" />
      <LineId Id="12743" Count="8" />
      <LineId Id="12742" Count="0" />
      <LineId Id="12757" Count="0" />
      <LineId Id="12752" Count="0" />
      <LineId Id="12741" Count="0" />
      <LineId Id="12753" Count="3" />
      <LineId Id="12740" Count="0" />
      <LineId Id="12437" Count="0" />
      <LineId Id="12209" Count="12" />
      <LineId Id="12223" Count="1" />
      <LineId Id="12435" Count="0" />
      <LineId Id="12225" Count="2" />
      <LineId Id="9443" Count="13" />
      <LineId Id="10125" Count="0" />
      <LineId Id="10127" Count="0" />
      <LineId Id="15963" Count="38" />
      <LineId Id="10126" Count="0" />
      <LineId Id="9457" Count="0" />
      <LineId Id="9466" Count="35" />
      <LineId Id="9552" Count="1" />
      <LineId Id="9555" Count="0" />
      <LineId Id="12924" Count="6" />
      <LineId Id="9562" Count="2" />
      <LineId Id="11623" Count="0" />
      <LineId Id="9565" Count="7" />
      <LineId Id="10856" Count="5" />
      <LineId Id="12780" Count="0" />
      <LineId Id="12270" Count="1" />
      <LineId Id="12273" Count="1" />
      <LineId Id="12789" Count="1" />
      <LineId Id="12275" Count="0" />
      <LineId Id="10862" Count="2" />
      <LineId Id="12251" Count="0" />
      <LineId Id="10865" Count="2" />
      <LineId Id="12245" Count="0" />
      <LineId Id="10869" Count="1" />
      <LineId Id="9578" Count="0" />
      <LineId Id="12253" Count="0" />
      <LineId Id="12252" Count="0" />
      <LineId Id="12254" Count="1" />
      <LineId Id="12257" Count="1" />
      <LineId Id="12265" Count="0" />
      <LineId Id="12279" Count="4" />
      <LineId Id="12278" Count="0" />
      <LineId Id="12261" Count="0" />
      <LineId Id="9580" Count="7" />
      <LineId Id="11014" Count="6" />
      <LineId Id="11180" Count="0" />
      <LineId Id="11174" Count="0" />
      <LineId Id="11325" Count="0" />
      <LineId Id="11175" Count="0" />
      <LineId Id="11329" Count="0" />
      <LineId Id="11328" Count="0" />
      <LineId Id="11021" Count="0" />
      <LineId Id="11023" Count="0" />
      <LineId Id="11473" Count="0" />
      <LineId Id="11024" Count="3" />
      <LineId Id="11475" Count="1" />
      <LineId Id="11479" Count="0" />
      <LineId Id="11474" Count="0" />
      <LineId Id="11028" Count="3" />
      <LineId Id="10323" Count="0" />
      <LineId Id="10162" Count="0" />
      <LineId Id="10164" Count="0" />
      <LineId Id="16002" Count="38" />
      <LineId Id="13381" Count="0" />
      <LineId Id="9640" Count="0" />
      <LineId Id="9649" Count="12" />
      <LineId Id="12297" Count="0" />
      <LineId Id="9662" Count="0" />
      <LineId Id="9673" Count="5" />
      <LineId Id="12291" Count="2" />
      <LineId Id="12295" Count="1" />
      <LineId Id="12290" Count="0" />
      <LineId Id="12298" Count="0" />
      <LineId Id="12721" Count="0" />
      <LineId Id="12719" Count="0" />
      <LineId Id="12722" Count="1" />
      <LineId Id="12725" Count="1" />
      <LineId Id="12728" Count="2" />
      <LineId Id="9679" Count="8" />
      <LineId Id="13546" Count="1" />
      <LineId Id="9688" Count="21" />
      <LineId Id="14320" Count="0" />
      <LineId Id="14322" Count="3" />
      <LineId Id="14327" Count="3" />
      <LineId Id="5456" Count="0" />
      <LineId Id="14253" Count="9" />
      <LineId Id="14264" Count="8" />
      <LineId Id="14263" Count="0" />
      <LineId Id="14274" Count="8" />
      <LineId Id="14273" Count="0" />
      <LineId Id="14283" Count="9" />
      <LineId Id="14294" Count="8" />
      <LineId Id="14293" Count="0" />
      <LineId Id="14304" Count="8" />
      <LineId Id="14303" Count="0" />
      <LineId Id="53" Count="0" />
    </LineIds>
  </POU>
</TcPlcObject>